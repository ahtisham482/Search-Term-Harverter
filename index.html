<!--
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  âš ï¸  PROTECTED CODE - COPYRIGHT NOTICE
  
  This application code is protected and proprietary.
  Unauthorized copying, modification, reverse engineering, or distribution
  is strictly prohibited and may result in legal action.
  
  Â© 2026 - All Rights Reserved
  
  The application itself is fully functional and can be used normally.
  Protection applies to viewing and copying source code only.
  
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-->
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Term Harvester Pro (Copy Hierarchy Added)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root {
      /* ===== DESIGN SYSTEM V2.0 ===== */

      /* Foundation Colors */
      --white: #FFFFFF;
      --slate-50: #F8FAFC;
      --slate-100: #F1F5F9;
      --slate-200: #E2E8F0;
      --slate-300: #CBD5E1;
      --slate-500: #64748B;
      --slate-600: #475569;
      --slate-700: #334155;
      --slate-900: #0F172A;

      /* Brand Colors */
      --primary: #4F46E5;
      /* Indigo 600 */
      --primary-hover: #4338CA;
      /* Indigo 700 */
      --primary-light: #EEF2FF;
      /* Indigo 50 */
      --primary-dark: #3730A3;
      /* Indigo 800 */

      /* Semantic Colors */
      --success: #059669;
      /* Green 600 */
      --success-bg: #D1FAE5;
      /* Green 100 */
      --success-light: #ECFDF5;
      /* Green 50 */

      --warning: #D97706;
      /* Amber 600 */
      --warning-bg: #FEF3C7;
      /* Amber 100 */
      --warning-light: #FFFBEB;
      /* Amber 50 */

      --error: #DC2626;
      /* Red 600 */
      --error-bg: #FEE2E2;
      /* Red 100 */
      --error-light: #FEF2F2;
      /* Red 50 */

      --info: #2563EB;
      /* Blue 600 */
      --info-bg: #DBEAFE;
      /* Blue 100 */
      --info-light: #EFF6FF;
      /* Blue 50 */

      /* UI Tokens */
      --bg-body: var(--slate-50);
      --bg-card: var(--white);
      --text-primary: var(--slate-900);
      --text-secondary: var(--slate-700);
      --text-muted: var(--slate-600);
      /* Fixed contrast: 7:1 ratio */
      --text-disabled: var(--slate-500);
      --border: var(--slate-200);
      --border-strong: var(--slate-300);

      /* Spacing Scale (8px grid) */
      --space-1: 8px;
      --space-2: 16px;
      --space-3: 24px;
      --space-4: 32px;
      --space-5: 40px;
      --space-6: 48px;

      /* Border Radius */
      --radius-sm: 6px;
      --radius-md: 8px;
      --radius-lg: 12px;
      --radius-xl: 16px;
      --radius-full: 9999px;

      /* Shadows */
      --shadow-xs: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-sm: 0 1px 3px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.07), 0 4px 6px -4px rgb(0 0 0 / 0.07);
      --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.08), 0 8px 10px -6px rgb(0 0 0 / 0.08);

      /* Typography */
      --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      --font-mono: 'ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', monospace;

      /* Font Sizes */
      --text-xs: 12px;
      --text-sm: 13px;
      --text-base: 14px;
      --text-lg: 16px;
      --text-xl: 18px;
      --text-2xl: 24px;
      --text-3xl: 32px;

      /* Line Heights */
      --leading-tight: 1.25;
      --leading-normal: 1.5;
      --leading-relaxed: 1.6;

      /* Transitions */
      --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
      --transition-base: 200ms cubic-bezier(0.4, 0, 0.2, 1);
      --transition-slow: 300ms cubic-bezier(0.4, 0, 0.2, 1);

      /* Z-Index Scale */
      --z-dropdown: 1000;
      --z-sticky: 1020;
      --z-modal-backdrop: 1040;
      --z-modal: 1050;
      --z-popover: 1060;
      --z-tooltip: 1070;
    }

    /* ===== DARK MODE THEME ===== */
    body.dark-mode {
      /* Foundation Colors - Inverted */
      --white: #1E293B;
      --slate-50: #0F172A;
      --slate-100: #1E293B;
      --slate-200: #334155;
      --slate-300: #475569;
      --slate-500: #94A3B8;
      --slate-600: #CBD5E1;
      --slate-700: #E2E8F0;
      --slate-900: #F8FAFC;

      /* Brand Colors - Adjusted for dark */
      --primary: #818CF8;
      --primary-hover: #A5B4FC;
      --primary-light: #312E81;
      --primary-dark: #C7D2FE;

      /* Semantic Colors - Adjusted for dark */
      --success: #34D399;
      --success-bg: #064E3B;
      --success-light: #022C22;

      --warning: #FBBF24;
      --warning-bg: #78350F;
      --warning-light: #451A03;

      --error: #F87171;
      --error-bg: #7F1D1D;
      --error-light: #450A0A;

      --info: #60A5FA;
      --info-bg: #1E3A5F;
      --info-light: #172554;

      /* UI Tokens - Dark */
      --bg-body: #0F172A;
      --bg-card: #1E293B;
      --text-primary: #F8FAFC;
      --text-secondary: #E2E8F0;
      --text-muted: #94A3B8;
      --text-disabled: #64748B;
      --border: #334155;
      --border-strong: #475569;

      /* Shadows - Dark mode */
      --shadow-xs: 0 1px 2px 0 rgb(0 0 0 / 0.3);
      --shadow-sm: 0 1px 3px 0 rgb(0 0 0 / 0.4);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.4), 0 2px 4px -2px rgb(0 0 0 / 0.3);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.5), 0 4px 6px -4px rgb(0 0 0 / 0.4);
      --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.5), 0 8px 10px -6px rgb(0 0 0 / 0.4);
    }

    /* Dark mode specific overrides */
    body.dark-mode .panel {
      background: var(--bg-card);
      border-color: var(--border);
    }

    body.dark-mode .form-input {
      background: var(--slate-100);
      border-color: var(--border);
      color: var(--text-primary);
    }

    body.dark-mode .btn-secondary {
      background: var(--slate-200);
      border-color: var(--border);
      color: var(--text-primary);
    }

    body.dark-mode .welcome-screen {
      background: linear-gradient(135deg, var(--primary-light) 0%, var(--bg-card) 100%);
    }

    body.dark-mode header {
      background: rgba(15, 23, 42, 0.95);
      border-color: var(--border);
    }

    body.dark-mode .sidebar {
      background: var(--bg-card);
    }

    body.dark-mode .product-card {
      background: var(--bg-card);
      border-color: var(--border);
    }

    body.dark-mode .table-wrapper {
      background: var(--bg-card);
    }

    body.dark-mode th {
      background: var(--slate-200) !important;
      color: var(--text-primary);
    }

    body.dark-mode td {
      border-color: var(--border);
    }

    body.dark-mode .modal-content,
    body.dark-mode #successModal>div,
    body.dark-mode #bulkPreviewModal>div,
    body.dark-mode #copyModal>div,
    body.dark-mode #userGuideModal>div {
      background: var(--bg-card) !important;
      color: var(--text-primary);
    }

    body.dark-mode .toast {
      background: var(--slate-200);
      color: var(--text-primary);
    }

    body.dark-mode .results-dashboard {
      background: linear-gradient(135deg, var(--primary-light) 0%, var(--bg-card) 100%);
    }

    body.dark-mode .sticky-export-bar {
      background: rgba(15, 23, 42, 0.97);
    }

    /* Dark mode toggle button styles */
    .dark-mode-toggle {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: var(--slate-100);
      border: 1px solid var(--border);
      border-radius: var(--radius-full);
      cursor: pointer;
      font-size: var(--text-xs);
      font-weight: 600;
      color: var(--text-secondary);
      transition: all var(--transition-fast);
    }

    .dark-mode-toggle:hover {
      background: var(--primary-light);
      border-color: var(--primary);
      color: var(--primary);
    }

    .dark-mode-toggle .toggle-icon {
      font-size: 14px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    *:focus-visible {
      outline: 3px solid var(--primary-light);
      outline-offset: 2px;
    }

    body {
      margin: 0;
      font-family: var(--font-sans);
      font-size: var(--text-base);
      line-height: var(--leading-normal);
      background-color: var(--bg-body);
      color: var(--text-primary);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Typography Scale */
    h1,
    h2,
    h3,
    h4,
    h5,
    h6 {
      margin: 0;
      font-weight: 600;
      line-height: var(--leading-tight);
      color: var(--text-primary);
    }

    h1 {
      font-size: var(--text-2xl);
      letter-spacing: -0.02em;
    }

    h2 {
      font-size: var(--text-xl);
      letter-spacing: -0.01em;
    }

    h3 {
      font-size: var(--text-lg);
    }

    p {
      margin: 0;
      line-height: var(--leading-normal);
    }

    /* --- Layout --- */
    .app-container {
      display: grid;
      grid-template-columns: 380px 1fr;
      gap: var(--space-3);
      max-width: 1600px;
      margin: 0 auto;
      padding: var(--space-3);
      padding-top: 100px;
      min-height: 100vh;
    }

    @media (max-width: 1279px) {
      .app-container {
        grid-template-columns: 340px 1fr;
      }
    }

    @media (max-width: 1023px) {
      .app-container {
        grid-template-columns: 1fr;
        padding-top: 140px;
      }

      .sidebar {
        position: relative !important;
        top: 0 !important;
        height: auto !important;
      }
    }

    /* --- Header --- */
    header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: var(--z-sticky);
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
      box-shadow: var(--shadow-sm);
    }

    .header-content {
      max-width: 1600px;
      margin: 0 auto;
      padding: var(--space-2) var(--space-3);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: var(--space-3);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .brand-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--primary), #818cf8);
      border-radius: var(--radius-md);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: var(--text-xl);
      box-shadow: var(--shadow-md);
      flex-shrink: 0;
    }

    .brand-text h1 {
      margin: 0;
      font-size: var(--text-xl);
      font-weight: 700;
      color: var(--text-primary);
      letter-spacing: -0.025em;
    }

    .brand-text p {
      margin: 0;
      font-size: var(--text-xs);
      color: var(--text-muted);
      margin-top: 2px;
    }

    .header-center {
      flex: 1;
      display: flex;
      justify-content: center;
      max-width: 500px;
    }

    .controls {
      display: flex;
      gap: var(--space-2);
      align-items: center;
      flex-wrap: wrap;
    }

    @media (max-width: 1023px) {
      .header-content {
        flex-wrap: wrap;
      }

      .header-center {
        order: 3;
        width: 100%;
        max-width: none;
        margin-top: var(--space-2);
      }
    }

    /* --- Search Bar --- */
    .search-wrapper {
      position: relative;
      width: 300px;
    }

    .search-wrapper svg {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      pointer-events: none;
    }

    .search-input {
      width: 100%;
      padding: 10px 12px 10px 36px;
      border: 1px solid var(--border);
      border-radius: 99px;
      font-size: 13px;
      transition: all 0.2s;
      background: var(--bg-body);
    }

    .search-input:focus {
      border-color: var(--primary);
      background: #fff;
      box-shadow: 0 0 0 3px var(--primary-light);
    }

    /* --- Buttons --- */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
      justify-content: center;
      padding: 12px var(--space-3);
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
      font-weight: 500;
      line-height: 1;
      cursor: pointer;
      transition: all var(--transition-fast);
      border: none;
      white-space: nowrap;
      text-decoration: none;
      user-select: none;
      min-height: 40px;
    }

    .btn:active:not(:disabled) {
      transform: translateY(1px);
    }

    /* Primary Button */
    .btn-primary {
      background: var(--primary);
      color: white;
      box-shadow: var(--shadow-sm), 0 0 0 0 rgba(79, 70, 229, 0);
    }

    .btn-primary:hover:not(:disabled) {
      background: var(--primary-hover);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md), 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    .btn-primary:focus-visible {
      outline: 3px solid var(--primary-light);
      outline-offset: 2px;
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* Secondary Button */
    .btn-secondary {
      background: var(--white);
      border: 1px solid var(--border-strong);
      color: var(--text-secondary);
    }

    .btn-secondary:hover:not(:disabled) {
      background: var(--slate-50);
      border-color: var(--slate-500);
      color: var(--text-primary);
    }

    /* Tertiary Button */
    .btn-tertiary {
      background: transparent;
      color: var(--primary);
      border: 1px solid transparent;
    }

    .btn-tertiary:hover:not(:disabled) {
      background: var(--primary-light);
    }

    /* Success Button */
    .btn-success {
      background: var(--success);
      color: white;
      box-shadow: var(--shadow-sm);
    }

    .btn-success:hover:not(:disabled) {
      background: #047857;
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    /* CTA Button (Large) */
    .btn-cta {
      width: 100%;
      font-size: var(--text-base);
      padding: var(--space-2) var(--space-3);
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      min-height: 48px;
      font-weight: 600;
      box-shadow: var(--shadow-md);
    }

    .btn-cta:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    /* Small Copy Button */
    .btn-copy-small {
      padding: 6px 12px;
      font-size: var(--text-xs);
      background: var(--slate-100);
      color: var(--text-muted);
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      cursor: pointer;
      transition: all var(--transition-fast);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      min-height: 32px;
      font-weight: 500;
    }

    .btn-copy-small:hover {
      background: var(--slate-200);
      color: var(--text-primary);
      border-color: var(--border-strong);
      transform: translateY(-1px);
      box-shadow: var(--shadow-xs);
    }

    .btn-copy-small svg {
      width: 14px;
      height: 14px;
    }

    /* Icon Button */
    .btn-icon {
      padding: var(--space-1);
      min-width: 40px;
      min-height: 40px;
      border-radius: var(--radius-md);
    }

    /* Button Sizes */
    .btn-sm {
      padding: var(--space-1) var(--space-2);
      font-size: var(--text-xs);
      min-height: 32px;
    }

    .btn-lg {
      padding: var(--space-2) var(--space-4);
      font-size: var(--text-base);
      min-height: 48px;
    }

    /* --- Sidebar --- */
    .sidebar {
      position: sticky;
      top: 120px;
      height: calc(100vh - 140px);
      overflow-y: auto;
      overflow-x: hidden;
      padding-right: 8px;
      scrollbar-width: thin;
      scrollbar-color: var(--slate-300) transparent;
    }

    .sidebar::-webkit-scrollbar {
      width: 6px;
    }

    .sidebar::-webkit-scrollbar-track {
      background: transparent;
    }

    .sidebar::-webkit-scrollbar-thumb {
      background: var(--slate-300);
      border-radius: var(--radius-full);
    }

    .sidebar::-webkit-scrollbar-thumb:hover {
      background: var(--slate-500);
    }

    /* Panel/Card */
    .panel {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      padding: var(--space-3);
      box-shadow: var(--shadow-sm);
      margin-bottom: var(--space-3);
      transition: box-shadow var(--transition-fast);
    }

    .panel:hover {
      box-shadow: var(--shadow-md);
    }

    .panel-title {
      font-size: var(--text-base);
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: var(--space-2);
      display: flex;
      align-items: center;
      gap: var(--space-1);
      line-height: var(--leading-tight);
    }

    .panel-title svg {
      color: var(--primary);
      flex-shrink: 0;
      width: 18px;
      height: 18px;
    }

    .panel-description {
      font-size: var(--text-sm);
      color: var(--text-muted);
      margin-bottom: var(--space-2);
      line-height: var(--leading-normal);
    }

    /* Collapsible Panel */
    .panel.collapsible {
      cursor: pointer;
      user-select: none;
    }

    .panel.collapsible .panel-title {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .panel.collapsible .panel-title::after {
      content: '▼';
      font-size: 12px;
      color: var(--text-muted);
      transition: transform var(--transition-fast);
    }

    .panel.collapsible.collapsed .panel-title::after {
      transform: rotate(-90deg);
    }

    .panel-content {
      transition: all var(--transition-base);
      overflow: hidden;
    }

    .panel.collapsed .panel-content {
      max-height: 0 !important;
      opacity: 0;
      margin: 0;
      padding: 0;
    }

    .panel.completed {
      border-color: var(--success);
      background: var(--success-light);
    }

    .panel.completed .panel-title {
      color: var(--success);
    }

    .panel.completed .panel-title::before {
      content: '✓ ';
      color: var(--success);
      font-weight: 700;
      margin-right: 4px;
    }

    /* --- Drop Zone --- */
    .drop-zone {
      position: relative;
      border: 2px dashed var(--border);
      border-radius: var(--radius-md);
      padding: 30px 20px;
      text-align: center;
      transition: all 0.2s;
      cursor: pointer;
      background: var(--bg-body);
      margin-bottom: 10px;
    }

    .drop-zone:hover,
    .drop-zone.dragover {
      border-color: var(--primary);
      background: var(--primary-light);
    }

    .drop-zone input[type="file"] {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      cursor: pointer;
    }

    .drop-zone-text {
      font-size: 13px;
      color: var(--text-muted);
      margin-top: 8px;
    }

    .drop-zone-icon {
      color: var(--text-muted);
      width: 32px;
      height: 32px;
      margin: 0 auto;
    }

    input[type="file"] {
      display: none;
    }

    div[id^="fileNameDisplay"] {
      margin-top: 10px;
      font-size: 12px;
      font-weight: 600;
      color: var(--primary);
      display: none;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    /* --- Form Elements --- */
    .form-group {
      margin-bottom: var(--space-2);
    }

    .form-label {
      display: block;
      font-size: var(--text-sm);
      font-weight: 500;
      margin-bottom: var(--space-1);
      color: var(--text-secondary);
      line-height: var(--leading-tight);
    }

    .form-label.required::after {
      content: ' *';
      color: var(--error);
    }

    .form-input,
    input[type="text"],
    input[type="number"],
    input[type="email"],
    input[type="password"],
    select,
    textarea {
      width: 100%;
      padding: 12px var(--space-2);
      border: 1px solid var(--border-strong);
      border-radius: var(--radius-md);
      font-size: var(--text-base);
      font-family: var(--font-sans);
      line-height: 1.5;
      color: var(--text-primary);
      background: var(--white);
      transition: all var(--transition-fast);
      margin-bottom: 0;
      min-height: 40px;
    }

    .form-input:hover:not(:disabled),
    input:hover:not(:disabled),
    select:hover:not(:disabled) {
      border-color: var(--slate-500);
    }

    .form-input:focus,
    input:focus,
    select:focus,
    textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--primary-light);
      outline: none;
    }

    .form-input:disabled,
    input:disabled,
    select:disabled {
      background: var(--slate-50);
      color: var(--text-disabled);
      cursor: not-allowed;
      opacity: 0.6;
    }

    /* Input States */
    .form-input.error,
    input.error {
      border-color: var(--error);
      background: var(--error-light);
    }

    .form-input.error:focus,
    input.error:focus {
      box-shadow: 0 0 0 3px var(--error-bg);
    }

    .form-input.success,
    input.success {
      border-color: var(--success);
      background: var(--success-light);
    }

    .form-input.success:focus,
    input.success:focus {
      box-shadow: 0 0 0 3px var(--success-bg);
    }

    /* Input Icons */
    .input-wrapper {
      position: relative;
      display: flex;
      align-items: center;
    }

    .input-icon {
      position: absolute;
      right: 12px;
      width: 16px;
      height: 16px;
      pointer-events: none;
    }

    .input-icon.error {
      color: var(--error);
    }

    .input-icon.success {
      color: var(--success);
    }

    .form-input:has(+ .input-icon),
    input:has(+ .input-icon) {
      padding-right: 40px;
    }

    /* Helper Text */
    .form-help {
      font-size: var(--text-xs);
      color: var(--text-muted);
      margin-top: 6px;
      line-height: 1.4;
    }

    .form-error {
      font-size: var(--text-xs);
      color: var(--error);
      margin-top: 6px;
      display: flex;
      align-items: center;
      gap: 4px;
      font-weight: 500;
    }

    .form-success {
      font-size: var(--text-xs);
      color: var(--success);
      margin-top: 6px;
      display: flex;
      align-items: center;
      gap: 4px;
      font-weight: 500;
    }

    /* Select Dropdown */
    select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg width='12' height='12' viewBox='0 0 12 12' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M2.5 4.5L6 8L9.5 4.5' stroke='%23475569' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 40px;
    }

    /* Checkbox & Radio */
    input[type="checkbox"],
    input[type="radio"] {
      width: 16px;
      height: 16px;
      border: 2px solid var(--border-strong);
      margin: 0;
      cursor: pointer;
      accent-color: var(--primary);
    }

    /* Utilities */
    .muted {
      color: var(--text-muted);
      font-size: var(--text-xs);
    }

    .hr {
      height: 1px;
      background: var(--border);
      border: none;
      margin: var(--space-3) 0;
    }

    .h2 {
      font-size: var(--text-base);
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: var(--space-2);
    }

    /* Toggle Switches */
    .toggle-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid #f1f5f9;
    }

    .toggle-row:last-child {
      border-bottom: none;
    }

    .toggle-label {
      font-size: 13px;
      font-weight: 500;
      display: flex;
      align-items: center;
    }

    .kpi-check {
      width: 16px;
      height: 16px;
      cursor: pointer;
      accent-color: var(--primary);
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 40px;
      height: 22px;
      flex-shrink: 0;
    }

    /* Copy Modal Styles */
    .copy-target-item label:hover {
      background: #f8fafc;
    }

    .copy-target-check {
      width: 14px;
      height: 14px;
      cursor: pointer;
      accent-color: var(--primary);
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #cbd5e1;
      transition: .4s;
      border-radius: 34px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    input:checked+.slider {
      background-color: var(--primary);
    }

    input:checked+.slider:before {
      transform: translateX(18px);
    }

    /* --- Nav & Results --- */
    .product-nav {
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-height: 400px;
      overflow-y: auto;
    }

    .nav-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 500;
      color: var(--text-main);
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid transparent;
    }

    .nav-item:hover {
      background: var(--bg-body);
      border-color: var(--border);
    }

    .nav-item-name {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 140px;
    }

    .nav-badges {
      display: flex;
      gap: 4px;
    }

    /* --- Badges & Pills --- */
    .badge,
    .status-pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: var(--text-xs);
      font-weight: 600;
      padding: 4px 10px;
      border-radius: var(--radius-full);
      line-height: 1;
      white-space: nowrap;
    }

    /* Filled Badges */
    .badge-primary,
    .status-pill.primary {
      background: var(--primary);
      color: white;
    }

    .badge-success,
    .status-success {
      background: var(--success);
      color: white;
    }

    .badge-warning,
    .status-warning {
      background: var(--warning);
      color: white;
    }

    .badge-error,
    .status-excluded {
      background: var(--error);
      color: white;
    }

    .badge-info {
      background: var(--info);
      color: white;
    }

    /* Outlined Badges */
    .badge-outline {
      background: transparent;
      border: 1.5px solid currentColor;
    }

    .badge-outline.primary {
      color: var(--primary);
    }

    .badge-outline.success {
      color: var(--success);
    }

    .badge-outline.error {
      color: var(--error);
    }

    /* Soft Badges (Subtle Background) */
    .badge-soft {
      font-weight: 500;
    }

    .badge-soft.primary {
      background: var(--primary-light);
      color: var(--primary-dark);
    }

    .badge-soft.success {
      background: var(--success-bg);
      color: var(--success);
    }

    .badge-soft.warning {
      background: var(--warning-bg);
      color: var(--warning);
    }

    .badge-soft.error {
      background: var(--error-bg);
      color: var(--error);
    }

    .badge-soft.info {
      background: var(--info-bg);
      color: var(--info);
    }

    .badge-soft.neutral {
      background: var(--slate-100);
      color: var(--slate-700);
    }

    .results-area {
      animation: fadeIn 0.5s ease-out;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }

    .empty-state svg {
      width: 48px;
      height: 48px;
      margin-bottom: 16px;
      color: #cbd5e1;
    }

    /* --- Card & Table --- */
    .prod-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      margin-bottom: 24px;
      box-shadow: var(--shadow-md);
      overflow: hidden;
      transition: transform 0.2s;
    }

    summary {
      list-style: none;
      outline: none;
    }

    summary::-webkit-details-marker {
      display: none;
    }

    .prod-header {
      padding: 18px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: white;
      cursor: pointer;
      border-bottom: 1px solid transparent;
      transition: background 0.2s;
    }

    .prod-card[open] .prod-header {
      border-bottom-color: var(--border);
      background: #f8fafc;
    }

    .prod-header:hover {
      background: #f8fafc;
    }

    .prod-title {
      font-size: 15px;
      font-weight: 700;
      color: var(--text-main);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .prod-title::before {
      content: "►";
      font-size: 10px;
      color: var(--text-muted);
      transition: transform 0.2s;
    }

    details[open] .prod-title::before {
      transform: rotate(90deg);
    }

    .prod-meta {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .meta-tag {
      font-size: 11px;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 6px;
      background: var(--bg-body);
      border: 1px solid var(--border);
      color: var(--text-muted);
    }

    .bucket-section {
      padding: 24px;
    }

    .bucket-wrapper {
      margin-bottom: 4px;
    }

    .matchHeader {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 14px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: #ffffff;
      cursor: pointer;
      font-weight: 800;
      font-size: 12px;
      transition: all 0.15s ease;
      margin-bottom: 8px;
    }

    .matchHeader:hover {
      background: #f9fafb;
      border-color: #cbd5e1;
    }

    .matchHeaderLeft {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .matchChevron {
      font-size: 10px;
      width: 16px;
      text-align: center;
      color: var(--text-muted);
      transition: transform 0.2s;
    }

    .matchMeta {
      color: var(--text-muted);
      font-weight: 600;
      margin-left: 4px;
    }

    /* --- Tables --- */
    .table-container {
      overflow-x: auto;
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      margin: var(--space-2) 0;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: var(--text-sm);
    }

    thead {
      background: var(--slate-50);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    th {
      text-align: left;
      padding: var(--space-2);
      background: var(--slate-50);
      border-bottom: 2px solid var(--border-strong);
      font-size: var(--text-xs);
      font-weight: 600;
      text-transform: uppercase;
      color: var(--text-muted);
      white-space: nowrap;
      letter-spacing: 0.025em;
    }

    tbody tr {
      transition: background var(--transition-fast);
    }

    tbody tr:nth-child(even) {
      background: rgba(248, 250, 252, 0.5);
    }

    tbody tr:hover:not(.detail-row) {
      background: var(--slate-100);
      cursor: pointer;
    }

    tbody tr:hover:not(.detail-row) td:first-child {
      border-left: 3px solid var(--primary);
    }

    td {
      padding: var(--space-2);
      border-bottom: 1px solid var(--border);
      vertical-align: middle;
      color: var(--text-primary);
    }

    tr:last-child td {
      border-bottom: none;
    }

    .cell-main {
      font-weight: 600;
      color: var(--primary);
    }

    .detail-row {
      background: var(--slate-50) !important;
    }

    .detail-row td {
      background: var(--slate-50);
      padding: var(--space-3);
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.03);
    }

    .detail-row:hover {
      background: var(--slate-50) !important;
    }

    /* Tabular Numbers for Metrics */
    td[data-type="number"],
    .tabular-nums {
      font-variant-numeric: tabular-nums;
      text-align: right;
    }

    /* Copy Icon in Table */
    .icon-copy-row {
      cursor: pointer;
      color: var(--text-muted);
      transition: color 0.2s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 24px;
      height: 24px;
      border-radius: 4px;
    }

    .icon-copy-row:hover {
      color: var(--primary);
      background: #eef2ff;
    }

    /* --- Mini Card & KPIs --- */
    .mini-card {
      background: white;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      max-width: 900px;
    }

    .mini-header {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
      align-items: center;
    }

    .mini-badge {
      font-size: 10px;
      font-weight: 700;
      padding: 4px 10px;
      border-radius: 99px;
      background: var(--primary-light);
      color: var(--primary);
      border: 1px solid #c7d2fe;
    }

    .mini-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
    }

    @media (max-width: 768px) {
      .mini-grid {
        grid-template-columns: 1fr;
        gap: 16px;
      }
    }

    .mini-section {
      background: #fdfdfd;
      border: 1px solid #f1f5f9;
      border-radius: 8px;
      padding: 12px;
    }

    .mini-label {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .mini-value {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-main);
      word-break: break-all;
    }

    .mini-mono {
      font-family: var(--font-mono);
      font-size: 11px;
      background: white;
      padding: 6px 8px;
      border: 1px solid var(--border);
      border-radius: 6px;
      margin-top: 4px;
      display: block;
    }

    .kpiGrid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    @media (max-width: 900px) {
      .kpiGrid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    .kpiBox {
      border: 1px solid #eef2f7;
      background: #fff;
      border-radius: 12px;
      padding: 10px 10px;
    }

    .kpiName {
      font-size: 11px;
      color: var(--text-muted);
      font-weight: 700;
      margin-bottom: 6px;
    }

    .kpiVal {
      font-size: 13px;
      font-weight: 800;
      color: var(--text-main);
    }

    .detailDivider {
      height: 1px;
      background: #e5e7eb;
      margin: 16px 0;
    }

    /* --- Animations --- */
    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
        transform: scale(1);
      }

      50% {
        opacity: 0.9;
        transform: scale(1.02);
      }
    }

    @keyframes spin {
      from {
        transform: rotate(0deg);
      }

      to {
        transform: rotate(360deg);
      }
    }

    @keyframes bounce {

      0%,
      100% {
        transform: translateY(0);
      }

      50% {
        transform: translateY(-10px);
      }
    }

    @keyframes shimmer {
      0% {
        background-position: -1000px 0;
      }

      100% {
        background-position: 1000px 0;
      }
    }

    /* Animation Classes */
    .animate-fadeIn {
      animation: fadeIn var(--transition-base);
    }

    .animate-slideUp {
      animation: slideUp var(--transition-base);
    }

    .animate-pulse {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

    .animate-spin {
      animation: spin 1s linear infinite;
    }

    /* --- Utilities --- */
    .hidden {
      display: none !important;
    }

    .invisible {
      visibility: hidden !important;
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border-width: 0;
    }

    /* Text Colors */
    .text-primary {
      color: var(--text-primary);
    }

    .text-secondary {
      color: var(--text-secondary);
    }

    .text-muted {
      color: var(--text-muted);
    }

    .text-success {
      color: var(--success);
    }

    .text-warning {
      color: var(--warning);
    }

    .text-error {
      color: var(--error);
    }

    .text-info {
      color: var(--info);
    }

    /* Legacy color support */
    .text-green {
      color: var(--success);
    }

    .text-red {
      color: var(--error);
    }

    /* Background Colors */
    .bg-success-light {
      background: var(--success-light);
    }

    .bg-warning-light {
      background: var(--warning-light);
    }

    .bg-error-light {
      background: var(--error-light);
    }

    .bg-info-light {
      background: var(--info-light);
    }

    /* Legacy background support */
    .bg-green-light {
      background: var(--success-light);
    }

    .bg-red-light {
      background: var(--error-light);
    }

    /* Spacing Utilities */
    .mb-1 {
      margin-bottom: var(--space-1);
    }

    .mb-2 {
      margin-bottom: var(--space-2);
    }

    .mb-3 {
      margin-bottom: var(--space-3);
    }

    .mb-4 {
      margin-bottom: var(--space-4);
    }

    .mt-1 {
      margin-top: var(--space-1);
    }

    .mt-2 {
      margin-top: var(--space-2);
    }

    .mt-3 {
      margin-top: var(--space-3);
    }

    .mt-4 {
      margin-top: var(--space-4);
    }

    .p-0 {
      padding: 0;
    }

    .p-1 {
      padding: var(--space-1);
    }

    .p-2 {
      padding: var(--space-2);
    }

    .p-3 {
      padding: var(--space-3);
    }

    /* Display */
    .flex {
      display: flex;
    }

    .inline-flex {
      display: inline-flex;
    }

    .grid {
      display: grid;
    }

    .block {
      display: block;
    }

    .inline-block {
      display: inline-block;
    }

    /* Flex Utilities */
    .flex-col {
      flex-direction: column;
    }

    .items-center {
      align-items: center;
    }

    .justify-center {
      justify-content: center;
    }

    .justify-between {
      justify-content: space-between;
    }

    .gap-1 {
      gap: var(--space-1);
    }

    .gap-2 {
      gap: var(--space-2);
    }

    .gap-3 {
      gap: var(--space-3);
    }

    /* Text Utilities */
    .font-medium {
      font-weight: 500;
    }

    .font-semibold {
      font-weight: 600;
    }

    .font-bold {
      font-weight: 700;
    }

    .text-center {
      text-align: center;
    }

    .text-right {
      text-align: right;
    }

    .truncate {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* Scrollbar Styles */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--slate-300);
      border-radius: var(--radius-sm);
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--slate-500);
    }

    /* Loading Skeleton */
    .skeleton {
      background: linear-gradient(90deg,
          var(--slate-100) 0%,
          var(--slate-200) 50%,
          var(--slate-100) 100%);
      background-size: 1000px 100%;
      animation: shimmer 2s infinite;
      border-radius: var(--radius-md);
    }

    /* --- Step Progress Indicator --- */
    .step-progress {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-1) 0;
    }

    .step-item {
      display: flex;
      align-items: center;
      gap: var(--space-1);
      font-size: var(--text-sm);
      color: var(--text-muted);
      font-weight: 500;
      transition: color var(--transition-fast);
    }

    .step-number {
      width: 28px;
      height: 28px;
      border-radius: var(--radius-full);
      background: var(--slate-200);
      color: var(--text-muted);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--text-sm);
      font-weight: 600;
      transition: all var(--transition-fast);
    }

    .step-item.active {
      color: var(--primary);
    }

    .step-item.active .step-number {
      background: var(--primary);
      color: white;
      box-shadow: 0 0 0 4px var(--primary-light);
    }

    .step-item.completed {
      color: var(--success);
    }

    .step-item.completed .step-number {
      background: var(--success);
      color: white;
    }

    .step-item.completed .step-number::before {
      content: '✓';
      font-size: 14px;
    }

    .step-separator {
      width: 32px;
      height: 2px;
      background: var(--slate-200);
      transition: background var(--transition-fast);
    }

    .step-item.completed+.step-separator {
      background: var(--success);
    }

    @media (max-width: 768px) {
      .step-text {
        display: none;
      }

      .step-separator {
        width: 20px;
      }
    }

    /* --- Help Tooltip --- */
    .help-wrap {
      display: inline-flex;
      align-items: center;
      margin-left: 6px;
    }

    .help-icon {
      width: 18px;
      height: 18px;
      border-radius: var(--radius-full);
      background: var(--primary-light);
      color: var(--primary);
      font-size: var(--text-xs);
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border: 1px solid var(--primary);
      transition: all var(--transition-fast);
    }

    .help-icon:hover {
      background: var(--primary);
      color: white;
      transform: scale(1.1);
    }

    .help-tooltip {
      display: none !important;
    }

    #helpPopover {
      position: fixed;
      left: 0;
      top: 0;
      max-width: 340px;
      min-width: 240px;
      background: var(--slate-900);
      color: white;
      font-size: var(--text-xs);
      line-height: 1.5;
      padding: var(--space-2);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-xl);
      z-index: var(--z-tooltip);
      display: none;
    }

    #helpPopover strong {
      color: #a5b4fc;
      font-weight: 600;
    }

    #helpPopover .arrow {
      position: absolute;
      width: 10px;
      height: 10px;
      background: var(--slate-900);
      transform: rotate(45deg);
      left: 14px;
      top: -5px;
    }

    /* --- Workflow Mode Selection --- */
    .workflow-selector {
      background: var(--white);
      border: 1px solid var(--border);
      border-radius: var(--radius-xl);
      padding: var(--space-3);
      margin-bottom: var(--space-3);
      box-shadow: var(--shadow-sm);
    }

    .workflow-title {
      font-size: var(--text-base);
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: var(--space-2);
      display: flex;
      align-items: center;
      gap: var(--space-1);
    }

    .workflow-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--space-2);
    }

    .workflow-card {
      background: var(--white);
      border: 2px solid var(--border);
      border-radius: var(--radius-lg);
      padding: var(--space-2);
      cursor: pointer;
      transition: all var(--transition-fast);
      position: relative;
    }

    .workflow-card:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .workflow-card.active {
      border-color: var(--primary);
      background: var(--primary-light);
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    .workflow-card.active::before {
      content: '✓';
      position: absolute;
      top: 8px;
      right: 8px;
      width: 20px;
      height: 20px;
      background: var(--primary);
      color: white;
      border-radius: var(--radius-full);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 700;
    }

    .workflow-icon {
      width: 32px;
      height: 32px;
      margin-bottom: var(--space-1);
      color: var(--primary);
    }

    .workflow-card.active .workflow-icon {
      color: var(--primary-dark);
    }

    .workflow-name {
      font-size: var(--text-sm);
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .workflow-desc {
      font-size: var(--text-xs);
      color: var(--text-muted);
      line-height: 1.4;
    }

    .workflow-badge {
      display: inline-block;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: var(--radius-sm);
      background: var(--primary-light);
      color: var(--primary);
      font-weight: 600;
      margin-top: 4px;
    }

    /* --- Welcome Screen / Hero Section --- */
    .welcome-screen {
      background: linear-gradient(135deg, var(--primary-light) 0%, white 100%);
      border-radius: var(--radius-xl);
      padding: var(--space-6);
      text-align: center;
      margin-bottom: var(--space-4);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-md);
      animation: slideUp var(--transition-slow);
    }

    .welcome-icon {
      width: 80px;
      height: 80px;
      margin: 0 auto var(--space-3);
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      border-radius: var(--radius-xl);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      box-shadow: var(--shadow-lg), 0 0 0 8px var(--primary-light);
    }

    .welcome-icon svg {
      width: 40px;
      height: 40px;
    }

    .welcome-title {
      font-size: var(--text-3xl);
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: var(--space-2);
      letter-spacing: -0.02em;
    }

    .welcome-description {
      font-size: var(--text-lg);
      color: var(--text-secondary);
      margin-bottom: var(--space-4);
      line-height: var(--leading-relaxed);
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }

    .welcome-steps {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--space-3);
      margin: var(--space-4) 0;
      max-width: 900px;
      margin-left: auto;
      margin-right: auto;
    }

    .welcome-step-card {
      background: white;
      padding: var(--space-3);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      transition: all var(--transition-fast);
    }

    .welcome-step-card:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-md);
      border-color: var(--primary);
    }

    .welcome-step-number {
      width: 40px;
      height: 40px;
      background: var(--primary-light);
      color: var(--primary);
      border-radius: var(--radius-full);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: var(--text-lg);
      margin: 0 auto var(--space-2);
    }

    .welcome-step-title {
      font-size: var(--text-base);
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: var(--space-1);
    }

    .welcome-step-desc {
      font-size: var(--text-sm);
      color: var(--text-muted);
      line-height: var(--leading-normal);
    }

    .welcome-actions {
      display: flex;
      gap: var(--space-2);
      justify-content: center;
      flex-wrap: wrap;
    }

    @media (max-width: 768px) {
      .welcome-screen {
        padding: var(--space-4);
      }

      .welcome-title {
        font-size: var(--text-2xl);
      }

      .welcome-steps {
        grid-template-columns: 1fr;
      }
    }

    /* --- Bulk Export Workspace (Step 2) --- */
    #bulkStepPanel {
      box-shadow: var(--shadow-md);
      margin-top: var(--space-3);
      border-top: 4px solid var(--primary);
    }

    #bulkStepPanel .panel-title {
      font-size: var(--text-base);
    }

    .bulk-workspace {
      display: grid;
      grid-template-columns: 1fr;
      gap: 14px;
    }

    @media (min-width: 1100px) {
      .bulk-two-col {
        display: grid;
        grid-template-columns: 360px 1fr;
        gap: 14px;
        align-items: start;
      }
    }

    .bulk-stickybar {
      position: sticky;
      bottom: 0;
      background: rgba(255, 255, 255, .92);
      backdrop-filter: blur(10px);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      box-shadow: var(--shadow-md);
      margin-top: 14px;
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      z-index: 40;
    }

    .bulk-stickybar .left {
      font-size: 12px;
      color: var(--text-muted);
      font-weight: 600;
    }

    .bulk-stickybar .right {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    /* --- Enhanced Bulk Inputs (New styles) --- */
    .bulk-section-card {
      border: 1px solid var(--border);
      background: #fff;
      border-radius: 14px;
      padding: 16px;
      box-shadow: var(--shadow-sm);
      margin-bottom: 16px;
    }

    .bulk-section-header {
      font-size: 13px;
      font-weight: 900;
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .sp-theme {
      border-left: 4px solid #f59e0b;
    }

    .sb-theme {
      border-left: 4px solid #8b5cf6;
    }

    .sp-header {
      color: #b45309;
    }

    .sb-header {
      color: #6d28d9;
    }

    .bulk-inline-3 {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
    }

    @media (max-width: 700px) {
      .bulk-inline-3 {
        grid-template-columns: 1fr;
      }
    }

    .bulk-help {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 6px;
      line-height: 1.4;
    }


    /* --- Suggestions Export + Copy Bar --- */
    .suggestions-bar {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      background: white;
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px 14px;
      box-shadow: var(--shadow-sm);
      margin: 0 0 14px 0;
    }

    .suggestions-bar .left {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .suggestions-bar .title {
      font-size: 13px;
      font-weight: 800;
    }

    .suggestions-bar .sub {
      font-size: 11px;
      color: var(--text-muted);
    }

    .suggestions-bar .right {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .toast {
      position: fixed;
      bottom: 22px;
      left: 50%;
      transform: translateX(-50%);
      background: #0f172a;
      color: #fff;
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      box-shadow: var(--shadow-lg);
      z-index: 2147483646;
      display: none;
    }

    /* ========================================
       UX/UI IMPROVEMENTS - Phase 1 & 2
       ======================================== */

    /* --- Skeleton Loading States --- */
    .skeleton-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: var(--space-3);
      margin-bottom: var(--space-3);
    }

    .skeleton-row {
      height: 48px;
      background: linear-gradient(90deg,
          var(--slate-100) 0%,
          var(--slate-200) 25%,
          var(--slate-100) 50%,
          var(--slate-200) 75%,
          var(--slate-100) 100%);
      background-size: 400% 100%;
      animation: skeletonWave 1.5s ease-in-out infinite;
      border-radius: var(--radius-md);
      margin-bottom: var(--space-1);
    }

    .skeleton-header {
      height: 24px;
      width: 60%;
      margin-bottom: var(--space-2);
    }

    .skeleton-text {
      height: 16px;
      width: 80%;
    }

    .skeleton-text-short {
      height: 16px;
      width: 40%;
    }

    @keyframes skeletonWave {
      0% {
        background-position: 100% 50%;
      }

      100% {
        background-position: -100% 50%;
      }
    }

    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 100;
      border-radius: var(--radius-lg);
    }

    .loading-spinner {
      width: 48px;
      height: 48px;
      border: 4px solid var(--slate-200);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .loading-text {
      margin-top: var(--space-2);
      font-size: var(--text-sm);
      font-weight: 600;
      color: var(--text-primary);
    }

    /* --- Confetti Animation --- */
    @keyframes confettiDrop {
      0% {
        transform: translateY(-100vh) rotate(0deg);
        opacity: 1;
      }

      100% {
        transform: translateY(100vh) rotate(720deg);
        opacity: 0;
      }
    }

    .confetti-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      overflow: hidden;
      z-index: 2147483647;
    }

    .confetti {
      position: absolute;
      width: 10px;
      height: 10px;
      animation: confettiDrop 3s ease-out forwards;
    }

    /* --- Collapsible Panel Improvements --- */
    .panel.collapsible-section {
      cursor: default;
    }

    .panel.collapsible-section .panel-header {
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-2) 0;
      margin: calc(-1 * var(--space-2)) 0;
      margin-bottom: var(--space-2);
      border-radius: var(--radius-md);
      transition: background var(--transition-fast);
    }

    .panel.collapsible-section .panel-header:hover {
      background: var(--slate-50);
      margin-left: calc(-1 * var(--space-2));
      margin-right: calc(-1 * var(--space-2));
      padding-left: var(--space-2);
      padding-right: var(--space-2);
    }

    .panel-chevron {
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: var(--text-muted);
      transition: transform var(--transition-fast);
    }

    .panel.collapsed-section .panel-chevron {
      transform: rotate(-90deg);
    }

    .panel-collapse-content {
      overflow: hidden;
      transition: max-height 0.3s ease-out, opacity 0.2s ease-out;
      max-height: 1000px;
      opacity: 1;
    }

    .panel.collapsed-section .panel-collapse-content {
      max-height: 0;
      opacity: 0;
      margin: 0;
      padding: 0;
    }

    /* --- Results Dashboard Summary --- */
    .results-dashboard {
      background: linear-gradient(135deg, var(--primary-light) 0%, white 100%);
      border: 2px solid var(--primary);
      border-radius: var(--radius-xl);
      padding: var(--space-3);
      margin-bottom: var(--space-3);
      animation: slideUp 0.4s ease-out;
    }

    .results-dashboard-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--space-2);
    }

    .results-dashboard-title {
      font-size: var(--text-lg);
      font-weight: 700;
      color: var(--primary-dark);
      display: flex;
      align-items: center;
      gap: var(--space-1);
    }

    .results-dashboard-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: var(--space-2);
    }

    @media (max-width: 768px) {
      .results-dashboard-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    .dashboard-stat {
      background: white;
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: var(--space-2);
      text-align: center;
      transition: all var(--transition-fast);
    }

    .dashboard-stat:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
      border-color: var(--primary);
    }

    .dashboard-stat-value {
      font-size: var(--text-2xl);
      font-weight: 800;
      color: var(--primary);
      line-height: 1;
    }

    .dashboard-stat-label {
      font-size: var(--text-xs);
      font-weight: 600;
      color: var(--text-muted);
      margin-top: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .dashboard-time-saved {
      background: var(--success-light);
      border: 1px solid var(--success);
      border-radius: var(--radius-md);
      padding: var(--space-2);
      margin-top: var(--space-2);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-1);
    }

    .dashboard-time-saved-icon {
      font-size: 20px;
    }

    .dashboard-time-saved-text {
      font-size: var(--text-sm);
      font-weight: 600;
      color: var(--success);
    }

    .dashboard-time-saved-value {
      font-weight: 800;
      color: #047857;
    }

    /* --- Preset Profiles --- */
    .preset-profiles {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: var(--space-1);
      margin-bottom: var(--space-2);
    }

    @media (max-width: 500px) {
      .preset-profiles {
        grid-template-columns: 1fr;
      }
    }

    .preset-card {
      background: white;
      border: 2px solid var(--border);
      border-radius: var(--radius-md);
      padding: var(--space-2);
      cursor: pointer;
      transition: all var(--transition-fast);
      text-align: center;
    }

    .preset-card:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
      box-shadow: var(--shadow-sm);
    }

    .preset-card.active {
      border-color: var(--primary);
      background: var(--primary-light);
    }

    .preset-card-icon {
      font-size: 20px;
      margin-bottom: 4px;
    }

    .preset-card-name {
      font-size: var(--text-xs);
      font-weight: 700;
      color: var(--text-primary);
    }

    .preset-card-desc {
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    /* --- Sticky Export Bar --- */
    .sticky-export-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(255, 255, 255, 0.97);
      backdrop-filter: blur(12px);
      border-top: 2px solid var(--primary);
      padding: var(--space-2) var(--space-3);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-3);
      z-index: var(--z-sticky);
      box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
      transform: translateY(100%);
      transition: transform 0.3s ease-out;
    }

    .sticky-export-bar.visible {
      transform: translateY(0);
    }

    .sticky-export-bar .info {
      font-size: var(--text-sm);
      color: var(--text-secondary);
    }

    .sticky-export-bar .info strong {
      color: var(--primary);
    }

    /* --- Enhanced Validation --- */
    .input-valid::after {
      content: '✓';
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--success);
      font-weight: bold;
    }

    .validation-icon {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      width: 18px;
      height: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }

    .validation-icon.valid {
      background: var(--success);
      color: white;
    }

    .validation-icon.invalid {
      background: var(--error);
      color: white;
    }

    /* --- Enhanced Success Modal --- */
    .success-modal-content {
      position: relative;
      overflow: hidden;
    }

    .success-modal-glow {
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle at center, rgba(5, 150, 105, 0.1) 0%, transparent 50%);
      animation: pulseGlow 2s ease-in-out infinite;
    }

    @keyframes pulseGlow {

      0%,
      100% {
        opacity: 0.5;
        transform: scale(1);
      }

      50% {
        opacity: 1;
        transform: scale(1.05);
      }
    }

    /* --- Quick Action Pills --- */
    .quick-actions {
      display: flex;
      gap: var(--space-1);
      flex-wrap: wrap;
      margin-bottom: var(--space-2);
    }

    .quick-action-pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 6px 12px;
      background: var(--slate-100);
      border: 1px solid var(--border);
      border-radius: var(--radius-full);
      font-size: var(--text-xs);
      font-weight: 600;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .quick-action-pill:hover {
      background: var(--primary-light);
      border-color: var(--primary);
      color: var(--primary);
      transform: translateY(-1px);
    }

    /* --- Enhanced Table Hover --- */
    tbody tr:hover:not(.detail-row) {
      background: linear-gradient(90deg, var(--primary-light), var(--slate-100)) !important;
    }

    /* --- Panel Section Divider --- */
    .panel-section-divider {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      margin: var(--space-2) 0;
      color: var(--text-muted);
      font-size: var(--text-xs);
      font-weight: 600;
    }

    .panel-section-divider::before,
    .panel-section-divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border);
    }
  </style>
</head>

<body>
  <header>
    <div class="header-content">
      <div class="brand">
        <div class="brand-icon"> <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="11" cy="11" r="8"></circle>
            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
          </svg> </div>
        <div class="brand-text">
          <h1>Term Harvester Pro</h1>
          <p>Harvest Search Terms & ASINs</p>
        </div>
      </div>
      <div class="header-center">
        <div class="step-progress" id="stepProgress">
          <div class="step-item" data-step="1">
            <div class="step-number">1</div> <span class="step-text">Upload</span>
          </div>
          <div class="step-separator"></div>
          <div class="step-item" data-step="2">
            <div class="step-number">2</div> <span class="step-text">Configure</span>
          </div>
          <div class="step-separator"></div>
          <div class="step-item" data-step="3">
            <div class="step-number">3</div> <span class="step-text">Review</span>
          </div>
          <div class="step-separator"></div>
          <div class="step-item" data-step="4">
            <div class="step-number">4</div> <span class="step-text">Export</span>
          </div>
        </div>
      </div>
      <div class="controls">
        <div class="search-wrapper"> <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="11" cy="11" r="8"></circle>
            <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
          </svg> <input type="text" id="uiSearch" class="search-input" placeholder="Search products, terms..." /> </div>
        <button class="btn btn-secondary btn-sm" id="btnExpandAll">Expand</button> <button
          class="btn btn-secondary btn-sm" id="btnCollapseAll">Collapse</button>
        <!-- Dark Mode Toggle -->
        <button class="dark-mode-toggle" id="darkModeToggle" onclick="toggleDarkMode()" title="Toggle dark mode">
          <span class="toggle-icon" id="darkModeIcon">🌙</span>
          <span id="darkModeText">Dark</span>
        </button>
        <button class="btn btn-tertiary btn-icon" onclick="showShortcutsHelp()" title="Keyboard shortcuts (Press ?)">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="2" y="4" width="20" height="16" rx="2" />
            <path d="M6 8h.01M10 8h.01M14 8h.01M18 8h.01M8 12h.01M12 12h.01M16 12h.01M7 16h10" />
          </svg> </button>
      </div>
    </div>
  </header>
  <div class="app-container">
    <div class="sidebar">
      <div class="panel">
        <div class="panel-title"> <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="17 8 12 3 7 8"></polyline>
            <line x1="12" y1="3" x2="12" y2="15"></line>
          </svg>
          Data Source
        </div>
        <div
          style="background:var(--success-light); border:1px dashed var(--success); border-radius:var(--radius-lg); padding:var(--space-2); margin-bottom:var(--space-2);">
          <div
            style="font-size:var(--text-sm); font-weight:600; color:var(--success); margin-bottom:6px; display:flex; align-items:center; gap:6px;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
            </svg>
            Step 1: Prevent Duplicates (Required)
          </div>
          <div style="font-size:var(--text-xs); color:var(--success); margin-bottom:var(--space-1); line-height:1.5;">
            Upload <b>Bulk Ops File</b> or <b>Campaign Export</b> to prevent creating duplicate campaigns.<br> <span
              class="muted" style="color:var(--success); opacity:0.8;">💡 Tip: The simple "Export" button in Campaign
              Manager is fastest.</span> </div>
          <div class="drop-zone" id="dropZoneBulkRef" style="padding:16px; border-color:#bbf7d0; background:white;">
            <input type="file" id="fileInputBulkRef" accept=".xlsx,.xls,.csv" />
            <div class="drop-zone-text" style="margin-top:0;">📂 Upload "All Campaigns" Export</div>
            <div id="fileNameDisplayBulkRef"></div>
          </div>
          <div id="statusBulkRef" style="margin-top:4px; font-size:11px; font-weight:600; text-align:center;"></div>
        </div>
        <div style="font-size:12px; font-weight:700; margin-bottom:8px;">Sponsored Products (Search Term Report)</div>
        <div class="drop-zone" id="dropZoneSP"> <input type="file" id="fileInputSP" accept=".xlsx,.xls" />
          <div class="drop-zone-icon"> <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor"
              stroke-width="1.5">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
              <line x1="12" y1="18" x2="12" y2="12"></line>
              <line x1="9" y1="15" x2="12" y2="12"></line>
              <line x1="15" y1="15" x2="12" y2="12"></line>
            </svg> </div>
          <div class="drop-zone-text">Click to upload SP .xlsx or Drag & Drop</div>
          <div id="fileNameDisplaySP"></div>
        </div>
        <div id="statusSP" style="margin-top:10px; font-size:12px; font-weight:600; text-align:center;"></div>
        <div class="hr"></div>
        <div style="font-size:12px; font-weight:700; margin-bottom:8px;">Sponsored Brands (Search Term Report)</div>
        <div class="drop-zone" id="dropZoneSB"> <input type="file" id="fileInputSB" accept=".xlsx,.xls" />
          <div class="drop-zone-icon"> <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor"
              stroke-width="1.5">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
              <line x1="12" y1="18" x2="12" y2="12"></line>
              <line x1="9" y1="15" x2="12" y2="12"></line>
              <line x1="15" y1="15" x2="12" y2="12"></line>
            </svg> </div>
          <div class="drop-zone-text">Click to upload SB .xlsx or Drag & Drop</div>
          <div id="fileNameDisplaySB"></div>
        </div>
        <div id="statusSB" style="margin-top:10px; font-size:12px; font-weight:600; text-align:center;"></div>
      </div>

      <div class="panel" style="background: linear-gradient(135deg, #f8fafc 0%, #e0f2fe 100%);">
        <div class="panel-title" style="color: var(--primary);"> <svg width="16" height="16" viewBox="0 0 24 24"
            fill="none" stroke="currentColor" stroke-width="2">
            <path
              d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" />
            <polyline points="7.5 4.21 12 6.81 16.5 4.21" />
            <polyline points="7.5 19.79 7.5 14.6 3 12" />
            <polyline points="21 12 16.5 14.6 16.5 19.79" />
            <line x1="12" y1="12" x2="12" y2="6.81" />
          </svg>
          Product Name Extraction
        </div>
        <div style="font-size:11px; color:var(--text-muted); margin-bottom:12px;">
          How should we identify products from campaign names?
        </div>
        <div style="margin-bottom:12px;"> <label class="form-label" style="font-size:11px;">Extraction Method</label>
          <select id="productExtractionMethod" class="form-input" style="margin-bottom:8px;"
            onchange="toggleProductExtractionUI()">
            <option value="separator" selected>Auto-detect (|, -, : separators)</option>
            <option value="fullname">Use full campaign name</option>
            <option value="sku">Extract from SKU pattern</option>
            <option value="regex">Custom regex pattern</option>
            <option value="manual">Manual CSV mapping</option>
          </select>
        </div>
        <div id="regexPatternInput" style="display:none; margin-bottom:12px;"> <label class="form-label"
            style="font-size:11px;">Regex Pattern</label> <input type="text" id="productRegexPattern" class="form-input"
            placeholder="^([A-Z0-9-]+)" style="font-family: monospace; font-size:11px;">
          <div style="font-size:10px; color:var(--text-muted); margin-top:4px;">
            Example: <code>^([A-Z0-9-]+)</code> extracts SKU from start
          </div>
        </div>
        <div id="manualMappingInput" style="display:none; margin-bottom:12px;"> <label class="form-label"
            style="font-size:11px;">Upload Mapping CSV</label> <input type="file" id="productMappingFile" accept=".csv"
            class="form-input" style="padding:6px; font-size:11px;" onchange="loadProductMapping(this)">
          <div style="font-size:10px; color:var(--text-muted); margin-top:4px;">
            Format: Campaign Pattern, Product Name
          </div>
        </div>
        <div id="productPreviewSection"
          style="display:none; margin-top:12px; padding:10px; background:white; border-radius:6px; border:1px solid var(--border);">
          <div style="font-size:11px; font-weight:600; margin-bottom:6px; color:var(--text-primary);">
            Preview Detected Products:
          </div>
          <div id="productPreviewList"
            style="font-size:10px; color:var(--text-muted); max-height:120px; overflow-y:auto;"> </div>
        </div>
      </div>
      <div class="panel">
        <div class="panel-title"> <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="2">
            <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
          </svg>
          1. Select KPIs
        </div>
        <div style="font-size:11px; color:var(--text-muted); margin-bottom:12px;">Check rules to apply per product:
        </div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-bottom:12px;">
          <label class="toggle-label" style="display:flex; align-items:center; gap:6px; cursor:pointer;">
            <input type="checkbox" class="kpi-check" value="orders" checked onchange="rebuildProductInputs()"> Orders
            (>=)
          </label>
          <label class="toggle-label" style="display:flex; align-items:center; gap:6px; cursor:pointer;">
            <input type="checkbox" class="kpi-check" value="acos" checked onchange="rebuildProductInputs()"> ACoS (<=)
              </label>
              <label class="toggle-label" style="display:flex; align-items:center; gap:6px; cursor:pointer;">
                <input type="checkbox" class="kpi-check" value="spend" onchange="rebuildProductInputs()"> Spend (<=)
                  </label>
                  <label class="toggle-label" style="display:flex; align-items:center; gap:6px; cursor:pointer;">
                    <input type="checkbox" class="kpi-check" value="clicks" onchange="rebuildProductInputs()"> Clicks
                    (>=)
                  </label>
                  <label class="toggle-label" style="display:flex; align-items:center; gap:6px; cursor:pointer;">
                    <input type="checkbox" class="kpi-check" value="cv" onchange="rebuildProductInputs()"> Conv. Rate
                    (>=)
                  </label>
                  <label class="toggle-label" style="display:flex; align-items:center; gap:6px; cursor:pointer;">
                    <input type="checkbox" class="kpi-check" value="ctr" onchange="rebuildProductInputs()"> CTR (>=)
                  </label>
        </div>
        <div class="hr"></div>
        <div class="toggle-row"> <span class="toggle-label">Show Final Only</span> <label class="switch"><input
              type="checkbox" id="toggleFinalOnly" checked><span class="slider"></span></label> </div>
        <div class="toggle-row"> <span class="toggle-label">Hide Empty Products</span> <label class="switch"><input
              type="checkbox" id="toggleOnlyFinalProducts"><span class="slider"></span></label> </div>
        <div class="hr"></div>

      </div>
      <div class="panel">
        <div class="panel-title"> <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="2">
            <line x1="12" y1="1" x2="12" y2="23"></line>
            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
          </svg>
          2. Per-Product Rules
        </div>
        <!-- Per-product rules section -->
        <div id="productRulesContainer" style="max-height:400px; overflow-y:auto; padding-right:4px;">
          <div style="font-size:12px; color:#94a3b8; font-style:italic;">Upload file to detect products...</div>
        </div>
      </div> <button id="processBtn" class="btn btn-primary btn-cta" disabled>Run Analysis</button>
      <div style="margin-top:24px;">
        <div class="panel-title" style="margin-bottom:8px;">Quick Jump</div>
        <div id="productNav" class="product-nav"></div>
      </div>
    </div>
    <div class="results-area">
      <!-- Results display area -->

      <div id="resultsSummary" style="margin-bottom:16px; font-size:13px; font-weight:600; color:var(--text-muted);">
      </div>
      <div id="suggestionsBar" class="suggestions-bar hidden">
        <div class="left">
          <div class="title">Suggestions</div>
          <div class="sub">Export or copy harvested terms/ASINs (SP + SB) from the analysis above.</div>
        </div>
        <div class="right"> <button class="btn btn-secondary" id="btnExportSuggestionsXlsx">Export Suggestions
            (.xlsx)</button> <button class="btn btn-secondary" id="btnExportSuggestionsCsv">Export Suggestions
            (.csv)</button> <button class="btn btn-secondary" id="btnCopySuggestions">Copy All (Safe)</button> </div>
      </div>
      <div id="toast" class="toast" role="status" aria-live="polite"></div>
      <div id="bulkCtaWrap" class="hidden" style="margin: 0 0 14px 0;"> <button id="btnScrollToBulk"
          class="btn btn-primary" style="border-radius: 12px;">Continue to Bulk Export (Step 2)</button> <span
          style="font-size:12px; color:var(--text-muted); margin-left:10px;">Review suggestions above, then generate the
          bulk upload file.</span> </div>
      <div id="results">
        <div class="welcome-screen" id="welcomeScreen">
          <div class="welcome-icon"> <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round">
              <circle cx="11" cy="11" r="8"></circle>
              <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
              <path d="M11 8v4l3 3"></path>
            </svg> </div>
          <h2 class="welcome-title">Welcome to Term Harvester Pro</h2>
          <p class="welcome-description">
            Extract high-performing keywords from your Amazon PPC reports and generate
            bulk upload files in minutes. Save hours of manual work.
          </p>
          <div class="welcome-steps">
            <div class="welcome-step-card">
              <div class="welcome-step-number">1</div>
              <div class="welcome-step-title">Upload Reports</div>
              <div class="welcome-step-desc">Start with your campaign export, then add Search Term Reports (SP/SB)</div>
            </div>
            <div class="welcome-step-card">
              <div class="welcome-step-number">2</div>
              <div class="welcome-step-title">Set Rules</div>
              <div class="welcome-step-desc">Choose KPIs and set thresholds for each product</div>
            </div>
            <div class="welcome-step-card">
              <div class="welcome-step-number">3</div>
              <div class="welcome-step-title">Review & Export</div>
              <div class="welcome-step-desc">Analyze suggestions and download your bulk file</div>
            </div>
          </div>
          <div class="welcome-actions"> <button class="btn btn-primary btn-lg" onclick="scrollToUpload()">
              Get Started
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M5 12h14M12 5l7 7-7 7" />
              </svg> </button> <button class="btn btn-secondary btn-lg" onclick="loadSampleData()"> <svg width="16"
                height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                <path d="M14 2v6h6M12 18v-6M9 15l3 3 3-3" />
              </svg>
              Try Sample Data
            </button> </div>
          <div style="margin-top: var(--space-4); padding-top: var(--space-3); border-top: 1px solid var(--border);">
            <p class="muted">
              💡 <strong>Need help?</strong>
              <a href="#" onclick="openUserGuide(); return false;"
                style="color: var(--primary); text-decoration: underline;">Open User Guide</a>
            </p>
          </div>
        </div>
      </div>
      <div id="bulkStepPanel" class="panel hidden" style="margin-top:18px;">
        <div class="panel-title"> <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
            stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7 10 12 15 17 10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
          </svg>
          Bulk Export (Step 2)
        </div>
        <div style="font-size:12px; color:var(--text-muted); margin-bottom:12px;">
          Review suggestions above first. When ready, generate the Amazon bulk file here.
        </div> <button id="btnGoBulk" class="btn btn-primary btn-cta" style="margin-bottom:14px;">
          Continue to Bulk Export
        </button>
        <div id="bulkExportControls" class="hidden">
          <div class="bulk-workspace">
            <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px;"> <button type="button"
                class="btn btn-secondary" id="modeOpt1Btn" style="border-radius:999px;">Option 1: Templates +
                Rules</button> <button type="button" class="btn btn-secondary" id="modeOpt2Btn"
                style="border-radius:999px;">Option 2: Per-Product Profiles</button> <span
                style="font-size:11px; color:var(--text-muted); display:flex; align-items:center;">Select a workflow →
                export uses it immediately</span> </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:14px; margin-bottom:14px;">
              <div> <label class="form-label required">Start Date</label> <input type="date" id="bulkStartDate"
                  class="form-input" />
                <div id="dateError" class="form-error hidden"> <svg width="12" height="12" viewBox="0 0 24 24"
                    fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10" />
                    <line x1="12" y1="8" x2="12" y2="12" />
                    <line x1="12" y1="16" x2="12.01" y2="16" />
                  </svg> <span id="dateErrorText"></span> </div>
                <div class="form-help">Campaign start date (must be today or future)</div>
              </div>
              <div> <label class="form-label">State</label> <select id="bulkState" class="form-input">
                  <option value="Enabled" selected>Enabled</option>
                  <option value="Paused">Paused</option>
                </select>
                <div class="form-help">Campaign initial state</div>
              </div>
            </div>
            <div style="display:flex; gap:20px; margin-bottom:12px;">
              <div class="toggle-row" style="flex:1;"><span class="toggle-label">Include Sponsored Products
                  (SP)</span><label class="switch"><input type="checkbox" id="toggleExportSP" checked><span
                    class="slider"></span></label></div>
              <div class="toggle-row" style="flex:1;"><span class="toggle-label">Include Sponsored Brands Video
                  (SBV)</span><label class="switch"><input type="checkbox" id="toggleExportSBV" checked><span
                    class="slider"></span></label></div>
            </div>
            <div class="detailDivider"></div>
            <div id="bulkOptionWorkspace">
              <div id="panelOpt1">
                <div style="font-size:12px; font-weight:800; margin-bottom:8px;">Option 1: Templates + Rules</div>
                <div style="font-size:11px; color:var(--text-muted); margin-bottom:16px;">Define naming templates + bids
                  once. Tool applies them to every product/variation.</div>
                <div class="bulk-section-card sp-theme">
                  <div class="bulk-section-header sp-header"> <svg width="16" height="16" viewBox="0 0 24 24"
                      fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path>
                      <line x1="3" y1="6" x2="21" y2="6"></line>
                      <path d="M16 10a4 4 0 0 1-8 0"></path>
                    </svg>
                    Sponsored Products
                  </div>
                  <div class="mini-section" style="margin-bottom:12px;">
                    <div class="mini-label" style="display:flex; justify-content:space-between; align-items:center;">
                      <span>Bidding Strategy: Source CPC</span> <span
                        style="color:var(--primary); cursor:pointer; font-size:10px; font-weight:700;"
                        onclick="document.getElementById('helpBid').classList.toggle('hidden')">ℹ️ What's this?</span>
                    </div>
                    <div id="helpBid" class="hidden"
                      style="font-size:10px; color:var(--text-muted); margin-bottom:8px; background:#f8fafc; padding:8px; border-radius:6px; border:1px solid #e2e8f0;">
                      <b>Source CPC:</b> Uses the actual CPC of each harvested keyword from your search term data.
                      Add a modifier % to increase or decrease all bids. If CPC data is missing, fallback bids below are
                      used.
                    </div>
                    <!-- Hidden select for code compatibility -->
                    <select id="spBidStrategy" style="display:none;">
                      <option value="sourceCpc" selected>Source CPC</option>
                    </select>
                    <div style="display:flex; gap:10px; align-items:flex-end; margin-bottom:10px;">
                      <div style="flex:1;">
                        <label class="form-label">Bid Modifier %</label>
                        <input type="number" id="spBidModifier" class="form-input" placeholder="+10" value="0"
                          style="margin-bottom:0;" title="e.g., +10 increases bids by 10%, -5 decreases by 5%">
                        <div style="font-size:10px; color:var(--text-muted); margin-top:4px;">e.g., +10 = increase all
                          bids by 10%</div>
                      </div>
                    </div>
                    <!-- SP Keyword Bid Editor -->
                    <div style="margin-top:8px; margin-bottom:12px;">
                      <div id="spBidEditorToggle"
                        style="background:#eef2ff; border:1px dashed #c7d2fe; border-radius:8px; padding:10px 12px; cursor:pointer; display:flex; justify-content:space-between; align-items:center;"
                        onclick="toggleBidEditor('sp')">
                        <span style="font-size:12px; font-weight:600; color:#4f46e5;">
                          ✏️ Edit Individual Keyword Bids <span id="spBidEditorCount"
                            style="color:#64748b; font-weight:400;">(Run analysis first)</span>
                        </span>
                        <span id="spBidEditorChevron" style="font-size:10px;">▶</span>
                      </div>
                      <div id="spBidEditorPanel"
                        style="display:none; margin-top:8px; border:1px solid #e2e8f0; border-radius:8px; padding:12px; background:#fafafa;">
                        <div style="display:flex; gap:8px; margin-bottom:10px; flex-wrap:wrap;">
                          <select id="spBidFilterProduct" class="form-input"
                            style="flex:1; min-width:120px; margin:0; font-size:11px;" onchange="filterBidEditor('sp')">
                            <option value="">All Products</option>
                          </select>
                          <select id="spBidFilterMatch" class="form-input"
                            style="width:100px; margin:0; font-size:11px;" onchange="filterBidEditor('sp')">
                            <option value="">All Types</option>
                            <option value="Broad">Broad</option>
                            <option value="Phrase">Phrase</option>
                            <option value="Exact">Exact</option>
                            <option value="PT">PT (ASIN)</option>
                          </select>
                        </div>
                        <div id="spBidEditorTable"
                          style="max-height:250px; overflow-y:auto; border:1px solid #e2e8f0; border-radius:6px; background:white;">
                          <div style="padding:20px; text-align:center; color:#94a3b8; font-size:12px;">Run analysis to
                            see keywords</div>
                        </div>
                        <div
                          style="display:flex; gap:8px; margin-top:10px; justify-content:space-between; align-items:center;">
                          <span id="spBidEditorStatus" style="font-size:11px; color:#64748b;"></span>
                          <div style="display:flex; gap:8px;">
                            <button type="button" class="btn btn-secondary" style="padding:6px 12px; font-size:11px;"
                              onclick="cancelBidEdits('sp')">Cancel</button>
                            <button type="button" class="btn btn-primary" style="padding:6px 12px; font-size:11px;"
                              onclick="saveBidEdits('sp')">💾 Save Changes</button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="mini-grid" style="margin-bottom:12px;">
                    <div>
                      <div class="mini-label">SP Campaign Name Template</div> <input id="opt1_spCampTpl"
                        class="form-input" value="{Product} | SP | {Match} | Harvested" />
                    </div>
                    <div>
                      <div class="mini-label">SP Ad Group Template</div> <input id="opt1_spAgTpl" class="form-input"
                        value="{Match}" />
                    </div>
                  </div>
                  <div class="bulk-inline-3" style="margin-bottom:12px;">
                    <div> <label class="mini-label">SP Portfolio ID</label> <input id="opt1_spPortfolioId"
                        class="form-input" placeholder="Optional" /> </div>
                    <div>
                      <div class="mini-label">SP Daily Budget (default)</div> <input id="opt1_spBudget"
                        class="form-input" type="number" value="100" />
                    </div>
                    <div>
                      <div class="mini-label">SP Ad Group Default Bid</div> <input id="opt1_spDefaultBid"
                        class="form-input" type="number" step="0.01" value="0.75" />
                    </div>
                  </div>
                  <!-- Bids are sourced directly from Source CPC in the data -->
                  <div style="margin-bottom:12px; border-top:1px dashed #e2e8f0; padding-top:10px;">
                    <div class="mini-label" style="margin-bottom:6px;">How many targets per campaign? (Split limits)
                    </div>
                    <div class="bulk-inline-3">
                      <div>
                        <div class="mini-label">Broad/Camp</div><input id="kwPerCampBroad" class="form-input"
                          type="number" min="1" value="10" />
                      </div>
                      <div>
                        <div class="mini-label">Phrase/Camp</div><input id="kwPerCampPhrase" class="form-input"
                          type="number" min="1" value="10" />
                      </div>
                      <div>
                        <div class="mini-label">Exact/Camp</div><input id="kwPerCampExact" class="form-input"
                          type="number" min="1" value="10" />
                      </div>
                    </div>
                    <div style="margin-top:10px; display:flex; gap:10px;">
                      <div style="flex:1;">
                        <div class="mini-label">PT (ASIN)/Camp</div> <input id="ptPerCamp" class="form-input"
                          type="number" min="1" value="10" />
                      </div>
                      <div style="flex:2;">
                        <div class="mini-label">Bidding Strategy</div> <select id="spBiddingStrategy"
                          class="form-input">
                          <option value="Fixed bids">Fixed bids</option>
                          <option value="Dynamic bids - down only">Dynamic bids - down only</option>
                          <option value="Dynamic bids - up and down">Dynamic bids - up and down</option>
                        </select>
                      </div>
                    </div>
                  </div>
                  <div>
                    <div class="mini-label">SP SKU Mapping (required for Product Ad)</div>
                    <div style="font-size:11px; color:var(--text-muted); margin-bottom:8px;">Fill SKU for each
                      product/variation detected.</div>
                    <div id="opt1_spSkuMap"
                      style="max-height:150px; overflow:auto; border:1px solid var(--border); border-radius:12px; padding:10px;">
                    </div>
                  </div>
                </div>
                <div class="bulk-section-card sb-theme">
                  <div class="bulk-section-header sb-header"> <svg width="16" height="16" viewBox="0 0 24 24"
                      fill="none" stroke="currentColor" stroke-width="2">
                      <rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"></rect>
                      <line x1="7" y1="2" x2="7" y2="22"></line>
                      <line x1="17" y1="2" x2="17" y2="22"></line>
                      <line x1="2" y1="12" x2="22" y2="12"></line>
                      <line x1="2" y1="7" x2="7" y2="7"></line>
                      <line x1="2" y1="17" x2="7" y2="17"></line>
                      <line x1="17" y1="17" x2="22" y2="17"></line>
                      <line x1="17" y1="7" x2="22" y2="7"></line>
                    </svg>
                    Sponsored Brands Video
                  </div>
                  <!-- SBV Bidding Strategy (matching SP) -->
                  <div class="mini-section" style="margin-bottom:12px;">
                    <div class="mini-label" style="display:flex; justify-content:space-between; align-items:center;">
                      <span>Bidding Strategy: Source CPC</span> <span
                        style="color:var(--primary); cursor:pointer; font-size:10px; font-weight:700;"
                        onclick="document.getElementById('helpBidSbv').classList.toggle('hidden')">ℹ️ What's
                        this?</span>
                    </div>
                    <div id="helpBidSbv" class="hidden"
                      style="font-size:10px; color:var(--text-muted); margin-bottom:8px; background:#f8fafc; padding:8px; border-radius:6px; border:1px solid #e2e8f0;">
                      <b>Source CPC:</b> Uses the actual CPC of each harvested keyword from your search term data.
                      Add a modifier % to increase or decrease all bids. If CPC data is missing, fallback bids below are
                      used.
                    </div>
                    <!-- Hidden select for code compatibility -->
                    <select id="sbvBidStrategy" style="display:none;">
                      <option value="sourceCpc" selected>Source CPC</option>
                    </select>
                    <div style="display:flex; gap:10px; align-items:flex-end; margin-bottom:10px;">
                      <div style="flex:1;">
                        <label class="form-label">Bid Modifier %</label>
                        <input type="number" id="sbvBidModifier" class="form-input" placeholder="+10" value="0"
                          style="margin-bottom:0;" title="e.g., +10 increases bids by 10%, -5 decreases by 5%">
                        <div style="font-size:10px; color:var(--text-muted); margin-top:4px;">e.g., +10 = increase all
                          bids by 10%</div>
                      </div>
                    </div>
                    <!-- SBV Keyword Bid Editor -->
                    <div style="margin-top:8px;">
                      <div id="sbvBidEditorToggle"
                        style="background:#f5f3ff; border:1px dashed #c4b5fd; border-radius:8px; padding:10px 12px; cursor:pointer; display:flex; justify-content:space-between; align-items:center;"
                        onclick="toggleBidEditor('sbv')">
                        <span style="font-size:12px; font-weight:600; color:#7c3aed;">
                          ✏️ Edit Individual Keyword Bids <span id="sbvBidEditorCount"
                            style="color:#64748b; font-weight:400;">(Run analysis first)</span>
                        </span>
                        <span id="sbvBidEditorChevron" style="font-size:10px;">▶</span>
                      </div>
                      <div id="sbvBidEditorPanel"
                        style="display:none; margin-top:8px; border:1px solid #e2e8f0; border-radius:8px; padding:12px; background:#fafafa;">
                        <div style="display:flex; gap:8px; margin-bottom:10px; flex-wrap:wrap;">
                          <select id="sbvBidFilterProduct" class="form-input"
                            style="flex:1; min-width:120px; margin:0; font-size:11px;"
                            onchange="filterBidEditor('sbv')">
                            <option value="">All Products</option>
                          </select>
                          <select id="sbvBidFilterMatch" class="form-input"
                            style="width:100px; margin:0; font-size:11px;" onchange="filterBidEditor('sbv')">
                            <option value="">All Types</option>
                            <option value="Broad">Broad</option>
                            <option value="Phrase">Phrase</option>
                            <option value="Exact">Exact</option>
                          </select>
                        </div>
                        <div id="sbvBidEditorTable"
                          style="max-height:250px; overflow-y:auto; border:1px solid #e2e8f0; border-radius:6px; background:white;">
                          <div style="padding:20px; text-align:center; color:#94a3b8; font-size:12px;">Run analysis to
                            see keywords</div>
                        </div>
                        <div
                          style="display:flex; gap:8px; margin-top:10px; justify-content:space-between; align-items:center;">
                          <span id="sbvBidEditorStatus" style="font-size:11px; color:#64748b;"></span>
                          <div style="display:flex; gap:8px;">
                            <button type="button" class="btn btn-secondary" style="padding:6px 12px; font-size:11px;"
                              onclick="cancelBidEdits('sbv')">Cancel</button>
                            <button type="button" class="btn btn-primary" style="padding:6px 12px; font-size:11px;"
                              onclick="saveBidEdits('sbv')">💾 Save Changes</button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="mini-grid" style="margin-bottom:12px;">
                    <div>
                      <div class="mini-label">SBV Campaign Name Template</div> <input id="opt1_sbvCampTpl"
                        class="form-input" value="{Product} | SBV | {Video} | {Match}" />
                    </div>
                    <div>
                      <div class="mini-label">SBV Ad Group Template</div> <input id="opt1_sbvAgTpl" class="form-input"
                        value="{Match}" />
                    </div>
                  </div>
                  <div class="bulk-inline-3" style="margin-bottom:12px;">
                    <div> <label class="mini-label">Brand Entity ID (Sellers)</label> <input type="text"
                        id="bulkBrandEntityId" class="form-input" placeholder="Optional" /> </div>
                    <div> <label class="mini-label">Portfolio ID</label> <input type="text" id="bulkPortfolioId"
                        class="form-input" placeholder="Optional" /> </div>
                    <div> <label class="mini-label">Bid Optimization</label> <select id="bulkBidOpt" class="form-input">
                        <option value="true">True (Auto)</option>
                        <option value="false">False (Manual)</option>
                      </select> </div>
                  </div>
                  <div class="bulk-inline-3" style="margin-bottom:12px;">
                    <div>
                      <div class="mini-label">SBV Video Asset ID (e.g. amzn1.asset...)</div> <input id="opt1_sbvVideo"
                        class="form-input" value="amzn1.assetlibrary.asset1.xxxxx" />
                    </div>
                    <div>
                      <div class="mini-label">Creative ASIN (Video Target)</div> <input id="opt1_sbvAsin"
                        class="form-input" placeholder="B0xxxxxx" />
                    </div>
                    <div>
                      <div class="mini-label">SBV Daily Budget (default)</div> <input id="opt1_sbvBudget"
                        class="form-input" type="number" value="50" />
                    </div>
                  </div>
                  <!-- SBV Bids are sourced directly from Source CPC in the data -->
                  <div class="mini-section">
                    <div class="mini-label">Split Limits (Keywords per Campaign)</div>
                    <div class="bulk-inline-3">
                      <div>
                        <div class="mini-label">Broad/Camp</div><input id="sbvPerCampBroad" class="form-input"
                          type="number" min="1" step="1" value="10" />
                      </div>
                      <div>
                        <div class="mini-label">Phrase/Camp</div><input id="sbvPerCampPhrase" class="form-input"
                          type="number" min="1" step="1" value="10" />
                      </div>
                      <div>
                        <div class="mini-label">Exact/Camp</div><input id="sbvPerCampExact" class="form-input"
                          type="number" min="1" step="1" value="10" />
                      </div>
                    </div>
                    <div class="bulk-help">Automatically creates multiple SBV campaigns if keyword count exceeds these
                      limits.</div>
                  </div>
                </div>
              </div>
              <div id="panelOpt2" class="hidden">
                <div style="font-size:12px; font-weight:800; margin-bottom:8px;">Option 2: Per-Product Profiles</div>
                <div style="font-size:11px; color:var(--text-muted); margin-bottom:12px;">Configure budgets/bids/names
                  per variation. Best when margins differ.</div>
                <div class="bulk-two-col">
                  <div class="mini-section">
                    <div class="mini-label">Products</div>
                    <div id="opt2_productList" style="max-height:400px; overflow:auto;"></div>
                  </div>
                  <div class="mini-section">
                    <div class="mini-label">Selected Product Profile</div>
                    <div class="form-group"><label class="form-label">Campaign Base / Prefix</label><input
                        id="opt2_nameBase" class="form-input" placeholder="DC - P4 - Silver" /></div>
                    <div class="form-group"><label class="form-label">SP Daily Budget</label><input id="opt2_spBudget"
                        class="form-input" type="number" placeholder="100" /></div>
                    <div class="form-group"><label class="form-label">SP SKU (Product Ad)</label><input id="opt2_spSku"
                        class="form-input" placeholder="BR549" /></div>
                    <div class="form-group"> <label class="form-label">SP Bids (Broad / Phrase / Exact)</label>
                      <div style="display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:8px;"> <input
                          id="opt2_bidBroad" class="form-input" type="number" step="0.01" placeholder="Broad" /> <input
                          id="opt2_bidPhrase" class="form-input" type="number" step="0.01" placeholder="Phrase" />
                        <input id="opt2_bidExact" class="form-input" type="number" step="0.01" placeholder="Exact" />
                      </div>
                    </div>
                    <div class="form-group"><label class="form-label">SBV Video Asset ID</label><input
                        id="opt2_sbvVideo" class="form-input" placeholder="amzn1.assetlibrary..." /></div>
                    <div class="form-group"><label class="form-label">Creative ASIN (Video Target)</label><input
                        id="opt2_sbvAsin" class="form-input" placeholder="B0xxxxxx" /></div>
                    <div class="form-group"><label class="form-label">SBV Daily Budget</label><input id="opt2_sbvBudget"
                        class="form-input" type="number" placeholder="50" /></div>
                    <div class="form-group"><label class="form-label">SBV Keyword Bid</label><input id="opt2_sbvBid"
                        class="form-input" type="number" step="0.01" placeholder="0.80" /></div> <button type="button"
                      class="btn btn-secondary" id="opt2_saveProfile" style="width:100%; justify-content:center;">Save
                      Profile</button>
                    <div style="margin-top:10px; font-size:11px; color:var(--text-muted);" id="opt2_saveHint"></div>
                  </div>
                </div>
              </div>
            </div>
            <div class="bulk-stickybar">
              <div class="left">Step 2: Export your bulk upload file (.xlsx)</div>
              <div class="right"><button id="btnExportBulk" class="btn btn-primary">Download Bulk File (.xlsx)</button>
              </div>
            </div>
            <div id="bulkStatus" style="margin-top:8px; font-size:12px; font-weight:600; text-align:left;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="helpPopover" role="tooltip" aria-hidden="true">
    <div class="arrow"></div>
    <div id="helpPopoverContent"></div>
  </div>
  <div id="successModal"
    style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:var(--z-modal-backdrop); justify-content:center; align-items:center; backdrop-filter:blur(4px);">
    <div class="animate-slideUp"
      style="background:white; padding:var(--space-6); border-radius:var(--radius-xl); width:500px; max-width:90%; text-align:center; box-shadow:var(--shadow-xl);">
      <div
        style="width:80px; height:80px; margin:0 auto var(--space-3); background:linear-gradient(135deg, var(--success), #047857); border-radius:var(--radius-full); display:flex; align-items:center; justify-content:center; box-shadow:0 0 0 12px var(--success-bg);">
        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"
          stroke-linecap="round" stroke-linejoin="round">
          <polyline points="20 6 9 17 4 12"></polyline>
        </svg>
      </div>
      <h2 style="font-size:var(--text-2xl); font-weight:700; color:var(--text-primary); margin-bottom:var(--space-2);">
        🎉 Nice Work!
      </h2>
      <p
        style="font-size:var(--text-base); color:var(--text-secondary); margin-bottom:var(--space-4); line-height:var(--leading-relaxed);">
        You've created your bulk upload file! This would have taken <strong id="summHoursSaved">~4 hours</strong>
        manually.
        You just did it in minutes.
      </p>
      <div id="exportSummary"
        style="background:var(--slate-50); border-radius:var(--radius-lg); padding:var(--space-3); margin-bottom:var(--space-4); text-align:left;">
        <div
          style="font-size:var(--text-sm); font-weight:600; color:var(--text-primary); margin-bottom:var(--space-2);">
          Export Summary:
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:var(--space-2); font-size:var(--text-sm);">
          <div><span class="text-muted">Campaigns:</span> <strong id="summCampaigns">0</strong></div>
          <div><span class="text-muted">Keywords:</span> <strong id="summKeywords">0</strong></div>
          <div><span class="text-muted">ASINs:</span> <strong id="summAsins">0</strong></div>
          <div><span class="text-muted">Strategy:</span> <strong id="summStrategy">-</strong></div>
        </div>
      </div>
      <!-- Renamed Campaigns Section -->
      <div id="renamedCampaignsSection"
        style="display:none; background:#fef3c7; border:1px solid #fbbf24; border-radius:var(--radius-lg); padding:var(--space-3); margin-bottom:var(--space-4); text-align:left;">
        <div
          style="font-size:var(--text-sm); font-weight:600; color:#92400e; margin-bottom:var(--space-2); display:flex; align-items:center; gap:6px;">
          ⚠️ Renamed Campaigns (to avoid duplicates):
        </div>
        <div id="renamedCampaignsList" style="max-height:150px; overflow-y:auto; font-size:var(--text-xs);"></div>
      </div>
      <button class="btn btn-primary btn-lg" onclick="closeSuccessModal()"
        style="width:100%; margin-bottom:var(--space-2);">
        Continue
      </button>
      <p class="muted" style="margin-top:var(--space-2);">
        💡 <strong>Pro Tip:</strong> Your settings are auto-saved. Next time will be even faster!
      </p>
    </div>
  </div>
  <div id="copyModal"
    style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:var(--z-modal); justify-content:center; align-items:center;">
    <div
      style="background:white; padding:20px; border-radius:12px; width:400px; max-width:90%; max-height:80vh; display:flex; flex-direction:column; box-shadow:0 10px 25px rgba(0,0,0,0.2);">
      <div id="modalTitle" style="font-weight:700; font-size:14px; margin-bottom:10px; color:var(--text-main);">
        Apply Rules to Specific Products
      </div>
      <div style="font-size:11px; color:var(--text-muted); margin-bottom:10px;">
        Action Source: <span id="copySourceProduct" style="font-weight:700; color:var(--primary);"></span> </div> <input
        type="text" id="copyModalSearch" placeholder="Search products..."
        style="width:100%; padding:8px; border:1px solid var(--border); border-radius:6px; margin-bottom:10px; font-size:12px;">
      <div
        style="flex:1; overflow-y:auto; border:1px solid #f1f5f9; border-radius:6px; padding:8px; margin-bottom:16px;">
        <div style="margin-bottom:8px;"> <label
            style="font-size:11px; font-weight:700; display:flex; align-items:center; gap:6px; cursor:pointer;"> <input
              type="checkbox" id="copySelectAll" /> Select All
          </label> </div>
        <div id="copyTargetList"></div>
      </div>
      <div style="display:flex; gap:10px; justify-content:flex-end;"> <button class="btn btn-secondary"
          onclick="closeCopyModal()">Cancel</button> <button class="btn btn-primary" id="btnConfirmCopy">Apply
          Rules</button> </div>
    </div>
  </div>
  <!-- Bulk Preview Modal -->
  <div id="bulkPreviewModal"
    style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:var(--z-modal); justify-content:center; align-items:center; backdrop-filter:blur(4px);">
    <div class="animate-slideUp"
      style="background:white; border-radius:var(--radius-xl); width:95%; max-width:1400px; max-height:90vh; display:flex; flex-direction:column; box-shadow:var(--shadow-xl); overflow:hidden;">
      <!-- Header -->
      <div
        style="padding:20px 24px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; background:linear-gradient(135deg, var(--primary-light) 0%, white 100%);">
        <div>
          <h2 style="font-size:18px; font-weight:700; color:var(--text-primary); margin:0;">📋 Bulk File Preview</h2>
          <p style="font-size:12px; color:var(--text-muted); margin-top:4px;">Review all data before downloading. This
            is exactly what will be exported.</p>
        </div>
        <button onclick="closeBulkPreview()"
          style="background:none; border:none; font-size:24px; cursor:pointer; color:var(--text-muted); padding:8px;">&times;</button>
      </div>
      <!-- Summary Bar -->
      <div id="previewSummaryBar"
        style="padding:12px 24px; background:var(--slate-50); border-bottom:1px solid var(--border); display:flex; gap:24px; flex-wrap:wrap;">
        <div style="font-size:13px;"><strong>SP Rows:</strong> <span id="previewSpRows">0</span></div>
        <div style="font-size:13px;"><strong>SBV Rows:</strong> <span id="previewSbvRows">0</span></div>
        <div style="font-size:13px;"><strong>Total Campaigns:</strong> <span id="previewTotalCampaigns">0</span></div>
        <div style="font-size:13px;"><strong>Total Keywords:</strong> <span id="previewTotalKeywords">0</span></div>
      </div>
      <!-- Tab Switcher -->
      <div style="padding:12px 24px 0; display:flex; gap:8px; border-bottom:1px solid var(--border);">
        <button id="previewTabSP" class="preview-tab active" onclick="switchPreviewTab('sp')"
          style="padding:10px 20px; border:none; background:var(--primary); color:white; border-radius:8px 8px 0 0; font-weight:600; cursor:pointer; font-size:13px;">SP
          Bulk</button>
        <button id="previewTabSBV" class="preview-tab" onclick="switchPreviewTab('sbv')"
          style="padding:10px 20px; border:none; background:var(--slate-100); color:var(--text-muted); border-radius:8px 8px 0 0; font-weight:600; cursor:pointer; font-size:13px;">SBV
          Bulk</button>
      </div>
      <!-- Table Container -->
      <div style="flex:1; overflow:auto; padding:0;">
        <div id="previewTableSP" style="min-width:100%; overflow-x:auto;"></div>
        <div id="previewTableSBV" style="min-width:100%; overflow-x:auto; display:none;"></div>
      </div>
      <!-- Footer -->
      <div
        style="padding:16px 24px; border-top:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; background:var(--slate-50);">
        <div style="font-size:12px; color:var(--text-muted);">
          💡 Scroll horizontally to see all columns. Data shown is exactly what will be in the Excel file.
        </div>
        <div style="display:flex; gap:12px;">
          <button class="btn btn-secondary" onclick="closeBulkPreview()">Cancel</button>
          <button class="btn btn-primary btn-lg" onclick="confirmAndDownloadBulk()" style="min-width:200px;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            Confirm & Download
          </button>
        </div>
      </div>
    </div>
  </div>
  <style>
    /* Preview Table Styles */
    .preview-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }

    .preview-table th {
      position: sticky;
      top: 0;
      background: var(--slate-700);
      color: white;
      padding: 10px 8px;
      text-align: left;
      font-weight: 600;
      white-space: nowrap;
      border-bottom: 2px solid var(--slate-900);
      z-index: 10;
    }

    .preview-table td {
      padding: 8px;
      border-bottom: 1px solid var(--border);
      white-space: nowrap;
      max-width: 200px;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .preview-table tr:nth-child(even) {
      background: var(--slate-50);
    }

    .preview-table tr:hover {
      background: var(--primary-light);
    }

    .preview-table td.campaign-row {
      background: #dbeafe;
      font-weight: 600;
    }

    .preview-table td.adgroup-row {
      background: #e0f2fe;
    }

    .preview-table td.keyword-row {
      background: white;
    }

    .preview-table td.pt-row {
      background: #f3e8ff;
    }

    .preview-tab.active {
      background: var(--primary) !important;
      color: white !important;
    }

    /* User Guide Modal Styles */
    .guide-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: var(--z-modal);
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(4px);
    }

    .guide-container {
      background: white;
      border-radius: var(--radius-xl);
      width: 95%;
      max-width: 1000px;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow-xl);
      overflow: hidden;
    }

    .guide-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(135deg, var(--primary-light) 0%, white 100%);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .guide-search {
      padding: 12px 24px;
      border-bottom: 1px solid var(--border);
      background: var(--slate-50);
    }

    .guide-search input {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      font-size: 14px;
    }

    .guide-search input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px var(--primary-light);
    }

    .guide-body {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    .guide-sidebar {
      width: 220px;
      border-right: 1px solid var(--border);
      overflow-y: auto;
      background: var(--slate-50);
      padding: 12px 0;
      flex-shrink: 0;
    }

    .guide-nav-item {
      padding: 10px 20px;
      font-size: 13px;
      color: var(--text-secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.15s;
    }

    .guide-nav-item:hover {
      background: var(--primary-light);
      color: var(--primary);
    }

    .guide-nav-item.active {
      background: var(--primary);
      color: white;
      font-weight: 600;
    }

    .guide-content {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
    }

    .guide-section {
      margin-bottom: 32px;
    }

    .guide-section-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 2px solid var(--primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .guide-item {
      background: var(--slate-50);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 16px;
      margin-bottom: 12px;
    }

    .guide-item-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .guide-item-desc {
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.6;
    }

    .guide-item-tip {
      margin-top: 8px;
      padding: 8px 12px;
      background: var(--info-light);
      border-radius: var(--radius-sm);
      font-size: 12px;
      color: var(--info);
    }

    .guide-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 99px;
      font-size: 10px;
      font-weight: 600;
      background: var(--primary-light);
      color: var(--primary);
    }

    .guide-hidden {
      display: none !important;
    }

    @media (max-width: 768px) {
      .guide-sidebar {
        display: none;
      }
    }
  </style>
  <!-- User Guide Modal -->
  <div id="userGuideModal" class="guide-modal">
    <div class="guide-container">
      <div class="guide-header">
        <div>
          <h2 style="font-size:18px; font-weight:700; color:var(--text-primary); margin:0;">📖 Term Harvester Pro - User
            Guide</h2>
          <p style="font-size:12px; color:var(--text-muted); margin-top:4px;">Complete guide to all features and buttons
          </p>
        </div>
        <button onclick="closeUserGuide()"
          style="background:none; border:none; font-size:24px; cursor:pointer; color:var(--text-muted); padding:8px;">&times;</button>
      </div>
      <div class="guide-search">
        <input type="text" id="guideSearchInput"
          placeholder="🔍 Search: Type to find any feature, button, or setting..." oninput="filterGuide(this.value)">
      </div>
      <div class="guide-body">
        <div class="guide-sidebar">
          <div class="guide-nav-item active" onclick="scrollToGuideSection('getting-started')">🚀 Getting Started</div>
          <div class="guide-nav-item" onclick="scrollToGuideSection('upload-files')">📤 Upload Files</div>
          <div class="guide-nav-item" onclick="scrollToGuideSection('product-extraction')">⚙️ Product Extraction</div>
          <div class="guide-nav-item" onclick="scrollToGuideSection('select-kpis')">🎯 Select KPIs</div>
          <div class="guide-nav-item" onclick="scrollToGuideSection('product-rules')">📝 Per-Product Rules</div>
          <div class="guide-nav-item" onclick="scrollToGuideSection('run-analysis')">▶️ Run Analysis</div>
          <div class="guide-nav-item" onclick="scrollToGuideSection('results')">📊 Results Area</div>
          <div class="guide-nav-item" onclick="scrollToGuideSection('suggestions')">💾 Export Suggestions</div>
          <div class="guide-nav-item" onclick="scrollToGuideSection('bulk-export')">📦 Bulk Export</div>
          <div class="guide-nav-item" onclick="scrollToGuideSection('sp-settings')">🛒 SP Settings</div>
          <div class="guide-nav-item" onclick="scrollToGuideSection('sbv-settings')">🎬 SBV Settings</div>
          <div class="guide-nav-item" onclick="scrollToGuideSection('preview')">👁️ Bulk Preview</div>
          <div class="guide-nav-item" onclick="scrollToGuideSection('shortcuts')">⌨️ Shortcuts</div>
          <div class="guide-nav-item" onclick="scrollToGuideSection('troubleshooting')">❓ Troubleshooting</div>
        </div>
        <div class="guide-content" id="guideContent">
          <!-- Getting Started -->
          <div class="guide-section" id="guide-getting-started"
            data-keywords="getting started overview introduction what is purpose">
            <div class="guide-section-title">🚀 Getting Started</div>
            <div class="guide-item" data-keywords="what is term harvester pro purpose overview">
              <div class="guide-item-title">What is Term Harvester Pro?</div>
              <div class="guide-item-desc">Term Harvester Pro extracts high-performing keywords and ASINs from your
                Amazon PPC Search Term Reports and generates bulk upload files. Instead of manually reviewing thousands
                of rows, this tool automates the process in minutes.</div>
            </div>
            <div class="guide-item" data-keywords="workflow steps process how to use">
              <div class="guide-item-title">How it Works (3 Simple Steps)</div>
              <div class="guide-item-desc">
                <strong>Step 1:</strong> Upload your Campaign Export + Search Term Reports<br>
                <strong>Step 2:</strong> Set your KPI rules (Orders, ACoS, etc.) per product<br>
                <strong>Step 3:</strong> Review suggestions and export your bulk file
              </div>
            </div>
          </div>

          <!-- Upload Files -->
          <div class="guide-section" id="guide-upload-files" data-keywords="upload files drag drop xlsx csv">
            <div class="guide-section-title">📤 Upload Files</div>
            <div class="guide-item" data-keywords="bulk ops campaign export prevent duplicates all campaigns">
              <div class="guide-item-title">📂 Bulk Ops / Campaign Export <span class="guide-badge">Required</span>
              </div>
              <div class="guide-item-desc">Upload your "All Campaigns" export from Amazon Campaign Manager. This file is
                used to <strong>prevent duplicate campaigns</strong> - the tool checks if a campaign name already exists
                before creating new ones.</div>
              <div class="guide-item-tip">💡 Tip: In Campaign Manager, use the simple "Export" button to download all
                campaigns. This is the fastest method.</div>
            </div>
            <div class="guide-item" data-keywords="sp sponsored products search term report xlsx">
              <div class="guide-item-title">📄 SP Search Term Report</div>
              <div class="guide-item-desc">Upload your Sponsored Products Search Term Report (.xlsx). This contains all
                the search terms that triggered your SP ads. The tool will analyze these to find winning keywords.</div>
            </div>
            <div class="guide-item" data-keywords="sb sponsored brands search term report xlsx">
              <div class="guide-item-title">📄 SB Search Term Report</div>
              <div class="guide-item-desc">Upload your Sponsored Brands Search Term Report (.xlsx). Similar to SP, this
                contains search terms for your brand campaigns.</div>
            </div>
            <div class="guide-item" data-keywords="drag drop click upload file">
              <div class="guide-item-title">How to Upload</div>
              <div class="guide-item-desc">You can either <strong>click</strong> on the upload zone to browse for files,
                or <strong>drag and drop</strong> files directly onto the zone. The file name will appear once uploaded.
              </div>
            </div>
          </div>

          <!-- Product Extraction -->
          <div class="guide-section" id="guide-product-extraction"
            data-keywords="product extraction name detection campaign">
            <div class="guide-section-title">⚙️ Product Name Extraction</div>
            <div class="guide-item" data-keywords="auto detect separator pipe dash colon">
              <div class="guide-item-title">Auto-detect (Recommended)</div>
              <div class="guide-item-desc">Automatically detects product names from campaign names using common
                separators like | (pipe), - (dash), or : (colon). Example: "Blue Hat | SP | Auto" → Product = "Blue Hat"
              </div>
            </div>
            <div class="guide-item" data-keywords="full name campaign use entire">
              <div class="guide-item-title">Use Full Campaign Name</div>
              <div class="guide-item-desc">Uses the entire campaign name as the product name. Best when your campaign
                names ARE your product names.</div>
            </div>
            <div class="guide-item" data-keywords="sku pattern extract">
              <div class="guide-item-title">Extract from SKU Pattern</div>
              <div class="guide-item-desc">Extracts SKU codes from campaign names using pattern matching.</div>
            </div>
            <div class="guide-item" data-keywords="regex custom pattern regular expression">
              <div class="guide-item-title">Custom Regex Pattern</div>
              <div class="guide-item-desc">For advanced users. Enter a regular expression to extract product names.
                Example: ^([A-Z0-9-]+) extracts SKU from the start.</div>
            </div>
            <div class="guide-item" data-keywords="manual csv mapping upload">
              <div class="guide-item-title">Manual CSV Mapping</div>
              <div class="guide-item-desc">Upload a CSV file that maps campaign name patterns to product names. Format:
                Campaign Pattern, Product Name</div>
            </div>
          </div>

          <!-- Select KPIs -->
          <div class="guide-section" id="guide-select-kpis" data-keywords="kpi metrics filter criteria">
            <div class="guide-section-title">🎯 Select KPIs</div>
            <div class="guide-item" data-keywords="orders minimum greater than sales conversions">
              <div class="guide-item-title">✅ Orders (>=)</div>
              <div class="guide-item-desc">Filter keywords that have at least X orders. Higher = more proven winners.
                <strong>Recommended: 1+</strong> for finding keywords that actually convert.
              </div>
            </div>
            <div class="guide-item" data-keywords="acos advertising cost of sales percentage less than">
              <div class="guide-item-title">✅ ACoS (<=)< /div>
                  <div class="guide-item-desc">Filter keywords with ACoS at or below X%. Lower ACoS = more profitable.
                    <strong>Recommended: 30% or less</strong> for profitable keywords.
                  </div>
              </div>
              <div class="guide-item" data-keywords="spend maximum budget less than">
                <div class="guide-item-title">💰 Spend (<=)< /div>
                    <div class="guide-item-desc">Filter keywords where spend is at or below $X. Useful to exclude
                      high-spend, low-return terms.</div>
                </div>
                <div class="guide-item" data-keywords="clicks minimum traffic greater than">
                  <div class="guide-item-title">🖱️ Clicks (>=)</div>
                  <div class="guide-item-desc">Filter keywords with at least X clicks. More clicks = more data to make
                    decisions.</div>
                </div>
                <div class="guide-item" data-keywords="conversion rate percentage greater than cv">
                  <div class="guide-item-title">📈 Conv. Rate (>=)</div>
                  <div class="guide-item-desc">Filter keywords with conversion rate at or above X%. Higher = better
                    converting traffic.</div>
                </div>
                <div class="guide-item" data-keywords="ctr click through rate percentage greater than">
                  <div class="guide-item-title">📊 CTR (>=)</div>
                  <div class="guide-item-desc">Filter keywords with click-through rate at or above X%. Higher CTR = more
                    relevant keywords.</div>
                </div>
                <div class="guide-item" data-keywords="show final only toggle filter">
                  <div class="guide-item-title">🔘 Show Final Only</div>
                  <div class="guide-item-desc">When ON, only shows keywords that PASSED all your filters. When OFF,
                    shows both passed and excluded keywords.</div>
                </div>
                <div class="guide-item" data-keywords="hide empty products toggle filter">
                  <div class="guide-item-title">🔘 Hide Empty Products</div>
                  <div class="guide-item-desc">When ON, hides products that have no winning keywords after filtering.
                  </div>
                </div>
              </div>

              <!-- Per-Product Rules -->
              <div class="guide-section" id="guide-product-rules"
                data-keywords="per product rules thresholds individual">
                <div class="guide-section-title">📝 Per-Product Rules</div>
                <div class="guide-item" data-keywords="apply smart defaults recommended values all products">
                  <div class="guide-item-title">⚡ Apply Smart Defaults</div>
                  <div class="guide-item-desc">Applies recommended default values (Orders >= 1, ACoS <= 30%) to ALL
                      products at once. Great for getting started quickly.</div>
                  </div>
                  <div class="guide-item" data-keywords="individual product threshold different settings">
                    <div class="guide-item-title">Setting Individual Rules</div>
                    <div class="guide-item-desc">Each product has its own input fields for KPIs. You can set different
                      thresholds for each product based on margins. Example: High-margin product = 40% ACoS, Low-margin
                      = 20% ACoS.</div>
                  </div>
                  <div class="guide-item" data-keywords="copy to all duplicate rules apply">
                    <div class="guide-item-title">📋 Copy to All</div>
                    <div class="guide-item-desc">Copies the rules from one product and applies them to ALL other
                      products. Saves time when most products have similar goals.</div>
                  </div>
                  <div class="guide-item" data-keywords="apply to specific select products copy">
                    <div class="guide-item-title">📋 Apply to Specific</div>
                    <div class="guide-item-desc">Opens a modal where you can select which products to copy rules to.
                      Useful when only some products share the same settings.</div>
                  </div>
                  <div class="guide-item" data-keywords="clear all remove rules delete">
                    <div class="guide-item-title">🗑️ Clear All</div>
                    <div class="guide-item-desc">Removes all rules from ALL products. Use with caution - this resets
                      everything.</div>
                  </div>
                  <div class="guide-item" data-keywords="remove from specific select products clear">
                    <div class="guide-item-title">🗑️ Remove from Specific</div>
                    <div class="guide-item-desc">Opens a modal to select which products should have their rules removed.
                    </div>
                  </div>
                </div>

                <!-- Run Analysis -->
                <div class="guide-section" id="guide-run-analysis" data-keywords="run analysis process execute start">
                  <div class="guide-section-title">▶️ Run Analysis</div>
                  <div class="guide-item" data-keywords="run analysis button process start execute">
                    <div class="guide-item-title">▶️ Run Analysis Button</div>
                    <div class="guide-item-desc">Click this button after uploading files and setting rules. The tool
                      will process all search terms, apply your KPI filters, check for duplicates, and organize keywords
                      into Broad, Phrase, Exact, and ASIN buckets.</div>
                    <div class="guide-item-tip">💡 The button is disabled until you upload at least one Search Term
                      Report.</div>
                  </div>
                  <div class="guide-item" data-keywords="what happens after analysis results">
                    <div class="guide-item-title">What Happens After Analysis</div>
                    <div class="guide-item-desc">Results appear in the main area grouped by product. Each product
                      shows:<br>• ASIN bucket (Product Targeting opportunities)<br>• Broad/Phrase/Exact match
                      keywords<br>• Passed vs Excluded counts</div>
                  </div>
                </div>

                <!-- Results Area -->
                <div class="guide-section" id="guide-results" data-keywords="results products keywords view">
                  <div class="guide-section-title">📊 Results Area</div>
                  <div class="guide-item" data-keywords="expand collapse all products toggle view">
                    <div class="guide-item-title">Expand / Collapse Buttons</div>
                    <div class="guide-item-desc"><strong>Expand:</strong> Opens all product cards to show
                      details.<br><strong>Collapse:</strong> Closes all product cards for a compact view.</div>
                  </div>
                  <div class="guide-item" data-keywords="search filter find keywords products">
                    <div class="guide-item-title">🔍 Search Bar</div>
                    <div class="guide-item-desc">Type to filter products and keywords in real-time. Searches product
                      names and keyword text.</div>
                  </div>
                  <div class="guide-item" data-keywords="product card bucket asin broad phrase exact">
                    <div class="guide-item-title">Product Cards</div>
                    <div class="guide-item-desc">Each product has expandable sections for ASIN, Broad, Phrase, and Exact
                      keywords. Click to expand and see all keywords with their KPI data.</div>
                  </div>
                  <div class="guide-item" data-keywords="quick jump navigation sidebar">
                    <div class="guide-item-title">Quick Jump Navigation</div>
                    <div class="guide-item-desc">The sidebar shows detected products. Click any product name to scroll
                      directly to it.</div>
                  </div>
                </div>

                <!-- Suggestions Export -->
                <div class="guide-section" id="guide-suggestions" data-keywords="suggestions export copy download">
                  <div class="guide-section-title">💾 Export Suggestions</div>
                  <div class="guide-item" data-keywords="export suggestions xlsx excel download">
                    <div class="guide-item-title">Export Suggestions (.xlsx)</div>
                    <div class="guide-item-desc">Downloads all suggestions (passed and excluded) as an Excel file.
                      Includes product, bucket, status, keyword, and all KPI data. Good for detailed review.</div>
                  </div>
                  <div class="guide-item" data-keywords="export suggestions csv download comma separated">
                    <div class="guide-item-title">Export Suggestions (.csv)</div>
                    <div class="guide-item-desc">Same as above but in CSV format. Compatible with more tools.</div>
                  </div>
                  <div class="guide-item" data-keywords="copy all clipboard paste final">
                    <div class="guide-item-title">Copy All (Safe)</div>
                    <div class="guide-item-desc">Copies only FINAL (passed) suggestions to your clipboard in a
                      tab-separated format. You can paste this directly into Excel or Google Sheets.</div>
                  </div>
                </div>

                <!-- Bulk Export -->
                <div class="guide-section" id="guide-bulk-export" data-keywords="bulk export step 2 amazon upload">
                  <div class="guide-section-title">📦 Bulk Export (Step 2)</div>
                  <div class="guide-item" data-keywords="continue to bulk export button">
                    <div class="guide-item-title">Continue to Bulk Export</div>
                    <div class="guide-item-desc">After reviewing suggestions, click this button to reveal bulk export
                      settings. This is where you configure the Amazon bulk upload file.</div>
                  </div>
                  <div class="guide-item" data-keywords="option 1 templates rules global settings">
                    <div class="guide-item-title">Option 1: Templates + Rules</div>
                    <div class="guide-item-desc">Define naming templates and bid settings once, and they apply to ALL
                      products. Best when products have similar settings.</div>
                  </div>
                  <div class="guide-item" data-keywords="option 2 per-product profiles individual settings">
                    <div class="guide-item-title">Option 2: Per-Product Profiles</div>
                    <div class="guide-item-desc">Configure budgets, bids, and names for each product individually. Best
                      when products have different margins or strategies.</div>
                  </div>
                  <div class="guide-item" data-keywords="start date campaign begin">
                    <div class="guide-item-title">📅 Start Date</div>
                    <div class="guide-item-desc">The date your new campaigns will start. Must be today or a future date.
                    </div>
                  </div>
                  <div class="guide-item" data-keywords="state enabled paused campaign status">
                    <div class="guide-item-title">State (Enabled/Paused)</div>
                    <div class="guide-item-desc">Whether campaigns are immediately active (Enabled) or paused for
                      review.</div>
                  </div>
                  <div class="guide-item" data-keywords="include sp sponsored products toggle">
                    <div class="guide-item-title">Include SP</div>
                    <div class="guide-item-desc">Toggle ON to include Sponsored Products campaigns in the export.</div>
                  </div>
                  <div class="guide-item" data-keywords="include sbv sponsored brands video toggle">
                    <div class="guide-item-title">Include SBV</div>
                    <div class="guide-item-desc">Toggle ON to include Sponsored Brands Video campaigns in the export.
                    </div>
                  </div>
                </div>

                <!-- SP Settings -->
                <div class="guide-section" id="guide-sp-settings"
                  data-keywords="sp sponsored products settings configuration">
                  <div class="guide-section-title">🛒 SP Settings</div>
                  <div class="guide-item" data-keywords="campaign name template product match placeholder">
                    <div class="guide-item-title">Campaign Name Template</div>
                    <div class="guide-item-desc">Use placeholders like {Product} and {Match} to auto-generate campaign
                      names. Example: "{Product} | SP | {Match} | Harvested" becomes "Blue Hat | SP | Broad | Harvested"
                    </div>
                  </div>
                  <div class="guide-item" data-keywords="ad group template name">
                    <div class="guide-item-title">Ad Group Template</div>
                    <div class="guide-item-desc">Template for ad group names. Can use same placeholders.</div>
                  </div>
                  <div class="guide-item" data-keywords="portfolio id grouping organization">
                    <div class="guide-item-title">Portfolio ID</div>
                    <div class="guide-item-desc">Optional. Add campaigns to a specific portfolio for organization.</div>
                  </div>
                  <div class="guide-item" data-keywords="daily budget amount spend limit">
                    <div class="guide-item-title">Daily Budget</div>
                    <div class="guide-item-desc">Default daily budget for new campaigns.</div>
                  </div>
                  <div class="guide-item" data-keywords="bid modifier percentage increase decrease source cpc">
                    <div class="guide-item-title">Bid Modifier %</div>
                    <div class="guide-item-desc">Adjust all bids by a percentage. +10 = increase bids by 10%. -5 =
                      decrease by 5%.</div>
                  </div>
                  <div class="guide-item" data-keywords="fallback bids broad phrase exact default">
                    <div class="guide-item-title">Fallback/Fixed Bids</div>
                    <div class="guide-item-desc">Default bids per match type when source CPC data is missing. Set
                      different bids for Broad, Phrase, Exact, and PT.</div>
                  </div>
                  <div class="guide-item" data-keywords="edit individual keyword bids custom override">
                    <div class="guide-item-title">✏️ Edit Individual Keyword Bids</div>
                    <div class="guide-item-desc">Click to open a table where you can edit bids for specific keywords.
                      Great for fine-tuning high-value terms.</div>
                  </div>
                  <div class="guide-item" data-keywords="split limits keywords per campaign">
                    <div class="guide-item-title">Split Limits (Keywords per Campaign)</div>
                    <div class="guide-item-desc">Maximum keywords per campaign. If you have 50 Broad keywords and limit
                      is 10, you'll get 5 campaigns.</div>
                  </div>
                  <div class="guide-item" data-keywords="sku mapping product ad required">
                    <div class="guide-item-title">SKU Mapping</div>
                    <div class="guide-item-desc">Enter the SKU for each product. Required to create Product Ads in your
                      campaigns.</div>
                  </div>
                  <div class="guide-item" data-keywords="bidding strategy fixed dynamic down only up">
                    <div class="guide-item-title">Bidding Strategy</div>
                    <div class="guide-item-desc"><strong>Fixed bids:</strong> Amazon uses your exact
                      bid.<br><strong>Dynamic down only:</strong> Amazon lowers bid for low-conversion
                      placements.<br><strong>Dynamic up and down:</strong> Amazon adjusts bids both ways.</div>
                  </div>
                </div>

                <!-- SBV Settings -->
                <div class="guide-section" id="guide-sbv-settings" data-keywords="sbv sponsored brands video settings">
                  <div class="guide-section-title">🎬 SBV Settings</div>
                  <div class="guide-item" data-keywords="video asset id amzn1 asset library">
                    <div class="guide-item-title">Video Asset ID</div>
                    <div class="guide-item-desc">Your video's asset ID from Amazon's Asset Library. Format:
                      amzn1.assetlibrary.asset1.xxxxx</div>
                  </div>
                  <div class="guide-item" data-keywords="creative asin product detail page video target">
                    <div class="guide-item-title">Creative ASIN</div>
                    <div class="guide-item-desc">The ASIN that the video ad will link to. Usually your main product
                      ASIN.</div>
                  </div>
                  <div class="guide-item" data-keywords="brand entity id seller vendor">
                    <div class="guide-item-title">Brand Entity ID</div>
                    <div class="guide-item-desc">For sellers. Your brand's entity ID from Amazon.</div>
                  </div>
                  <div class="guide-item" data-keywords="bid optimization auto manual true false">
                    <div class="guide-item-title">Bid Optimization</div>
                    <div class="guide-item-desc"><strong>True (Auto):</strong> Amazon optimizes bids for
                      conversions.<br><strong>False (Manual):</strong> You control exact bids.</div>
                  </div>
                  <div class="guide-item" data-keywords="sbv bids broad phrase exact match type">
                    <div class="guide-item-title">SBV Bid Rules</div>
                    <div class="guide-item-desc">Set default bids for each match type in SBV campaigns. Usually higher
                      than SP due to premium placements.</div>
                  </div>
                </div>

                <!-- Bulk Preview -->
                <div class="guide-section" id="guide-preview" data-keywords="preview review before download confirm">
                  <div class="guide-section-title">👁️ Bulk Preview</div>
                  <div class="guide-item" data-keywords="download bulk file preview button">
                    <div class="guide-item-title">Download Bulk File Button</div>
                    <div class="guide-item-desc">When you click this, a preview modal opens showing EXACTLY what will be
                      in your Excel file. Review all campaigns, keywords, and settings before confirming.</div>
                  </div>
                  <div class="guide-item" data-keywords="preview table columns rows data">
                    <div class="guide-item-title">Preview Table</div>
                    <div class="guide-item-desc">Shows all columns and rows. Scroll horizontally to see all data.
                      Color-coded: blue = campaigns, light blue = ad groups, white = keywords, purple = product
                      targeting.</div>
                  </div>
                  <div class="guide-item" data-keywords="confirm download export execute">
                    <div class="guide-item-title">Confirm & Download</div>
                    <div class="guide-item-desc">After reviewing, click to download the actual .xlsx file. This is the
                      file you upload to Amazon.</div>
                  </div>
                </div>

                <!-- Shortcuts -->
                <div class="guide-section" id="guide-shortcuts" data-keywords="keyboard shortcuts hotkeys keys">
                  <div class="guide-section-title">⌨️ Keyboard Shortcuts</div>
                  <div class="guide-item" data-keywords="escape close modal cancel">
                    <div class="guide-item-title">Escape (Esc)</div>
                    <div class="guide-item-desc">Closes any open modal (Guide, Preview, Copy Rules).</div>
                  </div>
                  <div class="guide-item" data-keywords="question mark help shortcuts">
                    <div class="guide-item-title">? (Question Mark)</div>
                    <div class="guide-item-desc">Opens keyboard shortcuts help.</div>
                  </div>
                </div>

                <!-- Troubleshooting -->
                <div class="guide-section" id="guide-troubleshooting"
                  data-keywords="troubleshooting problems issues errors">
                  <div class="guide-section-title">❓ Troubleshooting</div>
                  <div class="guide-item" data-keywords="no products detected empty campaign name">
                    <div class="guide-item-title">No Products Detected</div>
                    <div class="guide-item-desc">Check your extraction method. If using auto-detect, ensure campaign
                      names have separators (|, -, :). Try "Use full campaign name" as fallback.</div>
                  </div>
                  <div class="guide-item" data-keywords="run analysis disabled button not working">
                    <div class="guide-item-title">Run Analysis Button Disabled</div>
                    <div class="guide-item-desc">Upload at least one Search Term Report (SP or SB). The button enables
                      when files are ready.</div>
                  </div>
                  <div class="guide-item" data-keywords="no keywords found empty results">
                    <div class="guide-item-title">No Keywords Found</div>
                    <div class="guide-item-desc">Your KPI thresholds may be too strict. Try lowering Orders to 1 and
                      increasing ACoS limit.</div>
                  </div>
                  <div class="guide-item" data-keywords="duplicate campaigns renamed warning">
                    <div class="guide-item-title">Campaigns Were Renamed</div>
                    <div class="guide-item-desc">Normal behavior! The tool found existing campaigns with the same name
                      and added a number suffix to avoid duplicates.</div>
                  </div>
                  <div class="guide-item" data-keywords="export failed error console">
                    <div class="guide-item-title">Export Failed</div>
                    <div class="guide-item-desc">Check that dates are valid (today or future). Ensure at least one
                      export type (SP or SBV) is enabled.</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <script>
          /* --- State --- */
          let currentWorkflow = 'harvest'; // Workflow mode: harvest, launch, asin, branded, auto2manual, custom
          let productExtractionConfig = {
            method: 'separator', // separator, fullname, sku, regex, manual
            regexPattern: null,
            manualMapping: {} // { "Campaign Pattern": "Product Name" }
          };
          let kpiProfiles = {
            aggressive: { orders: 1, acos: 40 },
            profit: { orders: 1, acos: 15 },
            launch: { orders: 1 },
            liquidation: {}
          };

          let spRowsRaw = [], spRowsFmt = [], spHeaders = [], spCampaignColName = null;
          let sbRowsRaw = [], sbRowsFmt = [], sbHeaders = [], sbCampaignColName = null;
          let lastGroupedSP = null;
          let lastGroupedSB = null;
          let harvestedNegatives = { SP: {}, SB: {} }; // Store negative keywords by product
          let existingCampaignNames = new Set(); // Database of used names
          let productSkuMap = {}; // NEW: Stores extracted SKUs { "Product Name": "SKU" }
          let renamedCampaignsList = []; // Tracks campaigns that were renamed due to duplicates

          /* --- DOM Elements --- */
          const fileInputSP = document.getElementById('fileInputSP');
          const dropZoneSP = document.getElementById('dropZoneSP');
          const fileNameDisplaySP = document.getElementById('fileNameDisplaySP');
          const statusSP = document.getElementById('statusSP');

          const fileInputSB = document.getElementById('fileInputSB');
          const dropZoneSB = document.getElementById('dropZoneSB');
          const fileNameDisplaySB = document.getElementById('fileNameDisplaySB');
          const statusSB = document.getElementById('statusSB');

          const fileInputBulkRef = document.getElementById('fileInputBulkRef');
          const dropZoneBulkRef = document.getElementById('dropZoneBulkRef');
          const fileNameDisplayBulkRef = document.getElementById('fileNameDisplayBulkRef');
          const statusBulkRef = document.getElementById('statusBulkRef');

          const processBtn = document.getElementById('processBtn');
          const resultsEl = document.getElementById('results');
          const resultsSummaryEl = document.getElementById('resultsSummary');
          const productNavEl = document.getElementById('productNav');
          const productRulesContainer = document.getElementById('productRulesContainer');

          const uiSearch = document.getElementById('uiSearch');
          const toggleFinalOnly = document.getElementById('toggleFinalOnly');
          const toggleOnlyFinalProducts = document.getElementById('toggleOnlyFinalProducts');
          const btnExpandAll = document.getElementById('btnExpandAll');
          const btnCollapseAll = document.getElementById('btnCollapseAll');

          // Step 2 & Export Elements
          const bulkCtaWrap = document.getElementById("bulkCtaWrap");
          const btnScrollToBulk = document.getElementById("btnScrollToBulk");
          const bulkStepPanel = document.getElementById('bulkStepPanel');
          const btnGoBulk = document.getElementById('btnGoBulk');
          const bulkExportControls = document.getElementById('bulkExportControls');
          const btnExportBulk = document.getElementById('btnExportBulk');
          const bulkStatus = document.getElementById('bulkStatus');

          const toggleExportSP = document.getElementById('toggleExportSP');
          const toggleExportSBV = document.getElementById('toggleExportSBV');
          const bulkStartDate = document.getElementById('bulkStartDate');
          const bulkState = document.getElementById('bulkState');

          // SBV Enhancements
          const bulkBrandEntityId = document.getElementById('bulkBrandEntityId');
          const bulkPortfolioId = document.getElementById('bulkPortfolioId');
          const bulkBidOpt = document.getElementById('bulkBidOpt');

          // Mode tabs
          const modeOpt1Btn = document.getElementById("modeOpt1Btn");
          const modeOpt2Btn = document.getElementById("modeOpt2Btn");
          const panelOpt1 = document.getElementById("panelOpt1");
          const panelOpt2 = document.getElementById("panelOpt2");

          // Option 1 inputs
          const opt1_spCampTpl = document.getElementById("opt1_spCampTpl");
          const opt1_spAgTpl = document.getElementById("opt1_spAgTpl");
          const opt1_spBudget = document.getElementById("opt1_spBudget");
          const opt1_spDefaultBid = document.getElementById("opt1_spDefaultBid");
          const opt1_spBidBroad = document.getElementById("opt1_spBidBroad");
          const opt1_spBidPhrase = document.getElementById("opt1_spBidPhrase");
          const opt1_spBidExact = document.getElementById("opt1_spBidExact");
          const opt1_spBidAsin = document.getElementById("opt1_spBidAsin");
          const opt1_spSkuMap = document.getElementById("opt1_spSkuMap");

          const opt1_sbvCampTpl = document.getElementById("opt1_sbvCampTpl");
          const opt1_sbvAgTpl = document.getElementById("opt1_sbvAgTpl");
          const opt1_sbvVideo = document.getElementById("opt1_sbvVideo");
          const opt1_sbvBudget = document.getElementById("opt1_sbvBudget");
          const opt1_sbvBid = document.getElementById("opt1_sbvBid");

          // SBV Split Bids (New)
          const opt1_sbvBidBroad = document.getElementById("opt1_sbvBidBroad");
          const opt1_sbvBidPhrase = document.getElementById("opt1_sbvBidPhrase");
          const opt1_sbvBidExact = document.getElementById("opt1_sbvBidExact");

          // Option 2 UI
          const opt2_productList = document.getElementById("opt2_productList");
          const opt2_nameBase = document.getElementById("opt2_nameBase");
          const opt2_spBudget = document.getElementById("opt2_spBudget");
          const opt2_spSku = document.getElementById("opt2_spSku");
          const opt2_bidBroad = document.getElementById("opt2_bidBroad");
          const opt2_bidPhrase = document.getElementById("opt2_bidPhrase");
          const opt2_bidExact = document.getElementById("opt2_bidExact");
          const opt2_sbvVideo = document.getElementById("opt2_sbvVideo");
          const opt2_sbvBudget = document.getElementById("opt2_sbvBudget");
          const opt2_sbvBid = document.getElementById("opt2_sbvBid");
          const opt2_sbvAsin = document.getElementById("opt2_sbvAsin");
          const opt2_saveProfile = document.getElementById("opt2_saveProfile");
          const opt2_saveHint = document.getElementById("opt2_saveHint");

          // Suggestions DOM elements
          const btnExportSuggestionsXlsx = document.getElementById('btnExportSuggestionsXlsx');
          const btnExportSuggestionsCsv = document.getElementById('btnExportSuggestionsCsv');
          const btnCopySuggestions = document.getElementById('btnCopySuggestions');
          const suggestionsBar = document.getElementById('suggestionsBar');
          const toastEl = document.getElementById('toast');

          /* --- Event Listeners --- */
          dropZoneSP.addEventListener('click', () => fileInputSP.click());
          dropZoneSP.addEventListener('dragover', (e) => { e.preventDefault(); dropZoneSP.classList.add('dragover'); });
          dropZoneSP.addEventListener('dragleave', () => dropZoneSP.classList.remove('dragover'));
          dropZoneSP.addEventListener('drop', (e) => { e.preventDefault(); dropZoneSP.classList.remove('dragover'); if (e.dataTransfer.files.length) handleFileGeneric(e.dataTransfer.files[0], "SP"); });
          fileInputSP.addEventListener('change', (e) => { if (e.target.files.length) handleFileGeneric(e.target.files[0], "SP"); });

          dropZoneSB.addEventListener('click', () => fileInputSB.click());
          dropZoneSB.addEventListener('dragover', (e) => { e.preventDefault(); dropZoneSB.classList.add('dragover'); });
          dropZoneSB.addEventListener('dragleave', () => dropZoneSB.classList.remove('dragover'));
          dropZoneSB.addEventListener('drop', (e) => { e.preventDefault(); dropZoneSB.classList.remove('dragover'); if (e.dataTransfer.files.length) handleFileGeneric(e.dataTransfer.files[0], "SB"); });
          fileInputSB.addEventListener('change', (e) => { if (e.target.files.length) handleFileGeneric(e.target.files[0], "SB"); });

          // NEW: Bulk Reference File Listeners
          dropZoneBulkRef.addEventListener('click', () => fileInputBulkRef.click());
          dropZoneBulkRef.addEventListener('dragover', (e) => { e.preventDefault(); dropZoneBulkRef.classList.add('dragover'); });
          dropZoneBulkRef.addEventListener('dragleave', () => dropZoneBulkRef.classList.remove('dragover'));
          dropZoneBulkRef.addEventListener('drop', (e) => { e.preventDefault(); dropZoneBulkRef.classList.remove('dragover'); if (e.dataTransfer.files.length) handleRefFile(e.dataTransfer.files[0]); });
          fileInputBulkRef.addEventListener('change', (e) => { if (e.target.files.length) handleRefFile(e.target.files[0]); });

          processBtn.addEventListener('click', () => {
            resultsEl.innerHTML = "";
            resultsSummaryEl.textContent = "";
            if (spRowsRaw.length) processSingleReport("SP");
            if (sbRowsRaw.length) processSingleReport("SB");

            // Reveal Step 2 + CTA
            bulkStepPanel.classList.remove("hidden");
            bulkCtaWrap.classList.remove("hidden");

            setBulkMode("opt1");
            const products = getAllProductsFromLastResults();
            buildOpt1SkuMapUI(products);
            buildOpt2ProductListUI(products);

            // --- NEW: Run Smart Bid Calculations ---
            updateSmartBids();

            // Advance to step 3
            checkStepProgress();

            // Scroll to results after a brief delay
            setTimeout(() => {
              const firstResult = document.querySelector('.prod-card');
              if (firstResult) {
                firstResult.scrollIntoView({ behavior: 'smooth', block: 'start' });
              }
            }, 300);
          });

          btnGoBulk.addEventListener("click", () => {
            bulkExportControls.classList.remove("hidden");
            btnGoBulk.classList.add("hidden");
            checkStepProgress();
          });
          btnScrollToBulk.addEventListener("click", () => { const el = document.getElementById("bulkStepPanel"); if (el) el.scrollIntoView({ behavior: "smooth", block: "start" }); });
          btnExportBulk.addEventListener("click", () => { try { showBulkPreview(); } catch (e) { console.error(e); if (bulkStatus) bulkStatus.textContent = "Preview failed. Check console."; } });

          uiSearch.addEventListener('input', applyUiFilters);
          toggleFinalOnly.addEventListener('change', applyUiFilters);
          toggleOnlyFinalProducts.addEventListener('change', applyUiFilters);
          btnExpandAll.addEventListener('click', () => setAllDetails(true));
          btnCollapseAll.addEventListener('click', () => setAllDetails(false));

          // Negative keywords toggle
          const toggleGenerateNegatives = document.getElementById('toggleGenerateNegatives');
          const negativeCriteriaPanel = document.getElementById('negativeCriteriaPanel');
          if (toggleGenerateNegatives && negativeCriteriaPanel) {
            toggleGenerateNegatives.addEventListener('change', () => {
              negativeCriteriaPanel.style.display = toggleGenerateNegatives.checked ? 'block' : 'none';
            });
          }

          // Suggestions actions
          btnExportSuggestionsXlsx.addEventListener('click', () => {
            try { exportSuggestionsXlsx(); } catch (e) { console.error(e); showToast("Export failed. Check console."); }
          });
          btnExportSuggestionsCsv.addEventListener('click', () => {
            try { exportSuggestionsCsv(); } catch (e) { console.error(e); showToast("Export failed. Check console."); }
          });
          btnCopySuggestions.addEventListener('click', async () => {
            try { await copyAllSuggestionsToClipboard(); } catch (e) { console.error(e); showToast("Copy failed. Check console."); }
          });


          /* --- Bulk Settings State & Helpers --- */
          let bulkMode = "opt1"; // "opt1" or "opt2"
          const productProfiles = {};
          let opt2_selectedProduct = null;

          function setBulkMode(mode) {
            bulkMode = mode;
            const is1 = mode === "opt1";
            panelOpt1.classList.toggle("hidden", !is1);
            panelOpt2.classList.toggle("hidden", is1);

            modeOpt1Btn.style.borderColor = is1 ? "#c7d2fe" : "";
            modeOpt1Btn.style.background = is1 ? "#eef2ff" : "white";
            modeOpt1Btn.style.color = is1 ? "var(--primary)" : "var(--text-main)";

            modeOpt2Btn.style.borderColor = !is1 ? "#c7d2fe" : "";
            modeOpt2Btn.style.background = !is1 ? "#eef2ff" : "white";
            modeOpt2Btn.style.color = !is1 ? "var(--primary)" : "var(--text-main)";
          }

          modeOpt1Btn.addEventListener("click", () => setBulkMode("opt1"));
          modeOpt2Btn.addEventListener("click", () => setBulkMode("opt2"));

          function applyTemplate(tpl, vars) {
            let s = (tpl || "").toString();
            Object.entries(vars || {}).forEach(([k, v]) => {
              const val = (v ?? "").toString();
              s = s.replaceAll(`{${k}}`, val);
            });
            return s.replace(/\s+/g, " ").trim();
          }

          function numVal(el, fallback) { const n = parseFloat((el?.value ?? "").toString().trim()); return isNaN(n) ? fallback : n; }
          function strVal(el, fallback) { const s = (el?.value ?? "").toString().trim(); return s ? s : fallback; }

          function toggleModifierInput() {
            const strat = document.getElementById('spBidStrategy')?.value;
            const wrap = document.getElementById('bidModifierWrap');
            if (wrap) wrap.style.display = (strat === 'sourceCpc') ? 'block' : 'none';
          }

          // --- Keyword Bid Editor State ---
          let savedCustomBids = { sp: {}, sbv: {} }; // Saved custom bids { 'product|keyword|match': bid }
          let pendingBidEdits = { sp: {}, sbv: {} }; // Unsaved pending edits
          let bidEditorData = { sp: [], sbv: [] }; // All keywords data for editors

          // Toggle bid editor panel
          function toggleBidEditor(type) {
            const panel = document.getElementById(`${type}BidEditorPanel`);
            const chevron = document.getElementById(`${type}BidEditorChevron`);

            if (panel.style.display === 'none') {
              panel.style.display = 'block';
              chevron.textContent = '▼';
              populateBidEditor(type);
            } else {
              panel.style.display = 'none';
              chevron.textContent = '▶';
            }
          }

          // Populate bid editor with keywords from analysis
          function populateBidEditor(type) {
            const tableEl = document.getElementById(`${type}BidEditorTable`);
            const filterProductEl = document.getElementById(`${type}BidFilterProduct`);
            const grouped = (type === 'sp') ? lastGroupedSP : lastGroupedSB;

            if (!grouped || Object.keys(grouped).length === 0) {
              tableEl.innerHTML = '<div style="padding:20px; text-align:center; color:#94a3b8; font-size:12px;">Run analysis to see keywords</div>';
              return;
            }

            // Build data array
            const data = [];
            const buckets = (type === 'sp') ? ['Broad', 'Phrase', 'Exact', 'ASIN'] : ['Broad', 'Phrase', 'Exact'];
            const modifierPct = parseFloat(document.getElementById(`${type}BidModifier`)?.value || "0");
            const modifierMult = 1 + (modifierPct / 100);

            Object.keys(grouped).sort().forEach(product => {
              buckets.forEach(bucket => {
                const finals = grouped[product]?.[bucket]?.final || [];
                finals.forEach(row => {
                  const keyword = (row["Suggested Value"] || row["Customer Search Term"] || "").toString().trim();
                  if (!keyword) return;

                  // Get source CPC from Extra KPIs
                  const kpis = row["Extra KPIs"] || {};
                  let sourceCpc = toNum(kpis["CPC"]);
                  if (isNaN(sourceCpc) || sourceCpc <= 0) {
                    const spend = toNum(kpis["Spend"]);
                    const clicks = toNum(kpis["Clicks"]);
                    if (!isNaN(spend) && !isNaN(clicks) && clicks > 0) {
                      sourceCpc = spend / clicks;
                    }
                  }
                  if (isNaN(sourceCpc) || sourceCpc <= 0) {
                    // Use fallback bid
                    sourceCpc = (type === 'sp') ? spBidForBucket(bucket) : sbvBidForBucket(bucket);
                  }

                  // Calculate bid with modifier
                  const calculatedBid = (sourceCpc * modifierMult).toFixed(2);

                  // Check if custom bid exists
                  const key = `${product}|${keyword}|${bucket}`;
                  const savedBid = savedCustomBids[type][key];
                  const currentBid = savedBid !== undefined ? savedBid : calculatedBid;

                  data.push({
                    product,
                    keyword,
                    matchType: bucket === 'ASIN' ? 'PT' : bucket,
                    sourceCpc: sourceCpc.toFixed(2),
                    calculatedBid,
                    currentBid,
                    key,
                    isCustom: savedBid !== undefined
                  });
                });
              });
            });

            bidEditorData[type] = data;

            // Populate product filter dropdown
            const products = [...new Set(data.map(d => d.product))].sort();
            filterProductEl.innerHTML = '<option value="">All Products</option>';
            products.forEach(p => {
              filterProductEl.innerHTML += `<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`;
            });

            // Update count
            const countEl = document.getElementById(`${type}BidEditorCount`);
            if (countEl) {
              countEl.textContent = `(${data.length} keywords)`;
            }

            // Render table
            renderBidEditorTable(type);
          }

          // Render the bid editor table with current filters
          function renderBidEditorTable(type) {
            const tableEl = document.getElementById(`${type}BidEditorTable`);
            const filterProduct = document.getElementById(`${type}BidFilterProduct`)?.value || '';
            const filterMatch = document.getElementById(`${type}BidFilterMatch`)?.value || '';

            let data = bidEditorData[type] || [];

            // Apply filters
            if (filterProduct) {
              data = data.filter(d => d.product === filterProduct);
            }
            if (filterMatch) {
              data = data.filter(d => d.matchType === filterMatch);
            }

            if (data.length === 0) {
              tableEl.innerHTML = '<div style="padding:20px; text-align:center; color:#94a3b8; font-size:12px;">No keywords match filters</div>';
              return;
            }

            let html = `
        <table style="width:100%; font-size:11px; border-collapse:collapse;">
          <thead style="position:sticky; top:0; background:#f8fafc;">
            <tr>
              <th style="padding:8px 6px; text-align:left; border-bottom:1px solid #e2e8f0; font-weight:600; color:#64748b;">Product</th>
              <th style="padding:8px 6px; text-align:left; border-bottom:1px solid #e2e8f0; font-weight:600; color:#64748b;">Keyword</th>
              <th style="padding:8px 6px; text-align:center; border-bottom:1px solid #e2e8f0; font-weight:600; color:#64748b;">Match</th>
              <th style="padding:8px 6px; text-align:right; border-bottom:1px solid #e2e8f0; font-weight:600; color:#64748b;">CPC</th>
              <th style="padding:8px 6px; text-align:right; border-bottom:1px solid #e2e8f0; font-weight:600; color:#64748b;">Bid</th>
            </tr>
          </thead>
          <tbody>
      `;

            data.forEach((item, idx) => {
              const pending = pendingBidEdits[type][item.key];
              const displayBid = pending !== undefined ? pending : item.currentBid;
              const isPending = pending !== undefined && pending !== item.currentBid;
              const isCustom = item.isCustom || isPending;
              const rowBg = isPending ? '#fef3c7' : (isCustom ? '#ecfdf5' : 'white');

              html += `
          <tr style="background:${rowBg};">
            <td style="padding:6px; border-bottom:1px solid #f1f5f9; max-width:100px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="${escapeHtml(item.product)}">${escapeHtml(item.product)}</td>
            <td style="padding:6px; border-bottom:1px solid #f1f5f9; max-width:150px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="${escapeHtml(item.keyword)}">${escapeHtml(item.keyword)}</td>
            <td style="padding:6px; border-bottom:1px solid #f1f5f9; text-align:center;">
              <span style="padding:2px 6px; border-radius:4px; font-size:10px; font-weight:600; background:${getMatchColor(item.matchType)}; color:white;">${item.matchType}</span>
            </td>
            <td style="padding:6px; border-bottom:1px solid #f1f5f9; text-align:right; color:#64748b;">$${item.sourceCpc}</td>
            <td style="padding:6px; border-bottom:1px solid #f1f5f9; text-align:right;">
              <input type="number" step="0.01" min="0.02" value="${displayBid}" 
                style="width:60px; padding:4px; border:1px solid ${isPending ? '#fbbf24' : '#e2e8f0'}; border-radius:4px; text-align:right; font-size:11px;"
                onchange="updatePendingBid('${type}', '${escapeHtml(item.key)}', this.value)"
                title="Original: $${item.calculatedBid}">
            </td>
          </tr>
        `;
            });

            html += '</tbody></table>';
            tableEl.innerHTML = html;

            updateBidEditorStatus(type);
          }

          // Get color for match type badge
          function getMatchColor(matchType) {
            switch (matchType) {
              case 'Broad': return '#f59e0b';
              case 'Phrase': return '#3b82f6';
              case 'Exact': return '#10b981';
              case 'PT': return '#8b5cf6';
              default: return '#64748b';
            }
          }

          // Update pending bid when user edits
          function updatePendingBid(type, key, value) {
            const bid = parseFloat(value);
            if (!isNaN(bid) && bid >= 0.02) {
              pendingBidEdits[type][key] = bid.toFixed(2);
            } else {
              delete pendingBidEdits[type][key];
            }
            updateBidEditorStatus(type);
          }

          // Update status showing pending changes
          function updateBidEditorStatus(type) {
            const statusEl = document.getElementById(`${type}BidEditorStatus`);
            const pendingCount = Object.keys(pendingBidEdits[type]).length;
            const savedCount = Object.keys(savedCustomBids[type]).length;

            let status = '';
            if (pendingCount > 0) {
              status = `⚠️ ${pendingCount} unsaved changes`;
            } else if (savedCount > 0) {
              status = `✅ ${savedCount} custom bids saved`;
            }

            if (statusEl) statusEl.textContent = status;
          }

          // Save pending bid edits
          function saveBidEdits(type) {
            const pendingCount = Object.keys(pendingBidEdits[type]).length;

            // Merge pending into saved
            Object.keys(pendingBidEdits[type]).forEach(key => {
              savedCustomBids[type][key] = pendingBidEdits[type][key];
            });

            // Clear pending
            pendingBidEdits[type] = {};

            // Save to session
            saveCustomBidsToSession();

            // Re-render
            renderBidEditorTable(type);

            if (pendingCount > 0) {
              showToast(`✅ ${pendingCount} custom bids saved for ${type.toUpperCase()}`);
            }
          }

          // Cancel pending bid edits
          function cancelBidEdits(type) {
            pendingBidEdits[type] = {};
            renderBidEditorTable(type);
            showToast('Changes cancelled');
          }

          // Filter bid editor
          function filterBidEditor(type) {
            renderBidEditorTable(type);
          }

          // Save custom bids to localStorage
          function saveCustomBidsToSession() {
            try {
              localStorage.setItem('termHarvester_customBids', JSON.stringify(savedCustomBids));
            } catch (e) {
              console.warn('Failed to save custom bids:', e);
            }
          }

          // Load custom bids from localStorage
          function loadCustomBidsFromSession() {
            try {
              const saved = localStorage.getItem('termHarvester_customBids');
              if (saved) {
                savedCustomBids = JSON.parse(saved);
              }
            } catch (e) {
              console.warn('Failed to load custom bids:', e);
            }
          }

          // Update bid editor counts after analysis
          function updateBidEditorCounts() {
            // SP
            const spCount = countKeywordsForType('sp');
            const spCountEl = document.getElementById('spBidEditorCount');
            if (spCountEl) {
              spCountEl.textContent = spCount > 0 ? `(${spCount} keywords)` : '(Run analysis first)';
            }

            // SBV
            const sbvCount = countKeywordsForType('sbv');
            const sbvCountEl = document.getElementById('sbvBidEditorCount');
            if (sbvCountEl) {
              sbvCountEl.textContent = sbvCount > 0 ? `(${sbvCount} keywords)` : '(Run analysis first)';
            }
          }

          function countKeywordsForType(type) {
            const grouped = (type === 'sp') ? lastGroupedSP : lastGroupedSB;
            if (!grouped) return 0;

            let count = 0;
            const buckets = (type === 'sp') ? ['Broad', 'Phrase', 'Exact', 'ASIN'] : ['Broad', 'Phrase', 'Exact'];

            Object.values(grouped).forEach(prodObj => {
              buckets.forEach(bucket => {
                count += (prodObj[bucket]?.final || []).length;
              });
            });

            return count;
          }

          // Get bid for a specific keyword (used during export)
          function getCustomBidForKeyword(type, product, keyword, matchType, defaultBid) {
            const key = `${product}|${keyword}|${matchType}`;
            const customBid = savedCustomBids[type]?.[key];
            return customBid !== undefined ? parseFloat(customBid) : defaultBid;
          }

          // Initialize - load custom bids on page load
          loadCustomBidsFromSession();


          function formatTodayYYYYMMDD() {
            const d = new Date();
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${y}${m}${day}`;
          }

          function formatTodayISO() {
            const d = new Date();
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${y}-${m}-${day}`;
          }

          function isValidYYYYMMDD(v) {
            return /^\d{8}$/.test((v || "").toString().trim());
          }

          function isPastDateYYYYMMDD(v) {
            if (!isValidYYYYMMDD(v)) return false;
            const y = Number(v.slice(0, 4));
            const m = Number(v.slice(4, 6)) - 1;
            const d = Number(v.slice(6, 8));
            const input = new Date(y, m, d);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            input.setHours(0, 0, 0, 0);
            return input < today;
          }

          function validateDateInput() {
            const dateInput = document.getElementById('bulkStartDate');
            const errorDiv = document.getElementById('dateError');
            const errorText = document.getElementById('dateErrorText');

            if (!dateInput) return true;

            const value = dateInput.value;
            if (!value) {
              dateInput.classList.add('error');
              dateInput.classList.remove('success');
              errorDiv.classList.remove('hidden');
              errorText.textContent = 'Start date is required';
              return false;
            }

            const selectedDate = new Date(value + 'T00:00:00');
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            if (selectedDate < today) {
              dateInput.classList.add('error');
              dateInput.classList.remove('success');
              errorDiv.classList.remove('hidden');
              errorText.textContent = 'Date cannot be in the past. Amazon will reject this.';
              return false;
            }

            // Valid date
            dateInput.classList.remove('error');
            dateInput.classList.add('success');
            errorDiv.classList.add('hidden');
            return true;
          }

          // Add real-time validation listener
          if (document.getElementById('bulkStartDate')) {
            document.getElementById('bulkStartDate').addEventListener('change', validateDateInput);
            document.getElementById('bulkStartDate').addEventListener('blur', validateDateInput);

            // Set default to today
            document.getElementById('bulkStartDate').value = formatTodayISO();
            // Set min attribute to today
            document.getElementById('bulkStartDate').setAttribute('min', formatTodayISO());
          }

          function chunkArray(arr, size) {
            const n = Math.max(1, parseInt(size || 1, 10));
            const out = [];
            for (let i = 0; i < arr.length; i += n) out.push(arr.slice(i, i + n));
            return out;
          }
          function getAllProductsFromLastResults() {
            const set = new Set();
            [lastGroupedSP, lastGroupedSB].forEach(g => {
              if (!g) return;
              Object.keys(g).forEach(p => set.add(p));
            });
            return Array.from(set).filter(Boolean).sort();
          }

          /* --- UPDATED: SKU Mapper (Auto-Fills from Bulk File) --- */
          function buildOpt1SkuMapUI(products) {
            opt1_spSkuMap.innerHTML = "";
            if (!products.length) {
              opt1_spSkuMap.innerHTML = `<div style="font-size:11px; color:var(--text-muted); font-style:italic;">No products detected.</div>`;
              return;
            }

            products.forEach(p => {
              const row = document.createElement("div");
              row.style.cssText = "display:flex; gap:8px; align-items:center; margin-bottom:8px;";

              // CHECK MEMORY: Do we have an SKU for this product?
              const autoSku = productSkuMap[p] || "";
              const style = autoSku ? "background:#f0fdf4; border-color:#bbf7d0; color:#15803d; font-weight:700;" : "";
              const icon = autoSku ? `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#15803d" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg>` : "";

              row.innerHTML = `
            <div style="flex:1; font-size:12px; font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; display:flex; align-items:center; gap:4px;">
                ${escapeHtml(p)} ${icon}
            </div> <input class="form-input" 
                   style="width:160px; ${style}" 
                   data-sku-product="${escapeHtml(p)}" 
                   placeholder="SKU" 
                   value="${autoSku}" 
                   title="${autoSku ? 'Auto-detected from Step 1 file' : 'Enter manually'}" />
        `;
              opt1_spSkuMap.appendChild(row);
            });

            // Show helpful message if SKUs were detected
            const detectedCount = Object.keys(productSkuMap).length;
            if (detectedCount > 0) {
              const msg = document.createElement("div");
              msg.style.cssText = "font-size:11px; color:#15803d; background:#f0fdf4; padding:8px; border-radius:6px; margin-top:8px; border:1px solid #bbf7d0;";
              msg.innerHTML = `✅ <b>${detectedCount} SKU${detectedCount > 1 ? 's' : ''}</b> auto-filled from Step 1 file. Edit if needed.`;
              opt1_spSkuMap.appendChild(msg);
            }
          }

          function buildOpt2ProductListUI(products) {
            opt2_productList.innerHTML = "";
            if (!products.length) { opt2_productList.innerHTML = `<div style="font-size:11px; color:var(--text-muted); font-style:italic;">No products detected.</div>`; return; }
            products.forEach((p, idx) => {
              const item = document.createElement("div");
              item.className = "nav-item";
              item.style.border = "1px solid var(--border)";
              item.style.background = "white";
              item.innerHTML = `<div class="nav-item-name">${escapeHtml(p)}</div><div class="nav-badges"><span class="status-pill" style="background:#eef2ff;color:var(--primary);border:1px solid #c7d2fe;">Edit</span></div>`;
              item.onclick = () => loadOpt2Profile(p);
              opt2_productList.appendChild(item);
              if (idx === 0 && !opt2_selectedProduct) loadOpt2Profile(p);
            });
          }

          function loadOpt2Profile(product) {
            opt2_selectedProduct = product;
            const prof = productProfiles[product] || {
              nameBase: product,
              spBudget: numVal(opt1_spBudget, 100),
              spSku: "",
              bidBroad: numVal(opt1_spBidBroad, 0.6),
              bidPhrase: numVal(opt1_spBidPhrase, 0.75),
              bidExact: numVal(opt1_spBidExact, 0.95),
              sbvVideo: strVal(opt1_sbvVideo, "amzn1.assetlibrary..."),
              sbvAsin: "",
              sbvBudget: numVal(opt1_sbvBudget, 50),
              sbvBid: numVal(opt1_sbvBid, 0.8),
            };
            opt2_nameBase.value = prof.nameBase;
            opt2_spBudget.value = prof.spBudget;
            opt2_spSku.value = prof.spSku;
            opt2_bidBroad.value = prof.bidBroad;
            opt2_bidPhrase.value = prof.bidPhrase;
            opt2_bidExact.value = prof.bidExact;
            opt2_sbvVideo.value = prof.sbvVideo;
            opt2_sbvAsin.value = prof.sbvAsin || "";
            opt2_sbvBudget.value = prof.sbvBudget;
            opt2_sbvBid.value = prof.sbvBid;
            opt2_saveHint.textContent = `Editing: ${product}`;
          }

          opt2_saveProfile.addEventListener("click", () => {
            if (!opt2_selectedProduct) return;
            productProfiles[opt2_selectedProduct] = {
              nameBase: strVal(opt2_nameBase, opt2_selectedProduct),
              spBudget: numVal(opt2_spBudget, 100),
              spSku: strVal(opt2_spSku, ""),
              bidBroad: numVal(opt2_bidBroad, 0.6),
              bidPhrase: numVal(opt2_bidPhrase, 0.75),
              bidExact: numVal(opt2_bidExact, 0.95),
              sbvVideo: strVal(opt2_sbvVideo, "amzn1.assetlibrary..."),
              sbvAsin: strVal(opt2_sbvAsin, ""),
              sbvBudget: numVal(opt2_sbvBudget, 50),
              sbvBid: numVal(opt2_sbvBid, 0.8),
            };
            opt2_saveHint.textContent = `Saved profile for: ${opt2_selectedProduct}`;
          });

          /* --- Helper: UI Feedback --- */
          function setStatus(which, msg, type) {
            const el = (which === "SP") ? statusSP : statusSB;
            el.textContent = msg;
            el.className = type === 'error' ? 'text-red' : 'text-green';
          }

          /* --- Helper: Logic --- */
          function findColumn(headers, containsTextArray) { const lowerHeaders = headers.map(h => h.toLowerCase()); for (let i = 0; i < headers.length; i++) { const h = lowerHeaders[i]; let ok = true; for (const txt of containsTextArray) { if (!h.includes(txt.toLowerCase())) { ok = false; break; } } if (ok) return headers[i]; } return null; }
          function pickKpiColumns(headers) { const H = (headers || []).map(h => (h ?? "").toString()); const find = (regexList) => H.find(h => regexList.some(rx => rx.test(h))); return { "Impressions": find([/^impressions$/i, /\bimpressions\b/i]), "Clicks": find([/^clicks?$/i, /\bclicks?\b/i]), "CTR": find([/click-thru rate/i, /\bctr\b/i]), "CPC": find([/cost per click/i, /\(cpc\)/i, /\bcpc\b/i]), "Spend": find([/^spend$/i, /\bspend\b/i]), "Sales": find([/^7\s*day\s*total\s*sales/i, /\btotal sales\b/i]), "Orders": find([/^7\s*day\s*total\s*orders/i, /\btotal orders\b/i]), "ACoS": find([/total advertising cost of sales/i, /\bacos\b/i]), "ROAS": find([/total return on advertising spend/i, /\broas\b/i]), "Conversion Rate": find([/7\s*day\s*conversion\s*rate/i, /conversion rate/i]) }; }
          /* --- ENHANCED: Configurable Product Name Extractor --- */
          function extractProductName(campaignName) {
            const c = (campaignName || "").toString().trim();
            if (!c) return "Unknown Product";

            const method = productExtractionConfig.method;

            switch (method) {
              case 'fullname':
                // Use the complete campaign name as product identifier
                return c;

              case 'sku':
                // Extract SKU pattern (e.g., "BR549-Broad" → "BR549")
                const skuMatch = c.match(/^([A-Z0-9-]+)/);
                return skuMatch ? skuMatch[1] : c;

              case 'regex':
                // User-defined regex pattern
                if (productExtractionConfig.regexPattern) {
                  try {
                    const regex = new RegExp(productExtractionConfig.regexPattern);
                    const match = c.match(regex);
                    if (match && match[1]) return match[1].trim();
                  } catch (e) {
                    console.error('Invalid regex pattern:', e);
                  }
                }
                // Fallback to separator method if regex fails
                return extractBySeparator(c);

              case 'manual':
                // Check manual mapping
                for (const [pattern, productName] of Object.entries(productExtractionConfig.manualMapping)) {
                  if (c.includes(pattern)) {
                    return productName;
                  }
                }
                // Fallback to separator method if no match found
                return extractBySeparator(c);

              case 'separator':
              default:
                // Auto-detect using standard separators
                return extractBySeparator(c);
            }
          }

          // Helper: Extract by separator (original logic)
          function extractBySeparator(c) {
            // 1. Try Standard Separators (Priority Order)
            // "Product Name | Match | ..."
            if (c.includes("|")) return c.split("|")[0].trim();

            // "Product Name - Match - ..." (Space-Dash-Space is safer than just Dash)
            if (c.includes(" - ")) return c.split(" - ")[0].trim();

            // "Product Name: Match"
            if (c.includes(": ")) return c.split(": ")[0].trim();

            // 2. Fallback: No clear separator? 
            // Use the FULL Campaign Name. This groups terms by their source campaign,
            // which is the safest universal behavior for messy accounts.
            return c;
          }
          function normalizeAcosToPercent(acosRaw) { if (acosRaw === undefined || acosRaw === null || acosRaw === "") return NaN; let cleaned = acosRaw.toString().replace("%", "").replace(/,/g, "").trim(); if (cleaned === "") return NaN; let val = parseFloat(cleaned); if (isNaN(val)) return NaN; if (val > 0 && val <= 1) val = val * 100; return val; }
          function countWords(term) { const t = (term || "").toString().trim(); if (!t) return 0; return t.split(/\s+/).filter(Boolean).length; }
          function normalizeKeyword(text) { return (text || "").toString().trim().toLowerCase().replace(/\s+/g, " "); }
          function normalizeMatchTypeToBucket(matchTypeRaw) { const t = (matchTypeRaw || "").toString().trim().toLowerCase(); if (!t) return ""; if (t.includes("exact")) return "Exact"; if (t.includes("phrase")) return "Phrase"; if (t.includes("broad")) return "Broad"; return ""; }
          function extractAsinExpanded(targetingText) { const t = (targetingText || "").toString(); const m = t.match(/asin-expanded\s*=\s*"?([bB]0[a-zA-Z0-9]{8})"?/); return m ? m[1].toUpperCase() : ""; }
          function extractAsinDirect(targetingText) { const t = (targetingText || "").toString(); const m = t.match(/asin\s*=\s*"?([a-zA-Z0-9]{10})"?/); return m ? m[1].toUpperCase() : ""; }
          function isAsinLike(text) { const t = (text || "").toString().trim(); return /^[bB][0-9][a-zA-Z0-9]{8}$/.test(t); }
          function getKeywordBucketsByWordCount(customerSearchTerm) { const w = countWords(customerSearchTerm); const buckets = []; if (w >= 1 && w <= 2) buckets.push("Broad"); if (w >= 2 && w <= 3) buckets.push("Phrase"); if (w >= 3) buckets.push("Exact"); return buckets; }
          function cssSafeId(text) { return (text || "").toString().replace(/[^a-zA-Z0-9\-_]/g, "_"); }
          function setAllDetails(open) { document.querySelectorAll("details").forEach(d => d.open = open); document.querySelectorAll('[data-bucket-content]').forEach(div => { div.style.display = open ? "" : "none"; const header = div.previousElementSibling; if (header && header.classList.contains("matchHeader")) { const chevron = header.querySelector(".matchChevron"); if (chevron) chevron.textContent = open ? "▼" : "▶"; } }); }
          function escapeHtml(str) { return (str || "").toString().replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;").replaceAll('"', "&quot;").replaceAll("'", "&#039;"); }
          function getTargetingDisplay(targetingRaw) { const t = (targetingRaw || "").toString().trim(); const exp = t.match(/asin-expanded\s*=\s*"?([bB]0[a-zA-Z0-9]{8})"?/); if (exp) return { label: "Targeting ASIN Expanded", value: exp[1].toUpperCase() }; const direct = t.match(/asin\s*=\s*"?([a-zA-Z0-9]{10})"?/); if (direct) return { label: "Targeting ASIN (Exact)", value: direct[1].toUpperCase() }; return { label: "Targeting Keyword", value: t }; }
          function getSourceMatchTypeDisplay(row) { const srcType = (row["Suggestion Source Type"] || "").toString().toLowerCase(); const raw = (row["Source Match Type"] || "").toString().trim(); if (srcType.includes("asin-expanded") && (!raw || raw === "-")) return "ASIN Expanded"; return raw || "-"; }

          /* --- Robust Number Parser (Fixes "No Data" for non-$ currencies) --- */
          function toNum(x) {
            if (x === undefined || x === null || x === "") return NaN;
            let s = x.toString();

            // 1. Remove commas (thousands separators)
            s = s.replace(/,/g, "");

            // 2. Remove all non-numeric characters EXCEPT the dot (.) and minus (-)
            // This strips 'Rs.', 'PKR', '£', '$', spaces, etc.
            s = s.replace(/[^0-9.-]/g, "");

            const n = parseFloat(s);
            return isNaN(n) ? NaN : n;
          }
          function fmtInt(x) { const n = toNum(x); if (isNaN(n)) return (x === "" || x == null) ? "-" : x.toString(); return Math.round(n).toLocaleString(); }
          function fmtPct(x) { if (x === undefined || x === null || x === "") return "-"; const rawStr = x.toString().trim(); if (rawStr.includes("%")) { const n = toNum(rawStr); if (isNaN(n)) return rawStr; return n.toFixed(2) + "%"; } const n = toNum(x); if (isNaN(n)) return rawStr; let pct = n; if (n > 0 && n <= 1) pct = n * 100; return pct.toFixed(2) + "%"; }
          function fmtMoney2(x) { const n = toNum(x); if (isNaN(n)) return (x === "" || x == null) ? "-" : x.toString(); return n.toFixed(2); }
          function displayKpiValue(v) { if (v === undefined || v === null || v === "") return "-"; const s = v.toString().trim(); if (s.includes("%")) { const num = parseFloat(s.replace(/%/g, "")); if (isNaN(num)) return s; return num.toFixed(2) + "%"; } const n = parseFloat(s.replace(/,/g, "")); if (!isNaN(n)) { if (Number.isInteger(n)) return n.toLocaleString(); return n.toFixed(2); } return s; }

          /* --- Feature: Smart Avg CPC Calculation (With Fallback) --- */
          function updateSmartBids() {
            // Helper to calculate avg cpc for a specific bucket across all products
            const calc = (groupedData, bucketName) => {
              if (!groupedData) return null;
              let totalCpc = 0;
              let count = 0;

              Object.values(groupedData).forEach(prodObj => {
                // Look at FINAL terms only
                const rows = prodObj[bucketName]?.final || [];
                rows.forEach(r => {
                  const kpis = r["Extra KPIs"] || {};

                  // Method 1: Try reading the direct "CPC" column
                  let cpc = toNum(kpis["CPC"]);

                  // Method 2: Fallback (Calculate manually if CPC is missing/invalid)
                  if (isNaN(cpc) || cpc <= 0) {
                    const spend = toNum(kpis["Spend"]);
                    const clicks = toNum(kpis["Clicks"]);
                    if (!isNaN(spend) && !isNaN(clicks) && clicks > 0) {
                      cpc = spend / clicks;
                    }
                  }

                  // If we have a valid number now, add it
                  if (!isNaN(cpc) && cpc > 0) {
                    totalCpc += cpc;
                    count++;
                  }
                });
              });

              if (count === 0) return null;
              return (totalCpc / count).toFixed(2);
            };

            // 1. Sponsored Products (SP)
            const spBuckets = ["Broad", "Phrase", "Exact", "ASIN"];
            spBuckets.forEach(b => {
              const val = calc(lastGroupedSP, b);
              const el = document.getElementById(`hint_sp_${b}`);
              if (el) {
                el.textContent = val ? `Avg CPC: ${val}` : "No data";
                // Visual feedback: Green if data exists, Gray if not
                el.style.color = val ? "#166534" : "#94a3b8";
                el.style.fontWeight = val ? "800" : "500";
                el.style.pointerEvents = val ? "auto" : "none";
              }
            });

            // 2. Sponsored Brands (SB)
            const sbBuckets = ["Broad", "Phrase", "Exact"];
            sbBuckets.forEach(b => {
              const val = calc(lastGroupedSB, b);
              const el = document.getElementById(`hint_sb_${b}`);
              if (el) {
                el.textContent = val ? `Avg CPC: ${val}` : "No data";
                el.style.color = val ? "#166534" : "#94a3b8";
                el.style.fontWeight = val ? "800" : "500";
                el.style.pointerEvents = val ? "auto" : "none";
              }
            });
          }

          /* --- File Handling --- */
          function handleFileGeneric(file, which) {
            if (!file) return;
            const nameEl = (which === "SP") ? fileNameDisplaySP : fileNameDisplaySB;
            nameEl.innerHTML = `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg> ${file.name}`;
            nameEl.style.display = 'flex';
            setStatus(which, "Reading file...", "neutral");

            const reader = new FileReader();
            reader.onload = (event) => {
              try {
                const data = new Uint8Array(event.target.result);
                const wb = XLSX.read(data, { type: 'array' });
                const ws = wb.Sheets[wb.SheetNames[0]];
                const jsonRaw = XLSX.utils.sheet_to_json(ws, { defval: "", raw: true });
                const jsonFmt = XLSX.utils.sheet_to_json(ws, { defval: "", raw: false });

                if (!jsonRaw || !jsonRaw.length) { setStatus(which, "File is empty.", "error"); return; }

                if (which === "SP") {
                  spRowsRaw = jsonRaw;
                  spRowsFmt = jsonFmt;
                  spHeaders = Object.keys(jsonRaw[0] || {});
                  filesUploaded.sp = true;
                }
                else {
                  sbRowsRaw = jsonRaw;
                  sbRowsFmt = jsonFmt;
                  sbHeaders = Object.keys(jsonRaw[0] || {});
                  filesUploaded.sb = true;
                }

                setStatus(which, `Ready: ${jsonRaw.length} rows loaded.`, "success");
                buildProductListAndInputsFromBoth();
                checkStepProgress();
              } catch (e) { console.error(e); setStatus(which, "Error reading file.", "error"); }
            };
            reader.readAsArrayBuffer(file);
          }

          /* --- NEW: Dynamic Rules Engine with Memory & Copy Tools --- */
          let detectedProducts = [];
          let productRulesState = {}; // MEMORY: Prevents inputs from vanishing

          function rebuildProductInputs() {
            if (detectedProducts.length) renderProductRules(detectedProducts);
          }

          function buildProductListAndInputsFromBoth() {
            const allRows = [...(spRowsRaw || []), ...(sbRowsRaw || [])];
            if (!allRows.length) { processBtn.disabled = true; return; }

            if (spRowsRaw.length) spCampaignColName = spHeaders.find(h => h.trim().toLowerCase() === "campaign name") || findColumn(spHeaders, ["campaign"]);
            if (sbRowsRaw.length) sbCampaignColName = sbHeaders.find(h => h.trim().toLowerCase() === "campaign name") || findColumn(sbHeaders, ["campaign"]);

            const set = new Set();
            for (const r of spRowsRaw) { const cn = (r[spCampaignColName] || "").toString(); if (cn) set.add(extractProductName(cn)); }
            for (const r of sbRowsRaw) { const cn = (r[sbCampaignColName] || "").toString(); if (cn) set.add(extractProductName(cn)); }

            detectedProducts = Array.from(set).filter(Boolean).sort();
            renderProductRules(detectedProducts);
            showProductPreview(); // Show preview of detected products

            processBtn.disabled = false;
            processBtn.style.animation = "pulse 2s infinite";
          }

          function renderProductRules(products) {
            const container = productRulesContainer;
            container.innerHTML = "";

            if (!products.length) {
              container.innerHTML = `<div style="font-size:12px; color:#94a3b8; font-style:italic;">No products detected...</div>`;
              return;
            }

            const activeKpis = [];
            document.querySelectorAll('.kpi-check').forEach(c => { if (c.checked) activeKpis.push(c.value); });

            products.forEach(p => {
              const card = document.createElement("div");
              card.style.cssText = "background:#f8fafc; border:1px solid #e2e8f0; border-radius:8px; padding:10px; margin-bottom:10px; position:relative;";

              // Header with Actions
              const header = document.createElement("div");
              header.style.cssText = "display:flex; justify-content:space-between; align-items:start; margin-bottom:8px;";

              const title = document.createElement("div");
              title.style.cssText = "font-size:12px; font-weight:700; color:var(--primary); max-width:45%; word-break:break-word; display:flex; align-items:center; gap:6px;";

              // Count active rules for this product
              const activeRuleCount = Object.keys(productRulesState[p] || {}).filter(k => productRulesState[p][k]).length;
              const badge = activeRuleCount > 0
                ? `<span style="background:#dcfce7; color:#166534; font-size:9px; padding:2px 6px; border-radius:999px; font-weight:700;">${activeRuleCount} rule${activeRuleCount > 1 ? 's' : ''}</span>`
                : '';

              title.innerHTML = `${escapeHtml(p)} ${badge}`;

              // Action Buttons (Apply + Clear)
              const actions = document.createElement("div");
              actions.style.cssText = "display:flex; gap:4px; flex-wrap:wrap; justify-content:flex-end;";
              actions.innerHTML = `
                <div style="display:flex; gap:2px;"> <button onclick="copyRulesToAll('${escapeHtml(p)}')" title="Apply to ALL" style="padding:2px 6px; font-size:10px; cursor:pointer; background:#eef2ff; border:1px solid #c7d2fe; color:#4f46e5; border-radius:4px; font-weight:600;">Apply All</button> <button onclick="openCopyModal('${escapeHtml(p)}')" title="Apply to Specific" style="padding:2px 6px; font-size:10px; cursor:pointer; background:white; border:1px solid #cbd5e1; color:#475569; border-radius:4px; font-weight:600;">Spec...</button> </div> <div style="display:flex; gap:2px;"> <button onclick="clearAllRules('${escapeHtml(p)}')" title="Remove from ALL" style="padding:2px 6px; font-size:10px; cursor:pointer; background:#fef2f2; border:1px solid #fecaca; color:#991b1b; border-radius:4px; font-weight:600;">Rm All</button> <button onclick="openClearModal('${escapeHtml(p)}')" title="Remove from Specific" style="padding:2px 6px; font-size:10px; cursor:pointer; background:white; border:1px solid #e2e8f0; color:#991b1b; border-radius:4px; font-weight:600;">Spec...</button> </div>
            `;

              header.appendChild(title);
              header.appendChild(actions);
              card.appendChild(header);

              // Inputs Grid
              const grid = document.createElement("div");
              grid.style.cssText = "display:grid; grid-template-columns: 1fr 1fr; gap:8px;";

              activeKpis.forEach(kpi => {
                const wrap = document.createElement("div");
                let labelTxt = kpi;
                let placeholder = "0";

                // Labels
                if (kpi === "orders") { labelTxt = "Min Ord"; placeholder = "1"; }
                if (kpi === "acos") { labelTxt = "Max ACoS"; placeholder = "30"; }
                if (kpi === "spend") { labelTxt = "Max Spend"; placeholder = "100"; }
                if (kpi === "clicks") { labelTxt = "Min Clicks"; placeholder = "1"; }
                if (kpi === "cv") { labelTxt = "Min CV%"; placeholder = "5"; }
                if (kpi === "ctr") { labelTxt = "Min CTR%"; placeholder = "0.5"; }

                // RESTORE VALUE FROM MEMORY
                const savedVal = productRulesState[p]?.[kpi] || "";

                wrap.innerHTML = `
                    <div style="font-size:10px; font-weight:600; color:#64748b; margin-bottom:2px;">${labelTxt}</div> <input type="number" step="0.01" class="form-input" 
                           data-product="${escapeHtml(p)}" 
                           data-kpi="${kpi}" 
                           value="${savedVal}"
                           placeholder="${placeholder}" 
                           style="margin-bottom:0; font-size:11px; padding:6px;" />
                `;
                grid.appendChild(wrap);
              });

              card.appendChild(grid);
              container.appendChild(card);
            });

            // Setup input event listener for memory capture
            setupMemoryCapture();
          }

          function setupMemoryCapture() {
            productRulesContainer.querySelectorAll('input[data-product]').forEach(inp => {
              inp.addEventListener('input', (e) => {
                const p = e.target.getAttribute('data-product');
                const k = e.target.getAttribute('data-kpi');
                if (p && k) {
                  if (!productRulesState[p]) productRulesState[p] = {};
                  productRulesState[p][k] = e.target.value;
                }
              });
            });
          }

          /* --- Smart Defaults System --- */
          const defaultKPIValues = {
            orders: 1,
            acos: 30,
            spend: 100,
            clicks: 1,
            cv: 5,
            ctr: 0.5
          };

          function applySmartDefaults() {
            if (!confirm('Apply recommended default values to all products?\n\nOrders ≥ 1\nACoS ≤ 30%\nSpend ≤ $100\nClicks ≥ 1\nConv Rate ≥ 5%\nCTR ≥ 0.5%')) {
              return;
            }

            const activeKpis = [];
            document.querySelectorAll('.kpi-check').forEach(c => {
              if (c.checked) activeKpis.push(c.value);
            });

            detectedProducts.forEach(product => {
              if (!productRulesState[product]) productRulesState[product] = {};
              activeKpis.forEach(kpi => {
                if (defaultKPIValues[kpi] !== undefined) {
                  productRulesState[product][kpi] = defaultKPIValues[kpi];
                }
              });
            });

            renderProductRules(detectedProducts);
            showToast('✨ Smart defaults applied to all products!');
          }

          function calculateSuggestedValues() {
            // Calculate suggested values based on current data
            const allData = [...spRowsRaw, ...sbRowsRaw];
            if (!allData.length) return null;

            // Calculate average metrics
            let totalAcos = 0, acosCount = 0;
            let totalSpend = 0, spendCount = 0;

            allData.forEach(row => {
              const acos = toNum(row['Total Advertising Cost of Sales (ACOS) '] || row['ACoS']);
              const spend = toNum(row['Spend']);

              if (!isNaN(acos) && acos > 0) {
                totalAcos += acos;
                acosCount++;
              }

              if (!isNaN(spend) && spend > 0) {
                totalSpend += spend;
                spendCount++;
              }
            });

            return {
              avgAcos: acosCount > 0 ? (totalAcos / acosCount).toFixed(0) : 30,
              avgSpend: spendCount > 0 ? (totalSpend / spendCount).toFixed(0) : 100
            };
          }

          /* --- NEW: Copy & Clear Features Logic --- */

          // 1. Copy To All
          function copyRulesToAll(sourceProduct) {
            if (!confirm(`Apply rules from "${sourceProduct}" to ALL products?`)) return;

            const sourceRules = productRulesState[sourceProduct] || {};
            if (!Object.keys(sourceRules).length) {
              showToast("No rules set for this product yet.");
              return;
            }

            detectedProducts.forEach(target => {
              if (target === sourceProduct) return;
              productRulesState[target] = { ...sourceRules };
            });
            renderProductRules(detectedProducts);
            showToast("Rules applied to all products.");
          }

          // 2. Clear All Rules
          function clearAllRules(sourceProduct) {
            if (!confirm(`REMOVE rules for ALL products?`)) return;

            detectedProducts.forEach(target => {
              productRulesState[target] = {}; // Wipe rules
            });
            renderProductRules(detectedProducts);
            showToast("All rules removed.");
          }

          // 3. Modal Logic (Shared for Apply & Remove)
          let currentCopySource = null;
          let isRemoveMode = false;

          function openCopyModal(sourceProduct) {
            const sourceRules = productRulesState[sourceProduct] || {};
            if (!Object.keys(sourceRules).length) {
              showToast("No rules set for this product yet.");
              return;
            }
            isRemoveMode = false;
            setupModal(sourceProduct, "Apply Rules to Specific Products", "Apply Rules");
          }

          function openClearModal(sourceProduct) {
            isRemoveMode = true;
            setupModal(sourceProduct, "Remove Rules from Specific Products", "Remove Rules");
          }

          function setupModal(source, title, btnText) {
            currentCopySource = source;
            document.getElementById('copySourceProduct').textContent = source;
            document.getElementById('modalTitle').textContent = title;

            const btn = document.getElementById('btnConfirmCopy');
            btn.textContent = btnText;
            btn.className = "btn " + (isRemoveMode ? "btn-secondary" : "btn-primary");
            if (isRemoveMode) btn.style.color = "#991b1b"; else btn.style.color = "white";

            const list = document.getElementById('copyTargetList');
            list.innerHTML = "";

            detectedProducts.forEach(p => {
              if (p === source && !isRemoveMode) return; // Skip self only in Apply mode

              const div = document.createElement("div");
              div.className = "copy-target-item";
              div.style.cssText = "padding:4px; border-bottom:1px solid #f8fafc;";
              div.innerHTML = `
                <label style="display:flex; align-items:center; gap:8px; font-size:12px; cursor:pointer;"> <input type="checkbox" class="copy-target-check" value="${escapeHtml(p)}">
                    ${escapeHtml(p)}
                </label>
            `;
              list.appendChild(div);
            });

            document.getElementById('copyModal').style.display = "flex";
            document.getElementById('copySelectAll').checked = false;
            document.getElementById('copyModalSearch').value = "";
          }

          function closeCopyModal() {
            document.getElementById('copyModal').style.display = "none";
            currentCopySource = null;
            isRemoveMode = false;
          }

          // Modal: Click outside to close
          document.getElementById('copyModal').addEventListener('click', (e) => {
            if (e.target.id === 'copyModal') closeCopyModal();
          });

          // Modal: Escape key to close
          document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && document.getElementById('copyModal').style.display === 'flex') {
              closeCopyModal();
            }
          });

          // Modal Search Filter
          document.getElementById('copyModalSearch').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            document.querySelectorAll('.copy-target-item').forEach(item => {
              const txt = item.innerText.toLowerCase();
              item.style.display = txt.includes(term) ? "block" : "none";
            });
          });

          // Select All Toggle
          document.getElementById('copySelectAll').addEventListener('change', (e) => {
            const checked = e.target.checked;
            document.querySelectorAll('.copy-target-check').forEach(chk => {
              // Only check visible ones (respect search filter)
              if (chk.closest('div').style.display !== "none") chk.checked = checked;
            });
          });

          // Modal Confirm Action
          document.getElementById('btnConfirmCopy').addEventListener('click', () => {
            const targets = [];
            document.querySelectorAll('.copy-target-check:checked').forEach(chk => targets.push(chk.value));

            if (!targets.length) { alert("Select at least one product."); return; }

            if (isRemoveMode) {
              // REMOVE Logic
              targets.forEach(target => { productRulesState[target] = {}; });
              showToast(`Rules removed from ${targets.length} products.`);
            } else {
              // APPLY Logic
              if (!currentCopySource) return;
              const sourceRules = productRulesState[currentCopySource] || {};
              targets.forEach(target => { productRulesState[target] = { ...sourceRules }; });
              showToast(`Rules applied to ${targets.length} products.`);
            }

            renderProductRules(detectedProducts);
            closeCopyModal();
          });

          /* --- Processing --- */
          function buildAlreadyTargetedDB(rows, campaignCol, targetingCol, matchTypeCol) {
            const targets = {}; const campaigns = {};
            for (const row of rows) {
              const camp = (row[campaignCol] || "").toString().trim();
              if (!camp) continue;
              const product = extractProductName(camp);
              if (!product) continue;
              const targeting = (row[targetingCol] || "").toString().trim();
              if (!targeting) continue;
              if (!targets[product]) targets[product] = { Broad: new Set(), Phrase: new Set(), Exact: new Set(), ASIN: new Set() };
              if (!campaigns[product]) campaigns[product] = { Broad: {}, Phrase: {}, Exact: {}, ASIN: {} };
              const asinDirect = extractAsinDirect(targeting);
              if (asinDirect) { targets[product].ASIN.add(asinDirect); if (!campaigns[product].ASIN[asinDirect]) campaigns[product].ASIN[asinDirect] = new Set(); campaigns[product].ASIN[asinDirect].add(camp); }
              const bucket = normalizeMatchTypeToBucket(row[matchTypeCol]);
              if (bucket === "Broad" || bucket === "Phrase" || bucket === "Exact") { const k = normalizeKeyword(targeting); if (!k) continue; targets[product][bucket].add(k); if (!campaigns[product][bucket][k]) campaigns[product][bucket][k] = new Set(); campaigns[product][bucket][k].add(camp); }
            }
            return { targets, campaigns };
          }

          /* --- UPDATED: Processing Logic with Multi-KPI Per Product --- */
          function processSingleReport(which) {
            const rowsRaw = (which === "SP") ? spRowsRaw : sbRowsRaw;
            const rowsFmt = (which === "SP") ? spRowsFmt : sbRowsFmt;
            const headerList = (which === "SP") ? spHeaders : sbHeaders;
            const campaignCol = (which === "SP") ? spCampaignColName : sbCampaignColName;

            // Identify Active KPIs for rendering
            const activeKpis = [];
            document.querySelectorAll('.kpi-check').forEach(c => { if (c.checked) activeKpis.push(c.value); });

            // Map Headers based on file columns
            const colOrders = findColumn(headerList, ["order"]) || findColumn(headerList, ["7", "order"]);
            const colAcos = findColumn(headerList, ["acos"]) || findColumn(headerList, ["advertising cost of sales"]);
            const colSpend = findColumn(headerList, ["spend"]);
            const colClicks = findColumn(headerList, ["clicks"]);
            const colConv = findColumn(headerList, ["conversion rate"]);
            const colCtr = findColumn(headerList, ["ctr"]);

            const colTerm = findColumn(headerList, ["search", "term"]) || findColumn(headerList, ["customer", "search"]);
            const colTargeting = headerList.find(h => h.trim().toLowerCase() === "targeting") || findColumn(headerList, ["targeting"]);
            const colMatch = headerList.find(h => h.trim().toLowerCase() === "match type") || findColumn(headerList, ["match", "type"]);
            const kpiCols = pickKpiColumns(headerList);

            if (!colTerm || !colTargeting || !colMatch) { setStatus(which, "Missing essential columns.", "error"); return; }

            // Read User Rules from Memory
            const productRules = productRulesState;

            const { targets: alreadyTargets, campaigns: alreadyCampaigns } = buildAlreadyTargetedDB(rowsRaw, campaignCol, colTargeting, colMatch);
            const grouped = {};

            for (let i = 0; i < rowsRaw.length; i++) {
              const row = rowsRaw[i];
              const rowFmt = rowsFmt[i] || {};

              const sourceCampaign = (row[campaignCol] || "").toString().trim();
              if (!sourceCampaign) continue;
              const product = extractProductName(sourceCampaign);
              if (!product) continue;

              const targetingRaw = (row[colTargeting] || "").toString().trim();
              const matchTypeRaw = (row[colMatch] || "").toString().trim();
              if (normalizeMatchTypeToBucket(matchTypeRaw) === "Exact") continue;

              // Extract Row Metrics
              const rOrders = toNum(row[colOrders]);
              const rAcos = normalizeAcosToPercent(row[colAcos]);
              const rSpend = toNum(row[colSpend]);
              const rClicks = toNum(row[colClicks]);
              const rConv = toNum(row[colConv]);
              const rCtr = toNum(row[colCtr]);

              // Normalize Percentages (if file has 0.15 for 15%, convert to 15)
              const valAcos = isNaN(rAcos) ? 0 : rAcos;
              const valConv = (rConv < 1 && rConv > 0) ? rConv * 100 : rConv;
              const valCtr = (rCtr < 1 && rCtr > 0) ? rCtr * 100 : rCtr;

              // CHECK RULES
              const rules = productRules[product] || {};
              let pass = true;

              // 1. Orders (>=)
              if (rules.orders !== undefined && rOrders < rules.orders) pass = false;
              // 2. ACoS (<=)
              if (pass && rules.acos !== undefined && (valAcos === 0 || valAcos > rules.acos)) pass = false;
              // 3. Spend (<=)
              if (pass && rules.spend !== undefined && rSpend > rules.spend) pass = false;
              // 4. Clicks (>=)
              if (pass && rules.clicks !== undefined && rClicks < rules.clicks) pass = false;
              // 5. Conv Rate (>=)
              if (pass && rules.cv !== undefined && valConv < rules.cv) pass = false;
              // 6. CTR (>=)
              if (pass && rules.ctr !== undefined && valCtr < rules.ctr) pass = false;

              // Check if should be collected as negative keyword
              const customerSearchTerm = (row[colTerm] || "").toString().trim();
              if (!customerSearchTerm) continue;

              const generateNegatives = document.getElementById('toggleGenerateNegatives')?.checked;
              if (generateNegatives && !pass) {
                // Check negative criteria
                const negSpendNoOrders = document.getElementById('negCriteriaSpendNoOrders')?.checked;
                const negHighAcos = document.getElementById('negCriteriaHighAcos')?.checked;
                const negLowCvr = document.getElementById('negCriteriaLowCvr')?.checked;

                const spendThreshold = parseFloat(document.getElementById('negSpendThreshold')?.value || 50);
                const acosThreshold = parseFloat(document.getElementById('negAcosThreshold')?.value || 100);
                const cvrThreshold = parseFloat(document.getElementById('negCvrThreshold')?.value || 1);

                let isNegative = false;
                let negReason = '';

                if (negSpendNoOrders && rSpend >= spendThreshold && rOrders === 0) {
                  isNegative = true;
                  negReason = `Spend $${rSpend.toFixed(2)}, 0 orders`;
                } else if (negHighAcos && valAcos >= acosThreshold) {
                  isNegative = true;
                  negReason = `ACoS ${valAcos.toFixed(1)}%`;
                } else if (negLowCvr && valConv < cvrThreshold && valConv > 0) {
                  isNegative = true;
                  negReason = `Conv ${valConv.toFixed(2)}%`;
                }

                if (isNegative) {
                  if (!harvestedNegatives[which][product]) {
                    harvestedNegatives[which][product] = [];
                  }

                  const wordCount = countWords(customerSearchTerm);
                  const negMatchType = wordCount >= 4 ? 'Exact' : 'Phrase';

                  harvestedNegatives[which][product].push({
                    term: normalizeKeyword(customerSearchTerm),
                    matchType: negMatchType,
                    reason: negReason,
                    spend: rSpend,
                    acos: valAcos,
                    cvr: valConv,
                    sourceCampaign: sourceCampaign
                  });
                }
              }

              if (!pass) continue;

              // Passed! Harvest Logic...

              // Add ALL metrics to common so table can read them
              const common = {
                "Product": product,
                "Orders": rOrders,
                "ACoS %": valAcos.toFixed(2),
                "Spend": rSpend.toFixed(2),
                "Clicks": rClicks,
                "Conv %": valConv.toFixed(2),
                "CTR %": valCtr.toFixed(2),
                "Source Campaign Name": sourceCampaign,
                "Source Match Type": matchTypeRaw,
                "Targeting (raw)": targetingRaw
              };
              const extraKpis = {};
              for (const [niceKey, cName] of Object.entries(kpiCols)) { if (cName) extraKpis[niceKey] = rowFmt[cName]; }
              // Force critical numeric values into extraKpis for Bidding Calculator
              extraKpis["Spend"] = rSpend;
              extraKpis["Clicks"] = rClicks;
              extraKpis["CPC"] = toNum(row[findColumn(headerList, ["cpc"])]);
              extraKpis["Orders"] = rOrders;
              extraKpis["ACoS"] = valAcos.toFixed(2) + "%";

              const asinExpanded = extractAsinExpanded(targetingRaw);
              const termIsAsin = isAsinLike(customerSearchTerm);

              // Helper to add item
              const addItem = (bucket, val) => {
                const set = (alreadyTargets[product] || { [bucket]: new Set() })[bucket] || new Set();
                const isDup = val && set.has(val);
                const out = {
                  "Suggested Targeting": bucket,
                  "Suggestion Source Type": "harvest",
                  "Suggested Value": customerSearchTerm,
                  "Duplicate?": isDup ? "YES" : "NO",
                  "Matched Targeting Key": isDup ? val : "",
                  "Already Targeted In Campaigns": (isDup && alreadyCampaigns[product]?.[bucket]?.[val]) ? Array.from(alreadyCampaigns[product][bucket][val]).join(" | ") : "",
                  ...common,
                  "Customer Search Term": customerSearchTerm,
                  "Extra KPIs": extraKpis
                };

                if (!grouped[product]) grouped[product] = {};
                if (!grouped[product][bucket]) grouped[product][bucket] = { final: [], excluded: [] };
                if (isDup) grouped[product][bucket].excluded.push(out); else grouped[product][bucket].final.push(out);
              };

              if (asinExpanded || termIsAsin) {
                const direct = extractAsinDirect(targetingRaw);
                const val = customerSearchTerm.toUpperCase();
                if (!direct || direct !== val) addItem("ASIN", val);
              } else {
                const wc = countWords(customerSearchTerm);
                const kw = normalizeKeyword(customerSearchTerm);
                if (wc >= 1 && wc <= 2) addItem("Broad", kw);
                if (wc >= 2 && wc <= 3) addItem("Phrase", kw);
                if (wc >= 3) addItem("Exact", kw);
              }
            }

            performInternalDeduplication(grouped);

            if (which === "SP") lastGroupedSP = grouped; else lastGroupedSB = grouped;

            // PASS ACTIVE KPIs TO RENDER
            render(grouped, ["ASIN", "Broad", "Phrase", "Exact"], which, activeKpis);
            buildSidebarNav();
            applyUiFilters();
            ensureSuggestionsBarVisibility();
            updateSmartBids();

            // UX/UI Improvements: Update dashboard and hide skeleton
            if (typeof updateResultsDashboard === 'function') {
              updateResultsDashboard();
            }
            if (typeof hideLoadingSkeleton === 'function') {
              hideLoadingSkeleton();
            }
          }

          /* --- New Helper: Deduplicate Internal Matches --- */
          function performInternalDeduplication(grouped) {
            if (!grouped) return;

            // Iterate over every Product
            Object.keys(grouped).forEach(product => {
              // Iterate over every Bucket (ASIN, Broad, Phrase, Exact)
              ["ASIN", "Broad", "Phrase", "Exact"].forEach(bucket => {
                const groupObj = grouped[product][bucket];
                if (!groupObj || !groupObj.final || groupObj.final.length < 2) return;

                // 1. Group rows by the Search Term to find duplicates
                const termMap = {};
                groupObj.final.forEach(row => {
                  // Use "Suggested Value" (the cleaned term/ASIN) as the key
                  const term = (row["Suggested Value"] || "").toString().toLowerCase().trim();
                  if (!termMap[term]) termMap[term] = [];
                  termMap[term].push(row);
                });

                // 2. Clear the current 'final' list, we will rebuild it
                groupObj.final = [];

                // 3. Process each term
                Object.keys(termMap).forEach(term => {
                  const rows = termMap[term];

                  if (rows.length === 1) {
                    // No duplicate? Just put it back in Final
                    groupObj.final.push(rows[0]);
                  } else {
                    // Duplicate found! Sort by ACoS (Lowest ACoS = Best = Index 0)
                    rows.sort((a, b) => {
                      const aVal = parseFloat(a["ACoS %"] || 9999);
                      const bVal = parseFloat(b["ACoS %"] || 9999);
                      return aVal - bVal;
                    });

                    // Winner: Index 0 (Lowest ACoS) -> Goes to Final
                    groupObj.final.push(rows[0]);

                    // Losers: Index 1 onwards -> Go to Excluded with reason
                    for (let i = 1; i < rows.length; i++) {
                      const loser = rows[i];
                      // Update the reason fields
                      loser["Duplicate?"] = "YES";
                      loser["Matched Targeting Key"] = `Internal Duplicate (ACoS ${loser["ACoS %"]}% > ${rows[0]["ACoS %"]}%)`;
                      loser["Already Targeted In Campaigns"] = "Found in multiple source campaigns"; // Optional: context

                      // Push to excluded array
                      groupObj.excluded.push(loser);
                    }
                  }
                });
              });
            });
          }

          /* --- New Helper: Deduplicate Internal Matches --- */
          function performInternalDeduplication(grouped) {
            if (!grouped) return;

            // Iterate over every Product
            Object.keys(grouped).forEach(product => {
              // Iterate over every Bucket (ASIN, Broad, Phrase, Exact)
              ["ASIN", "Broad", "Phrase", "Exact"].forEach(bucket => {
                const groupObj = grouped[product][bucket];
                if (!groupObj || !groupObj.final || groupObj.final.length < 2) return;

                // 1. Group rows by the Search Term to find duplicates
                const termMap = {};
                groupObj.final.forEach(row => {
                  // Use "Suggested Value" (the cleaned term/ASIN) as the key
                  const term = (row["Suggested Value"] || "").toString().toLowerCase().trim();
                  if (!termMap[term]) termMap[term] = [];
                  termMap[term].push(row);
                });

                // 2. Clear the current 'final' list, we will rebuild it
                groupObj.final = [];

                // 3. Process each term
                Object.keys(termMap).forEach(term => {
                  const rows = termMap[term];

                  if (rows.length === 1) {
                    // No duplicate? Just put it back in Final
                    groupObj.final.push(rows[0]);
                  } else {
                    // Duplicate found! Sort by ACoS (Lowest ACoS = Best = Index 0)
                    rows.sort((a, b) => {
                      const aVal = parseFloat(a["ACoS %"] || 9999);
                      const bVal = parseFloat(b["ACoS %"] || 9999);
                      return aVal - bVal;
                    });

                    // Winner: Index 0 (Lowest ACoS) -> Goes to Final
                    groupObj.final.push(rows[0]);

                    // Losers: Index 1 onwards -> Go to Excluded with reason
                    for (let i = 1; i < rows.length; i++) {
                      const loser = rows[i];
                      // Update the reason fields
                      loser["Duplicate?"] = "YES";
                      loser["Matched Targeting Key"] = `Internal Duplicate (ACoS ${loser["ACoS %"]}% > ${rows[0]["ACoS %"]}%)`;
                      loser["Already Targeted In Campaigns"] = "Found in multiple source campaigns"; // Optional: context

                      // Push to excluded array
                      groupObj.excluded.push(loser);
                    }
                  }
                });
              });
            });
          }

          /* --- Rendering --- */
          function buildSidebarNav() {
            productNavEl.innerHTML = "";
            const products = new Set([...Object.keys(lastGroupedSP || {}), ...Object.keys(lastGroupedSB || {})]);
            if (!products.size) return;

            Array.from(products).sort().forEach(p => {
              let f = 0, e = 0;
              // Count from SP
              if (lastGroupedSP && lastGroupedSP[p]) {
                ["ASIN", "Broad", "Phrase", "Exact"].forEach(b => {
                  if (lastGroupedSP[p][b]) { f += (lastGroupedSP[p][b].final || []).length; e += (lastGroupedSP[p][b].excluded || []).length; }
                });
              }
              // Count from SB
              if (lastGroupedSB && lastGroupedSB[p]) {
                ["ASIN", "Broad", "Phrase", "Exact"].forEach(b => {
                  if (lastGroupedSB[p][b]) { f += (lastGroupedSB[p][b].final || []).length; e += (lastGroupedSB[p][b].excluded || []).length; }
                });
              }

              const item = document.createElement("div");
              item.className = "nav-item";
              item.innerHTML = `<div class="nav-item-name">${p}</div><div class="nav-badges"><span class="status-pill status-success" title="Final">${f}</span><span class="status-pill status-excluded" title="Excluded">${e}</span></div>`;
              item.onclick = () => {
                // Scroll to SP card if exists, else SB
                let el = document.getElementById("prod-SP-" + cssSafeId(p));
                if (!el) el = document.getElementById("prod-SB-" + cssSafeId(p));
                if (el) el.scrollIntoView({ behavior: "smooth", block: "start" });
              };
              productNavEl.appendChild(item);
            });
          }

          /* --- UPDATED: Render with Dynamic Columns --- */
          function render(grouped, bucketOrder, which, activeKpis) {
            // Hide welcome screen on first render
            hideWelcomeScreen();

            let container = document.getElementById(`results-${which}`);
            if (!container) {
              container = document.createElement("div");
              container.id = `results-${which}`;
              container.style.marginBottom = "40px";
              container.className = "animate-slideUp";
              container.innerHTML = `<div class="h2" style="border-bottom:1px solid var(--border); padding-bottom:10px; margin-bottom:20px;">${which === "SP" ? "Sponsored Products" : "Sponsored Brands"} Analysis</div>`;
              resultsEl.appendChild(container);
            } else {
              container.innerHTML = `<div class="h2" style="border-bottom:1px solid var(--border); padding-bottom:10px; margin-bottom:20px;">${which === "SP" ? "Sponsored Products" : "Sponsored Brands"} Analysis</div>`;
            }

            const products = Object.keys(grouped).sort();
            if (!products.length) { container.innerHTML += `<div class="muted">No data found for ${which}.</div>`; return; }

            products.forEach(product => {
              let fTotal = 0, eTotal = 0;
              bucketOrder.forEach(b => {
                if (!grouped[product][b]) return;
                fTotal += (grouped[product][b].final || []).length;
                eTotal += (grouped[product][b].excluded || []).length;
              });

              const detail = document.createElement("details");
              detail.open = true;
              detail.className = "prod-card";
              detail.id = `prod-${which}-${cssSafeId(product)}`;
              detail.setAttribute("data-finalcount", fTotal);

              const summary = document.createElement("summary");
              summary.className = "prod-header";

              // 1. PRODUCT LEVEL COPY BUTTON
              summary.innerHTML = `
          <div style="display:flex; align-items:center; gap:10px;"> <div class="prod-title">${product}</div> <button class="btn-copy-small" onclick="handleCopyProduct(event, '${escapeHtml(product)}', '${which}')"> <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><rect x="9" y="9" width="13" height="13" rx="2" ry="2" stroke-width="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" stroke-width="2"></path></svg>
              Copy All
            </button> </div> <div class="prod-meta"><span class="status-pill status-success" style="font-size:11px; padding:6px 12px;">Final: ${fTotal}</span><span class="status-pill status-excluded" style="font-size:11px; padding:6px 12px;">Excl: ${eTotal}</span></div>
        `;

              const body = document.createElement("div");
              body.className = "bucket-section";

              bucketOrder.forEach(bucket => {
                const obj = grouped[product][bucket];
                if (!obj) return;
                const finals = obj.final || [];
                const excl = obj.excluded || [];
                if (!finals.length && !excl.length) return;

                const bWrap = document.createElement("div");
                bWrap.className = "bucket-wrapper";
                bWrap.setAttribute("data-bucket", bucket);

                const bHeader = document.createElement("div");
                bHeader.className = "matchHeader";

                // 2. MATCH TYPE LEVEL COPY BUTTON
                // Note: using onclick event.stopPropagation to prevent collapse when clicking copy
                bHeader.innerHTML = `
            <div class="matchHeaderLeft"> <span class="matchChevron">▼</span> <span>${bucket.toUpperCase()} MATCH<span class="matchMeta">— FINAL ${finals.length} / EXCL ${excl.length}</span></span> </div> <button class="btn-copy-small" style="margin-right:4px;" onclick="handleCopyBucket(event, '${escapeHtml(product)}', '${bucket}', '${which}')"> <svg fill="none" viewBox="0 0 24 24" stroke="currentColor"><rect x="9" y="9" width="13" height="13" rx="2" ry="2" stroke-width="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" stroke-width="2"></path></svg>
              Copy Group
            </button>
          `;
                bWrap.appendChild(bHeader);

                const bContent = document.createElement("div");
                bContent.style.marginTop = "10px";
                bContent.setAttribute("data-bucket-content", "1");

                // PASS ACTIVE KPIs TO TABLE MAKER
                if (finals.length) bContent.appendChild(makeTableSection(finals, "final", activeKpis));
                if (excl.length) bContent.appendChild(makeTableSection(excl, "excluded", activeKpis));

                bWrap.appendChild(bContent);

                bHeader.addEventListener("click", (e) => {
                  // Only collapse if not clicking the copy button
                  if (e.target.closest("button")) return;

                  const chevron = bHeader.querySelector(".matchChevron");
                  const isCollapsed = bContent.style.display === "none";
                  bContent.style.display = isCollapsed ? "" : "none";
                  chevron.textContent = isCollapsed ? "▼" : "▶";
                });

                body.appendChild(bWrap);
              });

              detail.appendChild(summary);
              detail.appendChild(body);
              container.appendChild(detail);
            });
          }

          function makeTableSection(rows, type, activeKpis) {
            const isFinal = type === "final";
            const wrapper = document.createElement("div");
            wrapper.setAttribute("data-section", type);
            if (!isFinal) { wrapper.style.display = "none"; wrapper.style.borderTop = "1px solid var(--border)"; }
            rows.sort((a, b) => (b["Orders"] || 0) - (a["Orders"] || 0) || (parseFloat(a["ACoS %"]) || 0) - (parseFloat(b["ACoS %"]) || 0));

            // DYNAMIC HEADER GENERATION
            let kpiHeaders = "";
            (activeKpis || []).forEach(k => {
              if (k === "orders") kpiHeaders += `<th style="width:70px;">Orders</th>`;
              if (k === "acos") kpiHeaders += `<th style="width:70px;">ACoS %</th>`;
              if (k === "spend") kpiHeaders += `<th style="width:70px;">Spend</th>`;
              if (k === "clicks") kpiHeaders += `<th style="width:70px;">Clicks</th>`;
              if (k === "cv") kpiHeaders += `<th style="width:70px;">Conv %</th>`;
              if (k === "ctr") kpiHeaders += `<th style="width:70px;">CTR %</th>`;
            });

            const tableWrap = document.createElement("div");
            tableWrap.className = "table-container";
            const table = document.createElement("table");
            table.innerHTML = `<thead><tr><th style="width:120px;">Target Type</th><th>Suggested Search Term<span class="help-wrap"><span class="help-icon">?</span><span class="help-tooltip">The actual customer search term or ASIN recommended for new campaigns.</span></span></th>${kpiHeaders}<th style="width:80px;">Duplicate?</th><th style="width:100px;"></th></tr></thead>`;
            const tbody = document.createElement("tbody");

            rows.forEach((r, idx) => {
              const tr = document.createElement("tr");
              const dup = r["Duplicate?"] === "YES";
              const termVal = r["Suggested Value"] || r["Customer Search Term"];

              // DYNAMIC CELL GENERATION
              let kpiCells = "";
              (activeKpis || []).forEach(k => {
                if (k === "orders") kpiCells += `<td>${r["Orders"] || 0}</td>`;
                if (k === "acos") kpiCells += `<td>${r["ACoS %"] || 0}%</td>`;
                if (k === "spend") kpiCells += `<td>${r["Spend"] || 0}</td>`;
                if (k === "clicks") kpiCells += `<td>${r["Clicks"] || 0}</td>`;
                if (k === "cv") kpiCells += `<td>${r["Conv %"] || 0}%</td>`;
                if (k === "ctr") kpiCells += `<td>${r["CTR %"] || 0}%</td>`;
              });

              tr.innerHTML = `
          <td><span class="status-pill" style="background:#f1f5f9; color:#475569;">${r["Suggested Targeting"]}</span></td> <td class="cell-main"> <div style="display:flex; align-items:center; gap:8px;">
               ${termVal}
               <div class="icon-copy-row" title="Copy Term" onclick="copyToClipboard('${escapeHtml(termVal)}')"> <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg> </div> </div> </td>
          ${kpiCells}
          <td><span class="${dup ? 'text-red' : 'text-green'}" style="font-weight:700; font-size:11px;">${dup ? 'YES' : 'NO'}</span></td> <td style="text-align:right;"><button class="btn btn-secondary" style="padding:4px 10px; font-size:11px;" onclick="toggleRowDetail(this)">Details</button></td>
        `;
              tbody.appendChild(tr);

              const trDet = document.createElement("tr");
              trDet.style.display = "none";
              trDet.className = "detail-row";
              const srcMatch = getSourceMatchTypeDisplay(r);
              const targetingRaw = (r["Targeting (raw)"] || r["Targeting"] || "").toString();
              const tDisplay = getTargetingDisplay(targetingRaw);
              const cst = r["Customer Search Term"] || "";
              const sug = r["Suggested Value"] || "";
              const showCST = cst && sug && cst.toLowerCase() !== sug.toLowerCase();
              const extra = r["Extra KPIs"] || {};
              const kpiOrder = ["Impressions", "Clicks", "CTR", "CPC", "Spend", "Sales", "Orders", "Conversion Rate", "ACoS", "ROAS"];
              const kpiHtml = kpiOrder.filter(k => extra[k] !== undefined).map(k => { let v = displayKpiValue(extra[k]); return `<div class="kpiBox"><div class="kpiName">${escapeHtml(k)}</div><div class="kpiVal">${escapeHtml(v)}</div></div>`; }).join("");

              // Calc colspan based on active KPIs + fixed cols (Target, Term, Dup, Btn) = 4 + kpis
              const colSpan = 4 + (activeKpis || []).length;

              trDet.innerHTML = `<td colspan="${colSpan}"><div class="mini-card"><div class="mini-header"><span class="mini-badge">${r["Suggestion Source Type"]}</span><span class="mini-badge" style="background:#f1f5f9; color:#475569; border-color:#e2e8f0;">Source Match: ${srcMatch}</span><span class="help-wrap"><span class="help-icon">?</span><span class="help-tooltip">Explanation of why this term was harvested based on the source campaign.</span></span></div><div class="mini-grid"><div class="mini-section"><div class="mini-label">Suggested Term</div><div class="mini-value text-green">${escapeHtml(sug)}</div>${showCST ? `<div class="mini-label" style="margin-top:8px;">Raw Customer Search Term</div><div class="mini-value">${escapeHtml(cst)}</div>` : ''}</div><div class="mini-section"><div class="mini-label">Source Campaign</div><div class="mini-value">${escapeHtml(r["Source Campaign Name"])}</div><div class="mini-label" style="margin-top:8px;">${escapeHtml(tDisplay.label)}</div><code class="mini-mono">${escapeHtml(tDisplay.value)}</code></div></div>${kpiHtml ? `<div class="detailDivider"></div><div class="mini-label" style="margin-bottom:8px;">Performance KPIs (Source Data)</div><div class="kpiGrid">${kpiHtml}</div>` : ``}${(r["Matched Targeting Key"] || r["Already Targeted In Campaigns"]) ? `<div class="mini-grid" style="margin-top:16px;"><div class="mini-section bg-red-light" style="border-color:#fecaca;"><div class="mini-label text-red">Matched Targeting Key</div><div class="mini-value text-red">${escapeHtml(r["Matched Targeting Key"] || "-")}</div></div><div class="mini-section bg-red-light" style="border-color:#fecaca;"><div class="mini-label text-red">Existing Campaigns</div><div class="mini-value text-red" style="font-size:11px;">${escapeHtml(r["Already Targeted In Campaigns"] || "-")}</div></div></div>` : ''}</div></td>`;
              tbody.appendChild(trDet);
            });
            table.appendChild(tbody);
            tableWrap.appendChild(table);
            wrapper.appendChild(tableWrap);
            return wrapper;
          }

          function toggleRowDetail(btn) { const tr = btn.closest("tr"); const next = tr.nextElementSibling; const isHidden = next.style.display === "none"; next.style.display = isHidden ? "table-row" : "none"; btn.textContent = isHidden ? "Hide" : "Details"; btn.style.background = isHidden ? "#f1f5f9" : "white"; }
          function applyUiFilters() { const q = uiSearch.value.trim().toLowerCase(); const finalOnly = toggleFinalOnly.checked; const onlyFinalProducts = toggleOnlyFinalProducts.checked; document.querySelectorAll('[data-section="excluded"]').forEach(el => { el.style.display = finalOnly ? "none" : "block"; }); document.querySelectorAll("tbody tr").forEach(tr => { if (tr.classList.contains("detail-row")) return; const text = tr.innerText.toLowerCase(); const detailRow = tr.nextElementSibling; const detailText = detailRow ? detailRow.innerText.toLowerCase() : ""; const matchesSearch = !q || text.includes(q) || detailText.includes(q); if (matchesSearch) { tr.style.display = ""; } else { tr.style.display = "none"; if (detailRow) detailRow.style.display = "none"; } }); document.querySelectorAll(".prod-card").forEach(card => { const finalCount = parseInt(card.getAttribute("data-finalcount") || "0"); if (onlyFinalProducts && finalCount === 0) { card.classList.add("hidden"); return; } const visibleRows = Array.from(card.querySelectorAll("tbody tr")).filter(tr => !tr.classList.contains("detail-row") && tr.style.display !== "none").length; if (visibleRows === 0) card.classList.add("hidden"); else card.classList.remove("hidden"); }); document.querySelectorAll(".nav-item").forEach(item => { const pName = item.querySelector(".nav-item-name").innerText; const cardSP = document.getElementById("prod-SP-" + cssSafeId(pName)); const cardSB = document.getElementById("prod-SB-" + cssSafeId(pName)); const hiddenSP = !cardSP || cardSP.classList.contains("hidden"); const hiddenSB = !cardSB || cardSB.classList.contains("hidden"); if (hiddenSP && hiddenSB) item.style.display = "none"; else item.style.display = "flex"; }); }

          /* --- New Copy Handlers --- */

          // Copy a single string to clipboard
          async function copyToClipboard(text) {
            if (!text) return;
            try {
              if (navigator.clipboard && window.isSecureContext) {
                await navigator.clipboard.writeText(text);
              } else {
                const ta = document.createElement("textarea");
                ta.value = text;
                ta.style.position = "fixed"; left = "-9999px";
                document.body.appendChild(ta);
                ta.focus(); ta.select();
                document.execCommand("copy");
                ta.remove();
              }
              showToast("Copied to clipboard!");
            } catch (err) {
              console.error(err);
              showToast("Failed to copy");
            }
          }

          // 1. Copy All (Product Level)
          function handleCopyProduct(e, product, which) {
            e.preventDefault(); e.stopPropagation();
            const grouped = (which === "SP") ? lastGroupedSP : lastGroupedSB;
            if (!grouped || !grouped[product]) return;

            let allTerms = [];
            const buckets = ["Broad", "Phrase", "Exact", "ASIN"];

            buckets.forEach(b => {
              const arr = grouped[product][b]?.final || [];
              arr.forEach(r => {
                const t = (r["Suggested Value"] || r["Customer Search Term"] || "").toString().trim();
                if (t) allTerms.push(t);
              });
            });

            if (!allTerms.length) { showToast("No final terms found for this product."); return; }
            copyToClipboard(allTerms.join("\n"));
            showToast(`Copied ${allTerms.length} terms for ${product}`);
          }

          // 2. Copy Group (Bucket Level)
          function handleCopyBucket(e, product, bucket, which) {
            e.preventDefault(); e.stopPropagation();
            const grouped = (which === "SP") ? lastGroupedSP : lastGroupedSB;
            if (!grouped || !grouped[product]) return;

            const arr = grouped[product][bucket]?.final || [];
            let allTerms = [];
            arr.forEach(r => {
              const t = (r["Suggested Value"] || r["Customer Search Term"] || "").toString().trim();
              if (t) allTerms.push(t);
            });

            if (!allTerms.length) { showToast(`No final terms in ${bucket} match.`); return; }
            copyToClipboard(allTerms.join("\n"));
            showToast(`Copied ${allTerms.length} ${bucket} terms`);
          }

          /* --- Feature: Smart Avg CPC Calculation (With Fallback) --- */
          function updateSmartBids() {
            // Helper to calculate avg cpc for a specific bucket across all products
            const calc = (groupedData, bucketName) => {
              if (!groupedData) return null;
              let totalCpc = 0;
              let count = 0;

              Object.values(groupedData).forEach(prodObj => {
                // Look at FINAL terms only
                const rows = prodObj[bucketName]?.final || [];
                rows.forEach(r => {
                  const kpis = r["Extra KPIs"] || {};

                  // Method 1: Try reading the direct "CPC" column
                  let cpc = toNum(kpis["CPC"]);

                  // Method 2: Fallback (Calculate manually if CPC is missing/invalid)
                  if (isNaN(cpc) || cpc <= 0) {
                    const spend = toNum(kpis["Spend"]);
                    const clicks = toNum(kpis["Clicks"]);
                    if (!isNaN(spend) && !isNaN(clicks) && clicks > 0) {
                      cpc = spend / clicks;
                    }
                  }

                  // If we have a valid number now, add it
                  if (!isNaN(cpc) && cpc > 0) {
                    totalCpc += cpc;
                    count++;
                  }
                });
              });

              if (count === 0) return null;
              return (totalCpc / count).toFixed(2);
            };

            // 1. Sponsored Products (SP)
            const spBuckets = ["Broad", "Phrase", "Exact", "ASIN"];
            spBuckets.forEach(b => {
              const val = calc(lastGroupedSP, b);
              const el = document.getElementById(`hint_sp_${b}`);
              if (el) {
                el.textContent = val ? `Avg CPC: ${val}` : "No data";
                // Visual feedback: Green if data exists, Gray if not
                el.style.color = val ? "#166534" : "#94a3b8";
                el.style.fontWeight = val ? "800" : "500";
                el.style.pointerEvents = val ? "auto" : "none";
              }
            });

            // 2. Sponsored Brands (SB)
            const sbBuckets = ["Broad", "Phrase", "Exact"];
            sbBuckets.forEach(b => {
              const val = calc(lastGroupedSB, b);
              const el = document.getElementById(`hint_sb_${b}`);
              if (el) {
                el.textContent = val ? `Avg CPC: ${val}` : "No data";
                el.style.color = val ? "#166534" : "#94a3b8";
                el.style.fontWeight = val ? "800" : "500";
                el.style.pointerEvents = val ? "auto" : "none";
              }
            });
          }

          // Helper to click the text and fill the input
          function applyBidHint(el, inputId) {
            const text = el.textContent;
            if (!text || !text.includes(":")) return;
            const parts = text.split(":");
            const val = parts[1] ? parts[1].trim().replace(/[^0-9.]/g, "") : "";
            const input = document.getElementById(inputId);
            if (input && val) {
              input.value = val;
              // Visual feedback
              input.style.backgroundColor = "#dcfce7";
              setTimeout(() => input.style.backgroundColor = "", 300);
            }
          }

          /* --- Export Logic --- */
          function collectFinalSuggestionsFromGrouped(grouped) {
            const out = []; if (!grouped) return out;
            const bucketOrder = ["ASIN", "Broad", "Phrase", "Exact"];
            Object.keys(grouped).forEach(product => {
              bucketOrder.forEach(bucket => {
                const obj = grouped[product]?.[bucket];
                if (!obj?.final?.length) return;
                obj.final.forEach(r => {
                  const val = (r["Suggested Value"] || r["Customer Search Term"] || "").toString().trim();
                  if (!val) return;
                  out.push({ product, bucket, value: val });
                });
              });
            });
            return out;
          }

          function getOpt1SkuMap() {
            const map = {};
            opt1_spSkuMap.querySelectorAll("input[data-sku-product]").forEach(inp => {
              const p = inp.getAttribute("data-sku-product"); const sku = (inp.value || "").trim(); if (p) map[p] = sku;
            });
            return map;
          }

          function spBidForBucket(bucket) {
            const b = bucket.toLowerCase();
            if (b === "broad") return numVal(opt1_spBidBroad, 0.6);
            if (b === "phrase") return numVal(opt1_spBidPhrase, 0.75);
            if (b === "exact") return numVal(opt1_spBidExact, 0.95);
            return numVal(opt1_spDefaultBid, 0.75);
          }

          // New Helper for SBV Bids
          function sbvBidForBucket(bucket) {
            const b = bucket.toLowerCase();
            if (b === "broad") return numVal(document.getElementById('opt1_sbvBidBroad'), 0.80);
            if (b === "phrase") return numVal(document.getElementById('opt1_sbvBidPhrase'), 1.00);
            if (b === "exact") return numVal(document.getElementById('opt1_sbvBidExact'), 1.25);
            // Fallback
            return 0.80;
          }

          /* --- UPDATED: Smart Reference Reader (Duplicates + Auto-SKU) --- */
          function handleRefFile(file) {
            if (!file) return;

            // Reset
            if (typeof existingCampaignNames === 'undefined') window.existingCampaignNames = new Set();
            existingCampaignNames.clear();
            productSkuMap = {}; // Clear SKU memory

            fileNameDisplayBulkRef.innerHTML = `⏳ Scanning: ${file.name}`;
            fileNameDisplayBulkRef.style.display = 'block';
            statusBulkRef.textContent = "Analyzing file type...";
            statusBulkRef.className = "text-muted";

            const reader = new FileReader();
            reader.onload = (event) => {
              try {
                const data = new Uint8Array(event.target.result);
                const wb = XLSX.read(data, { type: 'array' });

                let totalNames = 0;
                let skuCount = 0;

                // Define the specific Bulk Sheets to scan for SKUs
                const bulkSheets = [
                  "Sponsored Products Campaigns",
                  "Sponsored Brands campaigns",
                  "SB Multi Ad Group Campaigns"
                ];

                // Loop ALL sheets (Works for both CSV and XLSX)
                wb.SheetNames.forEach(sheetName => {
                  const ws = wb.Sheets[sheetName];
                  const json = XLSX.utils.sheet_to_json(ws, { defval: "" });
                  if (!json.length) return;

                  json.forEach(row => {
                    // A. FIND CAMPAIGN NAME (For Duplication Check)
                    const cName =
                      row["Campaign Name (Informational only)"] ||
                      row["Campaign Name"] ||
                      row["Campaigns"] ||
                      row["Campaign"] ||
                      row["campaign_name"];

                    if (cName && typeof cName === 'string' && cName.trim().length > 0) {
                      // Ignore header-like rows if they slip in
                      if (cName !== "Campaigns" && cName !== "Campaign Name") {
                        existingCampaignNames.add(cName.toString().trim());
                        totalNames++;
                      }

                      // B. FIND SKU (Only if we have a campaign name on this row)
                      const sku = row["SKU"];
                      if (sku && typeof sku === 'string' && sku.trim().length > 0) {
                        // We found a row with BOTH Campaign Name and SKU!
                        // Extract Product Name using your logic
                        const product = extractProductName(cName);

                        // Map it: Product -> SKU
                        if (product && product !== "Unknown Product") {
                          productSkuMap[product] = sku.toString().trim();
                          skuCount++;
                        }
                      }
                    }
                  });
                });

                // Final Status
                if (totalNames > 0) {
                  filesUploaded.ref = true;
                  let msg = `<b>Success!</b> Memorized ${existingCampaignNames.size} unique campaigns.`;
                  if (skuCount > 0) {
                    msg += `<br><span style="color:#15803d">✅ Auto-mapped ${Object.keys(productSkuMap).length} Products to SKUs.</span>`;
                  }
                  statusBulkRef.innerHTML = msg;
                  statusBulkRef.className = "text-success";
                  console.log("📦 SKU Map:", productSkuMap);
                  checkStepProgress();
                } else {
                  statusBulkRef.textContent = "Error: No campaign columns found. Check file headers.";
                  statusBulkRef.className = "text-error";
                }

              } catch (e) {
                console.error(e);
                statusBulkRef.textContent = "Error reading file.";
                statusBulkRef.className = "text-red";
              }
            };
            reader.readAsArrayBuffer(file);
          }

          /* --- Helper: Generate Unique Campaign Name --- */
          function getUniqueCampaignName(baseName) {
            // 1. Check strict exact match (e.g., "Hat | Harvested")
            if (!existingCampaignNames.has(baseName)) {
              existingCampaignNames.add(baseName); // Reserve it for this session
              return baseName;
            }

            // 2. Conflict found! Start counting: Harvested 1, Harvested 2...
            let counter = 1;
            while (true) {
              const candidate = `${baseName} ${counter}`;
              if (!existingCampaignNames.has(candidate)) {
                existingCampaignNames.add(candidate); // Reserve it
                // Track this rename for user feedback
                renamedCampaignsList.push({ original: baseName, renamed: candidate });
                return candidate;
              }
              counter++;
            }
          }

          /* --- UPDATED: Download Bulk (With 3 Bidding Strategies & Modifier) --- */
          function downloadBulkWorkbook() {
            // Reset renamed campaigns list for this export
            renamedCampaignsList = [];

            const includeSP = !!toggleExportSP.checked;
            const includeSBV = !!toggleExportSBV.checked;
            if (!includeSP && !includeSBV) {
              bulkStatus.textContent = "❌ Select SP and/or SBV to export.";
              bulkStatus.className = "text-error";
              return;
            }

            // Validate start date
            if (!validateDateInput()) {
              bulkStatus.textContent = "❌ Please fix the start date error before exporting.";
              bulkStatus.className = "text-error";
              document.getElementById('bulkStartDate').scrollIntoView({ behavior: 'smooth', block: 'center' });
              return;
            }

            // Convert ISO date (YYYY-MM-DD) to YYYYMMDD format
            let startDate = (bulkStartDate.value || "").trim();
            if (startDate) {
              startDate = startDate.replace(/-/g, '');
            } else {
              startDate = formatTodayYYYYMMDD();
            }

            const state = (bulkState.value || "Enabled").trim().toLowerCase(); // enabled/paused
            const spState = (state === "paused") ? "paused" : "enabled";

            const spBiddingStrategy = (document.getElementById("spBiddingStrategy")?.value || "Fixed bids").trim();

            // NEW: Bidding Strategy - Always use Source CPC from data
            const strategy = "sourceCpc"; // Force Source CPC - no fallback
            const modifierPct = parseFloat(document.getElementById('spBidModifier')?.value || "0");
            const modifierMult = 1 + (modifierPct / 100);

            // SB Global Inputs
            const brandEntityId = (bulkBrandEntityId.value || "").trim();
            // This is now specific to SBV, as requested
            const sbPortfolioId = (bulkPortfolioId.value || "").trim();
            const bidOptimization = (bulkBidOpt.value || "true") === "true"; // boolean

            // SP Specific Portfolio ID (NEW)
            const spPortfolioId = (document.getElementById('opt1_spPortfolioId')?.value || "").trim();

            // Per-bucket limits (SP)
            const limBroad = numVal(document.getElementById("kwPerCampBroad"), 10);
            const limPhrase = numVal(document.getElementById("kwPerCampPhrase"), 10);
            const limExact = numVal(document.getElementById("kwPerCampExact"), 10);
            const limPT = numVal(document.getElementById("ptPerCamp"), 10);

            // Per-bucket limits (SBV)
            const sbvLimBroad = numVal(document.getElementById("sbvPerCampBroad"), 10);
            const sbvLimPhrase = numVal(document.getElementById("sbvPerCampPhrase"), 10);
            const sbvLimExact = numVal(document.getElementById("sbvPerCampExact"), 10);

            const wb = XLSX.utils.book_new();

            // --- Shared Bidding Helpers ---

            // 1. Get Product Avg CPC
            function getProdAvg(groupData, prod, buck) {
              const rows = groupData[prod]?.[buck]?.final || [];
              if (!rows.length) return null;
              let tot = 0, cnt = 0;
              rows.forEach(r => {
                const k = r["Extra KPIs"] || {};
                let c = toNum(k["CPC"]);
                if (isNaN(c) || c <= 0) { const s = toNum(k["Spend"]); const cl = toNum(k["Clicks"]); if (s > 0 && cl > 0) c = s / cl; }
                if (!isNaN(c) && c > 0) { tot += c; cnt++; }
              });
              return cnt === 0 ? null : (tot / cnt);
            }

            // 2. Get Specific Source CPC for a term
            function getSourceCpc(groupData, prod, buck, termValue) {
              const rows = groupData[prod]?.[buck]?.final || [];
              // Find the exact row that generated this term
              const row = rows.find(r => (r["Suggested Value"] === termValue || r["Customer Search Term"] === termValue));
              if (!row) return null;

              const k = row["Extra KPIs"] || {};
              let c = toNum(k["CPC"]);
              // Fallback calc
              if (isNaN(c) || c <= 0) {
                const s = toNum(k["Spend"]);
                const cl = toNum(k["Clicks"]);
                if (s > 0 && cl > 0) c = s / cl;
              }
              return (isNaN(c) || c <= 0) ? null : c;
            }

            // 3. Master Calculator
            function calculateBid(dataset, product, bucket, term, fallbackBid) {
              let final = fallbackBid;

              // Strategy A: Product Avg
              if (strategy === "productAvg") {
                const avg = getProdAvg(dataset, product, bucket);
                if (avg) final = avg;
              }
              // Strategy B: Source CPC (Individual + Modifier)
              else if (strategy === "sourceCpc") {
                const src = getSourceCpc(dataset, product, bucket, term);
                if (src) {
                  final = src * modifierMult; // Apply +10% or -5% etc
                }
              }

              return parseFloat(final).toFixed(2);
            }

            // ============= Sponsored Products Bulk (Dynamic Smart Bids) =============
            if (includeSP) {
              const header = [
                "Product", "Entity", "Operation",
                "Campaign Id", "Ad Group Id", "Portfolio Id", "Ad Id", "Keyword Id", "Product Targeting Id",
                "Campaign Name", "Ad Group Name",
                "Start Date", "End Date", "Targeting Type", "State",
                "Daily Budget", "SKU", "ASIN",
                "Ad Group Default Bid", "Bid", "Keyword Text", "Match Type",
                "Bidding Strategy", "Placement", "Percentage",
                "Product Targeting Expression", "Audience ID", "Shopper Cohort Percentage", "Shopper Cohort Type"
              ];

              const sheet = [header];
              const skuMapOpt1 = getOpt1SkuMap();
              const products = Object.keys(lastGroupedSP || {}).sort();

              // --- Campaign Writer ---
              function writeSpCampaignBundle(product, matchLabel, campaignName, items, isPT) {
                const adGroupName = campaignName;
                let spBudget, spDefaultBid, spAsinBid, sku;

                // Get User Inputs (Fallbacks)
                if (bulkMode === "opt1") {
                  spBudget = numVal(opt1_spBudget, 100);
                  spDefaultBid = numVal(opt1_spDefaultBid, 0.75);
                  spAsinBid = numVal(document.getElementById('opt1_spBidAsin'), 0.75);
                  sku = (skuMapOpt1[product] || "").trim();
                } else {
                  const prof = productProfiles[product] || {};
                  spBudget = prof.spBudget || 100;
                  spDefaultBid = 0.75; spAsinBid = 0.75;
                  sku = (prof.spSku || "").trim();
                }

                // Fallback bid: Ad Group Default Bid (Source CPC used when available)\r\n                let fallbackBid = spDefaultBid;

                // Campaign Row
                sheet.push([
                  "Sponsored Products", "Campaign", "Create",
                  campaignName, "", spPortfolioId, "", "", "",
                  campaignName, "",
                  startDate, "", "Manual", spState,
                  spBudget, "", "",
                  "", "", "", "",
                  spBiddingStrategy, "", "",
                  "", "", "", ""
                ]);

                // Ad Group Row
                sheet.push([
                  "Sponsored Products", "Ad group", "Create",
                  campaignName, adGroupName, "", "", "", "",
                  campaignName, adGroupName,
                  "", "", "", spState,
                  "", "", "",
                  fallbackBid, "", "", "", // Default bid
                  "", "", "", "",
                  "", "", "", ""
                ]);

                // Product Ad Row
                if (sku) {
                  sheet.push([
                    "Sponsored Products", "Product ad", "Create",
                    campaignName, adGroupName, "", "", "", "",
                    campaignName, adGroupName,
                    "", "", "", spState,
                    "", "" + sku, "",
                    "", "", "", "",
                    "", "", "", "",
                    "", "", "", ""
                  ]);
                }

                if (isPT) {
                  items.forEach(val => {
                    const asin = val.toString().trim();
                    if (!asin) return;

                    // CALCULATE BID for this specific ASIN
                    const finalBid = calculateBid(lastGroupedSP, product, "ASIN", asin, fallbackBid);

                    sheet.push([
                      "Sponsored Products", "Product targeting", "Create",
                      campaignName, adGroupName, "", "", "", "",
                      campaignName, adGroupName,
                      "", "", "", spState,
                      "", "", "",
                      "", "" + finalBid, "", "",  // Cols 18, 19, 20, 21
                      "", "", "",               // Cols 22, 23, 24
                      `asin="${asin}"`, "", "", "" // Col 25 (Correct placement), 26, 27, 28
                    ]);
                  });
                } else {
                  items.forEach(term => {
                    // CALCULATE BID for this specific keyword
                    const finalBid = calculateBid(lastGroupedSP, product, matchLabel, term, fallbackBid);

                    sheet.push([
                      "Sponsored Products", "Keyword", "Create",
                      campaignName, adGroupName, "", "", "", "",
                      campaignName, adGroupName,
                      "", "", "", spState,
                      "", "", "",
                      "", finalBid, term, matchLabel, // Uses calculated bid
                      "", "", "",
                      "", "", "", ""
                    ]);
                  });
                }
              }

              for (const product of products) {
                const campTpl = (bulkMode === "opt1")
                  ? strVal(opt1_spCampTpl, "{Product} | SP | {Match} | Harvested")
                  : ((productProfiles[product]?.campTpl) || "{Product} | SP | {Match} | Harvested");

                // Gather lists
                const kwBroad = (lastGroupedSP?.[product]?.["Broad"]?.final || []).map(r => (r["Suggested Value"] || r["Customer Search Term"] || "").toString().trim()).filter(Boolean);
                const kwPhrase = (lastGroupedSP?.[product]?.["Phrase"]?.final || []).map(r => (r["Suggested Value"] || r["Customer Search Term"] || "").toString().trim()).filter(Boolean);
                const kwExact = (lastGroupedSP?.[product]?.["Exact"]?.final || []).map(r => (r["Suggested Value"] || r["Customer Search Term"] || "").toString().trim()).filter(Boolean);
                const asins = (lastGroupedSP?.[product]?.["ASIN"]?.final || []).map(r => (r["Suggested Value"] || r["Customer Search Term"] || "").toString().trim()).filter(Boolean);

                const baseVars = { Product: product, Base: product };

                // Process Keywords (Broad, Phrase, Exact)
                [["Broad", kwBroad, limBroad], ["Phrase", kwPhrase, limPhrase], ["Exact", kwExact, limExact]].forEach(([bucket, list, lim]) => {
                  if (!list.length) return;

                  const vars = { ...baseVars, Match: bucket };
                  let rawBaseName = applyTemplate(campTpl, vars);

                  // --- DEDUPLICATION LOGIC START ---
                  // If "Hat | Harvested" exists, this returns "Hat | Harvested 1"
                  const uniqueRootName = getUniqueCampaignName(rawBaseName);
                  // ---------------------------------

                  const chunks = chunkArray(list, lim);
                  chunks.forEach((chunk, idx) => {
                    // If we split into multiple campaigns (limit exceeded), we append | 1, | 2
                    // Result: "Hat | Harvested 1 | 1"
                    const suffix = (chunks.length > 1) ? ` | ${idx + 1}` : "";
                    const finalCampName = uniqueRootName + suffix;

                    writeSpCampaignBundle(product, bucket, finalCampName, chunk, false);
                  });
                });

                // Process Product Targeting (ASIN)
                if (asins.length) {
                  const vars = { ...baseVars, Match: "PT" };
                  let rawBaseName = applyTemplate(campTpl, vars);

                  // --- DEDUPLICATION LOGIC START ---
                  const uniqueRootName = getUniqueCampaignName(rawBaseName);
                  // ---------------------------------

                  const chunks = chunkArray(asins, limPT);
                  chunks.forEach((chunk, idx) => {
                    const suffix = (chunks.length > 1) ? ` | ${idx + 1}` : "";
                    const finalCampName = uniqueRootName + suffix;
                    writeSpCampaignBundle(product, "PT", finalCampName, chunk, true);
                  });
                }
              }

              const ws = XLSX.utils.aoa_to_sheet(sheet);
              XLSX.utils.book_append_sheet(wb, ws, "SP Bulk");
            }

            // ============= SBV (Enhanced with SB Generator Fields) =============
            if (includeSBV) {

              const sbvHeader = [
                'Product', 'Entity', 'Operation', 'Campaign ID', 'Portfolio ID', 'Ad Group ID', 'Ad ID',
                'Keyword ID', 'Product Targeting ID', 'Campaign Name', 'Ad Group Name', 'Ad Name',
                'Start Date', 'End Date', 'State', 'Brand Entity ID', 'Budget Type', 'Budget',
                'Bid Optimization', 'Product Location', 'Bid', 'Placement', 'Percentage', 'Keyword Text',
                'Match Type', 'Native Language Keyword', 'Native Language Locale', 'Product Targeting Expression',
                'Landing Page URL', 'Landing Page ASINs', 'Landing Page Type', 'Brand Name',
                'Consent To Translate', 'Brand Logo Asset ID', 'Brand Logo Crop', 'Custom Images',
                'Creative Headline', 'Creative ASINs', 'Video Asset IDs', 'Sub-pages'
              ];

              const sbvSheet = [sbvHeader];

              function rowFromMap(map) {
                return sbvHeader.map(h => (map[h] !== undefined ? map[h] : ""));
              }

              const groups = lastGroupedSB || {};
              const skuMapOpt1 = getOpt1SkuMap();

              Object.keys(groups).sort().forEach(product => {
                const obj = groups[product] || {};

                // Loop through each match type
                ["Broad", "Phrase", "Exact"].forEach(bucket => {
                  const finals = obj[bucket]?.final || [];
                  if (!finals.length) return;

                  // Determine limit for this bucket
                  let limit = 10;
                  if (bucket === "Broad") limit = sbvLimBroad;
                  if (bucket === "Phrase") limit = sbvLimPhrase;
                  if (bucket === "Exact") limit = sbvLimExact;

                  // Inputs
                  const video = (bulkMode === "opt1")
                    ? strVal(opt1_sbvVideo, "amzn1.assetlibrary...")
                    : (productProfiles[product]?.sbvVideo || "amzn1.assetlibrary...");

                  const creativeAsin = (bulkMode === "opt1")
                    ? strVal(document.getElementById('opt1_sbvAsin'), "")
                    : (productProfiles[product]?.sbvAsin || "");
                  const finalCreativeAsin = creativeAsin;

                  const budget = (bulkMode === "opt1")
                    ? numVal(opt1_sbvBudget, 50)
                    : (productProfiles[product]?.sbvBudget ?? 50);

                  // Determine Fallback Bid for this bucket
                  let bucketFallback = 0.80;
                  if (bulkMode === "opt1") {
                    bucketFallback = sbvBidForBucket(bucket);
                  } else {
                    bucketFallback = (productProfiles[product]?.sbvBid ?? 0.80);
                  }

                  // Get valid terms
                  const allTerms = finals
                    .map(r => (r["Suggested Value"] || r["Customer Search Term"] || "").toString().trim())
                    .filter(Boolean);

                  if (!allTerms.length) return;

                  // SPLIT LOGIC (Chunking)
                  const chunks = chunkArray(allTerms, limit);

                  chunks.forEach((chunkTerms, idx) => {
                    // Names
                    let campName;
                    if (bulkMode === "opt1") {
                      const vars = { Product: product, Base: product, Match: bucket, Video: video };
                      const baseName = applyTemplate(strVal(opt1_sbvCampTpl, "{Product} | SBV | {Video} | {Match}"), vars);
                      // Append suffix if multiple chunks
                      campName = (chunks.length > 1) ? `${baseName} | ${idx + 1}` : baseName;
                    } else {
                      const baseName = `${product} | SBV | ${video} | ${bucket}`;
                      campName = (chunks.length > 1) ? `${baseName} | ${idx + 1}` : baseName;
                    }
                    const agName = campName;

                    // Generate a timestamped Ad Name
                    const adName = `Video ad - ${new Date().toLocaleDateString()}`;

                    // --- Campaign row ---
                    sbvSheet.push(rowFromMap({
                      "Product": "Sponsored Brands",
                      "Entity": "Campaign",
                      "Operation": "Create",
                      "Campaign ID": campName,
                      "Campaign Name": campName,
                      "Portfolio ID": sbPortfolioId, // Uses SB specific Portfolio ID
                      "Start Date": startDate,
                      "State": (spState === "paused" ? "paused" : "enabled"),
                      "Budget Type": "Daily",
                      "Budget": budget,
                      "Bid Optimization": bidOptimization,
                      "Brand Entity ID": brandEntityId
                    }));

                    // --- Ad group row ---
                    sbvSheet.push(rowFromMap({
                      "Product": "Sponsored Brands",
                      "Entity": "Ad Group",
                      "Operation": "Create",
                      "Campaign ID": campName,
                      "Ad Group ID": agName,
                      "Campaign Name": campName,
                      "Ad Group Name": agName,
                      "State": (spState === "paused" ? "paused" : "enabled")
                    }));

                    // --- Ad (video) row ---
                    sbvSheet.push(rowFromMap({
                      "Product": "Sponsored Brands",
                      "Entity": "Video ad",
                      "Operation": "Create",
                      "Campaign ID": campName,
                      "Ad Group ID": agName,
                      "Ad Name": adName,
                      "Campaign Name": campName,
                      "Ad Group Name": agName,
                      "State": (spState === "paused" ? "paused" : "enabled"),
                      "Video Asset IDs": video,
                      "Creative ASINs": finalCreativeAsin,
                      "Landing Page URL": finalCreativeAsin ? `https://www.amazon.com/dp/${finalCreativeAsin}` : "",
                      "Landing Page Type": "Detail Page",
                      "Brand Entity ID": brandEntityId
                    }));

                    // --- Keyword rows (chunked) ---
                    chunkTerms.forEach(term => {
                      // CALCULATE BID for this specific keyword
                      const finalBid = calculateBid(lastGroupedSB, product, bucket, term, bucketFallback);

                      sbvSheet.push(rowFromMap({
                        "Product": "Sponsored Brands",
                        "Entity": "Keyword",
                        "Operation": "Create",
                        "Campaign ID": campName,
                        "Ad Group ID": agName,
                        "Campaign Name": campName,
                        "Ad Group Name": agName,
                        "State": (spState === "paused" ? "paused" : "enabled"),
                        "Bid": finalBid,
                        "Keyword Text": term,
                        "Match Type": bucket
                      }));
                    });
                  });
                });
              });

              const ws = XLSX.utils.aoa_to_sheet(sbvSheet);
              XLSX.utils.book_append_sheet(wb, ws, "SBV Bulk");
            }

            XLSX.writeFile(wb, "TermHarvester_BulkUpload.xlsx");

            // Display strategy used
            let strategyName = "Fixed Bids";
            if (strategy === "productAvg") strategyName = "Product Avg CPC";
            else if (strategy === "sourceCpc") strategyName = `Source CPC (${modifierPct >= 0 ? '+' : ''}${modifierPct}%)`;

            bulkStatus.textContent = `✅ Exported using ${strategyName} strategy.`;
            bulkStatus.className = "text-success";

            // Calculate export summary
            const products = [...(Object.keys(lastGroupedSP || {})), ...(Object.keys(lastGroupedSB || {}))];
            const uniqueProducts = new Set(products);

            let totalKeywords = 0;
            let totalAsins = 0;
            let totalCampaigns = 0;

            if (includeSP && lastGroupedSP) {
              Object.values(lastGroupedSP).forEach(prod => {
                ['Broad', 'Phrase', 'Exact'].forEach(bucket => {
                  const list = prod[bucket]?.final || [];
                  totalKeywords += list.length;
                  if (list.length > 0) totalCampaigns++;
                });
                const asinList = prod['ASIN']?.final || [];
                totalAsins += asinList.length;
                if (asinList.length > 0) totalCampaigns++;
              });
            }

            if (includeSBV && lastGroupedSB) {
              Object.values(lastGroupedSB).forEach(prod => {
                ['Broad', 'Phrase', 'Exact'].forEach(bucket => {
                  const list = prod[bucket]?.final || [];
                  totalKeywords += list.length;
                  if (list.length > 0) totalCampaigns++;
                });
              });
            }

            // Show success modal with renamed campaigns info
            showSuccessModal(totalCampaigns, totalKeywords, totalAsins, strategyName, renamedCampaignsList);
          }

          function showSuccessModal(campaigns, keywords, asins, strategy, renamedList) {
            document.getElementById('summCampaigns').textContent = campaigns;
            document.getElementById('summKeywords').textContent = keywords;
            document.getElementById('summAsins').textContent = asins;
            document.getElementById('summStrategy').textContent = strategy;

            // Calculate hours saved dynamically
            // 5 min per campaign, 2 min per keyword, 2 min per ASIN
            const totalMinutes = (campaigns * 5) + (keywords * 2) + (asins * 2);
            const hoursNum = totalMinutes / 60;
            let hoursText = '';
            if (hoursNum < 1) {
              hoursText = `${totalMinutes} minutes`;
            } else if (hoursNum < 2) {
              hoursText = `~${hoursNum.toFixed(1)} hour`;
            } else {
              hoursText = `~${hoursNum.toFixed(1)} hours`;
            }
            document.getElementById('summHoursSaved').textContent = hoursText;

            // Display renamed campaigns if any
            const renamedSection = document.getElementById('renamedCampaignsSection');
            const renamedListEl = document.getElementById('renamedCampaignsList');

            if (renamedList && renamedList.length > 0) {
              renamedSection.style.display = 'block';
              renamedListEl.innerHTML = renamedList.map(item =>
                `<div style="font-size:12px; padding:4px 0; border-bottom:1px solid #f1f5f9;">
            <span style="color:#991b1b; text-decoration:line-through;">${escapeHtml(item.original)}</span>
            <span style="color:#64748b;"> → </span>
            <span style="color:#166534; font-weight:600;">${escapeHtml(item.renamed)}</span>
          </div>`
              ).join('');
            } else {
              renamedSection.style.display = 'none';
              renamedListEl.innerHTML = '';
            }

            const modal = document.getElementById('successModal');
            modal.style.display = 'flex';

            // Confetti effect (optional - simple version)
            setTimeout(() => {
              // Add subtle celebration animation
              modal.querySelector('svg').style.animation = 'bounce 0.6s ease-out';
            }, 100);

            // Track first export milestone
            const firstExport = !localStorage.getItem('termHarvester_firstExport');
            if (firstExport) {
              localStorage.setItem('termHarvester_firstExport', new Date().toISOString());
            }
          }

          function closeSuccessModal() {
            document.getElementById('successModal').style.display = 'none';
          }

          // --- Keyboard Shortcuts ---
          const shortcuts = {
            'e': () => {
              // Export current view
              if (!bulkExportControls.classList.contains('hidden')) {
                btnExportBulk.click();
              }
            },
            'r': () => {
              // Run analysis
              if (!processBtn.disabled) {
                processBtn.click();
              }
            },
            's': () => {
              // Save session
              saveSession();
              showToast('💾 Session saved');
            },
            '/': (e) => {
              // Focus search
              e.preventDefault();
              uiSearch.focus();
            },
            '?': () => {
              // Show shortcuts help
              showShortcutsHelp();
            },
            'Escape': () => {
              // Close modals
              if (document.getElementById('successModal').style.display === 'flex') {
                closeSuccessModal();
              }
              if (document.getElementById('copyModal').style.display === 'flex') {
                closeCopyModal();
              }
            }
          };

          document.addEventListener('keydown', (e) => {
            // Ignore if typing in input/textarea
            if (e.target.matches('input, textarea, select')) {
              // Allow escape even in inputs
              if (e.key === 'Escape') {
                e.target.blur();
              }
              return;
            }

            // Check for shortcuts
            const key = e.key;
            if (shortcuts[key]) {
              shortcuts[key](e);
            }
          });

          function showShortcutsHelp() {
            alert(`⌨️ Keyboard Shortcuts:

• E - Export bulk file
• R - Run analysis
• S - Save session
• / - Focus search
• ? - Show this help
• Esc - Close modals

More shortcuts coming soon!`);
          }

          // --- Accessibility Improvements ---

          // Add skip to main content link
          const skipLink = document.createElement('a');
          skipLink.href = '#results';
          skipLink.textContent = 'Skip to main content';
          skipLink.className = 'sr-only';
          skipLink.style.cssText = `
      position: fixed;
      top: -100px;
      left: 0;
      background: var(--primary);
      color: white;
      padding: var(--space-2);
      z-index: 9999;
      transition: top var(--transition-fast);
    `;
          skipLink.addEventListener('focus', () => {
            skipLink.style.top = '0';
          });
          skipLink.addEventListener('blur', () => {
            skipLink.style.top = '-100px';
          });
          document.body.insertBefore(skipLink, document.body.firstChild);

          // Add ARIA labels to important elements
          if (processBtn) processBtn.setAttribute('aria-label', 'Run analysis on uploaded reports');
          if (btnExportBulk) btnExportBulk.setAttribute('aria-label', 'Download bulk upload file');
          if (uiSearch) uiSearch.setAttribute('aria-label', 'Search products and terms');

          // Announce step progress changes to screen readers
          const announcer = document.createElement('div');
          announcer.setAttribute('role', 'status');
          announcer.setAttribute('aria-live', 'polite');
          announcer.className = 'sr-only';
          document.body.appendChild(announcer);

          function announce(message) {
            announcer.textContent = message;
            setTimeout(() => {
              announcer.textContent = '';
            }, 1000);
          }

          // Enhance step progress with announcements
          const originalUpdateStep = updateStepProgress;
          updateStepProgress = function (step) {
            originalUpdateStep(step);
            const steps = ['Upload files', 'Configure rules', 'Review results', 'Export bulk file'];
            if (steps[step - 1]) {
              announce(`Step ${step} of 4: ${steps[step - 1]}`);
            }
          };

          /* --- KPI Profile System --- */
          function loadKpiProfile() {
            const select = document.getElementById('kpiProfileSelect');
            const profileName = select.value;

            if (!profileName) return;

            const profile = kpiProfiles[profileName];
            if (!profile) {
              // Try to load custom profile from localStorage
              try {
                const saved = localStorage.getItem(`termHarvester_kpiProfile_${profileName}`);
                if (saved) {
                  const customProfile = JSON.parse(saved);
                  applyProfileToAllProducts(customProfile);
                  showKpiProfilePreview(profileName, customProfile);
                  showToast(`✓ Loaded custom profile: ${profileName}`);
                  return;
                }
              } catch (e) { }
            } else {
              // Apply preset profile
              applyProfileToAllProducts(profile);
              showKpiProfilePreview(profileName, profile);
              showToast(`✓ Applied ${select.options[select.selectedIndex].text} profile`);
            }
          }

          function applyProfileToAllProducts(profile) {
            // First, enable/disable KPI checkboxes based on profile
            document.querySelectorAll('.kpi-check').forEach(checkbox => {
              const kpi = checkbox.value;
              if (profile.hasOwnProperty(kpi)) {
                checkbox.checked = true;
              }
            });

            // Rebuild inputs with new KPIs
            rebuildProductInputs();

            // Apply values to all product inputs
            setTimeout(() => {
              document.querySelectorAll('#productRulesContainer input').forEach(input => {
                const kpi = input.getAttribute('data-kpi');
                if (profile.hasOwnProperty(kpi)) {
                  input.value = profile[kpi];

                  // Trigger change event to save to productRulesState
                  input.dispatchEvent(new Event('input'));
                }
              });
            }, 100);
          }

          function saveKpiProfile() {
            const profileName = prompt('Enter a name for this KPI profile:', '');
            if (!profileName) return;

            // Collect current KPI rules from the first product (as template)
            const firstProduct = detectedProducts[0];
            if (!firstProduct) {
              alert('No products detected. Upload files first.');
              return;
            }

            const rules = productRulesState[firstProduct] || {};

            // Save to localStorage
            try {
              kpiProfiles[profileName] = rules;
              localStorage.setItem(`termHarvester_kpiProfile_${profileName}`, JSON.stringify(rules));

              // Add to dropdown if not exists
              const select = document.getElementById('kpiProfileSelect');
              const exists = Array.from(select.options).some(opt => opt.value === profileName);
              if (!exists) {
                const option = document.createElement('option');
                option.value = profileName;
                option.textContent = profileName;
                select.appendChild(option);
              }

              select.value = profileName;
              showKpiProfilePreview(profileName, rules);
              showToast(`✓ Saved profile: ${profileName}`);
            } catch (e) {
              alert('Error saving profile: ' + e.message);
            }
          }

          function showKpiProfilePreview(name, profile) {
            const previewSection = document.getElementById('kpiProfilePreview');
            const previewContent = document.getElementById('kpiProfilePreviewContent');

            if (!profile || Object.keys(profile).length === 0) {
              previewSection.style.display = 'none';
              return;
            }

            previewSection.style.display = 'block';

            const rulesList = [];
            const kpiLabels = {
              orders: 'Orders ≥',
              acos: 'ACoS ≤',
              spend: 'Spend ≤',
              clicks: 'Clicks ≥',
              cv: 'Conv Rate ≥',
              ctr: 'CTR ≥'
            };

            for (const [kpi, value] of Object.entries(profile)) {
              const label = kpiLabels[kpi] || kpi;
              rulesList.push(`${label} ${value}${kpi.includes('acos') || kpi.includes('cv') || kpi.includes('ctr') ? '%' : ''}`);
            }

            previewContent.innerHTML = rulesList.join(' • ');
          }

          // Load saved custom profiles on page load
          window.addEventListener('DOMContentLoaded', () => {
            try {
              const keys = Object.keys(localStorage);
              keys.forEach(key => {
                if (key.startsWith('termHarvester_kpiProfile_')) {
                  const profileName = key.replace('termHarvester_kpiProfile_', '');
                  const select = document.getElementById('kpiProfileSelect');
                  const exists = Array.from(select.options).some(opt => opt.value === profileName);
                  if (!exists) {
                    const option = document.createElement('option');
                    option.value = profileName;
                    option.textContent = profileName;
                    select.appendChild(option);
                  }
                }
              });
            } catch (e) { }
          });

          /* --- Product Extraction Configuration --- */
          function toggleProductExtractionUI() {
            const method = document.getElementById('productExtractionMethod').value;
            productExtractionConfig.method = method;

            const regexInput = document.getElementById('regexPatternInput');
            const manualInput = document.getElementById('manualMappingInput');

            regexInput.style.display = (method === 'regex') ? 'block' : 'none';
            manualInput.style.display = (method === 'manual') ? 'block' : 'none';

            // If data already loaded, re-extract products
            if (spRowsRaw.length > 0 || sbRowsRaw.length > 0) {
              buildProductListAndInputsFromBoth();
              showProductPreview();
            }

            // Store preference
            try {
              localStorage.setItem('termHarvester_extractionMethod', method);
            } catch (e) { }
          }

          function loadProductMapping(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
              const text = e.target.result;
              const lines = text.split('\n');

              productExtractionConfig.manualMapping = {};

              for (let i = 0; i < lines.length; i++) {
                const parts = lines[i].split(',');
                if (parts.length >= 2) {
                  const pattern = parts[0].trim();
                  const productName = parts[1].trim();
                  if (pattern && productName) {
                    productExtractionConfig.manualMapping[pattern] = productName;
                  }
                }
              }

              showToast(`✓ Loaded ${Object.keys(productExtractionConfig.manualMapping).length} product mappings`);

              // Re-extract if data exists
              if (spRowsRaw.length > 0 || sbRowsRaw.length > 0) {
                buildProductListAndInputsFromBoth();
                showProductPreview();
              }
            };

            reader.readAsText(file);
          }

          function showProductPreview() {
            const previewSection = document.getElementById('productPreviewSection');
            const previewList = document.getElementById('productPreviewList');

            if (!detectedProducts || detectedProducts.length === 0) {
              previewSection.style.display = 'none';
              return;
            }

            previewSection.style.display = 'block';
            previewList.innerHTML = detectedProducts
              .slice(0, 20)
              .map(p => `<div style="padding:2px 0;">• ${escapeHtml(p)}</div>`)
              .join('');

            if (detectedProducts.length > 20) {
              previewList.innerHTML += `<div style="padding:4px 0; font-style:italic; color:var(--text-muted);">...and ${detectedProducts.length - 20} more</div>`;
            }
          }

          /* --- Workflow Mode Selection --- */
          function selectWorkflow(mode) {
            currentWorkflow = mode;

            // Update UI: Remove 'active' from all cards
            document.querySelectorAll('.workflow-card').forEach(card => {
              card.classList.remove('active');
            });

            // Add 'active' to selected card
            const selectedCard = document.querySelector(`.workflow-card[data-workflow="${mode}"]`);
            if (selectedCard) {
              selectedCard.classList.add('active');
            }

            // Adapt UI based on workflow
            const dataSourcePanel = document.querySelector('.panel:has(#dropSP)');
            const kpiPanel = document.querySelector('.panel:has(.kpi-check)');
            const productRulesPanel = document.querySelector('.panel:has(#productRulesContainer)');
            const resultsArea = document.querySelector('#results');
            const bulkSection = document.querySelector('#bulkStepPanel');

            // Reset visibility
            if (dataSourcePanel) dataSourcePanel.style.display = 'block';
            if (kpiPanel) kpiPanel.style.display = 'block';
            if (productRulesPanel) productRulesPanel.style.display = 'block';

            switch (mode) {
              case 'harvest':
                // Default mode - all features enabled
                showToast('✓ Harvest Winners: Upload SP/SB reports to extract top performers');
                break;

              case 'launch':
                // Skip upload, go straight to bulk creation
                if (dataSourcePanel) dataSourcePanel.style.display = 'none';
                if (kpiPanel) kpiPanel.style.display = 'none';
                if (productRulesPanel) {
                  productRulesPanel.querySelector('.panel-title').textContent = '2. Enter Product List';
                  productRulesPanel.innerHTML = `
              <div class="panel-title"> <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"> <line x1="12" y1="1" x2="12" y2="23"></line> <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path> </svg>
                2. Product List for Launch
              </div> <div style="font-size:11px; color:var(--text-muted); margin-bottom:12px;">
                Enter product names or ASINs (one per line):
              </div> <textarea id="launchProductList" class="form-input" rows="8" 
                placeholder="Example:&#10;Premium Widget A&#10;Deluxe Widget B&#10;Budget Widget C"
                style="font-family: monospace; font-size:12px;"></textarea> <button class="btn btn-primary" style="width:100%; margin-top:12px;" onclick="processLaunchMode()">
                Create Launch Campaigns
              </button>
            `;
                }
                showToast('✓ Launch Mode: No upload needed - enter products to create starter campaigns');
                break;

              case 'asin':
                // Only extract ASINs, skip keywords
                showToast('✓ ASIN Expansion: Upload reports - only Product Targeting will be generated');
                break;

              case 'branded':
                // Extract terms, force Exact match only
                showToast('✓ Branded Defense: Upload reports - only Exact match campaigns for brand protection');
                break;

              case 'auto2manual':
                // Parse auto campaign reports differently
                showToast('✓ Auto → Manual: Upload auto campaign reports to graduate winners to manual');
                break;

              case 'custom':
                // Show all advanced options
                showToast('✓ Custom Mode: Full control - all advanced features enabled');
                break;
            }

            // Store preference
            try {
              localStorage.setItem('termHarvester_workflow', mode);
            } catch (e) { }
          }

          // Process Launch Mode (no upload needed)
          function processLaunchMode() {
            const textarea = document.getElementById('launchProductList');
            if (!textarea) return;

            const lines = textarea.value.split('\n')
              .map(l => l.trim())
              .filter(l => l.length > 0);

            if (lines.length === 0) {
              alert('Please enter at least one product name or ASIN');
              return;
            }

            // Simulate detected products
            detectedProducts = lines;

            // Skip to bulk export section
            document.getElementById('bulkCtaWrap').style.display = 'block';
            document.getElementById('bulkStepPanel').style.display = 'block';

            // Build SKU map UI
            buildOpt1SkuMapUI();

            // Scroll to bulk section
            document.getElementById('bulkStepPanel').scrollIntoView({ behavior: 'smooth' });

            showToast(`✓ ${lines.length} products ready for campaign creation`);
          }

          // Restore workflow on load
          window.addEventListener('DOMContentLoaded', () => {
            try {
              const saved = localStorage.getItem('termHarvester_workflow');
              if (saved && saved !== 'harvest') {
                selectWorkflow(saved);
              }
            } catch (e) { }
          });

          /* --- Suggestions Export + Copy --- */
          function showToast(msg) {
            if (!toastEl) return;
            toastEl.textContent = msg;
            toastEl.style.display = "block";
            clearTimeout(showToast._t);
            showToast._t = setTimeout(() => { toastEl.style.display = "none"; }, 2200);
          }

          function collectAllSuggestionsDetailed() {
            const out = [];
            const bucketOrder = ["ASIN", "Broad", "Phrase", "Exact"];
            const pushFrom = (grouped, sourceLabel) => {
              if (!grouped) return;
              Object.keys(grouped).forEach(product => {
                bucketOrder.forEach(bucket => {
                  const obj = grouped[product]?.[bucket];
                  if (!obj) return;
                  ["final", "excluded"].forEach(section => {
                    const arr = obj[section] || [];
                    arr.forEach(r => {
                      const term = (r["Suggested Value"] || r["Customer Search Term"] || "").toString().trim();
                      if (!term) return;
                      out.push({
                        "Source": sourceLabel,
                        "Product": product,
                        "Bucket": bucket,
                        "Status": section.toUpperCase(),
                        "Suggested Value": term,
                        "Orders": r["Orders"] ?? "",
                        "ACoS %": r["ACoS %"] ?? "",
                        "Duplicate?": r["Duplicate?"] ?? "",
                        "Source Campaign Name": r["Source Campaign Name"] ?? "",
                        "Source Match Type": r["Source Match Type"] ?? "",
                        "Targeting (raw)": r["Targeting (raw)"] ?? ""
                      });
                    });
                  });
                });
              });
            };
            pushFrom(lastGroupedSP, "SP");
            pushFrom(lastGroupedSB, "SB");
            return out;
          }

          function ensureSuggestionsBarVisibility() {
            const hasAny = (lastGroupedSP && Object.keys(lastGroupedSP).length) || (lastGroupedSB && Object.keys(lastGroupedSB).length);
            if (!suggestionsBar) return;
            suggestionsBar.classList.toggle("hidden", !hasAny);
          }

          function exportSuggestionsXlsx() {
            const rows = collectAllSuggestionsDetailed();
            if (!rows.length) { showToast("No suggestions to export."); return; }

            const header = Object.keys(rows[0]);
            const aoa = [header];
            rows.forEach(r => aoa.push(header.map(h => r[h] ?? "")));

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(aoa);
            XLSX.utils.book_append_sheet(wb, ws, "Suggestions");
            XLSX.writeFile(wb, "TermHarvester_Suggestions.xlsx");
            showToast("Exported: TermHarvester_Suggestions.xlsx");
          }

          function exportSuggestionsCsv() {
            const rows = collectAllSuggestionsDetailed();
            if (!rows.length) { showToast("No suggestions to export."); return; }

            const header = Object.keys(rows[0]);
            const escapeCsv = (v) => {
              const s = (v ?? "").toString();
              if (/[",\n\r]/.test(s)) return '"' + s.replace(/"/g, '""') + '"';
              return s;
            };
            const lines = [];
            lines.push(header.map(escapeCsv).join(","));
            rows.forEach(r => lines.push(header.map(h => escapeCsv(r[h])).join(",")));
            const csv = lines.join("\n");

            const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "TermHarvester_Suggestions.csv";
            document.body.appendChild(a);
            a.click();
            a.remove();
            setTimeout(() => URL.revokeObjectURL(url), 500);
            showToast("Exported: TermHarvester_Suggestions.csv");
          }

          async function copyAllSuggestionsToClipboard() {
            // Copy FINAL suggestions only (clean list)
            const finals = [];
            const bucketOrder = ["ASIN", "Broad", "Phrase", "Exact"];
            const takeFinals = (grouped) => {
              if (!grouped) return;
              Object.keys(grouped).forEach(product => {
                bucketOrder.forEach(bucket => {
                  const arr = grouped[product]?.[bucket]?.final || [];
                  arr.forEach(r => {
                    const term = (r["Suggested Value"] || r["Customer Search Term"] || "").toString().trim();
                    if (!term) return;
                    finals.push({ product, bucket, term });
                  });
                });
              });
            };
            takeFinals(lastGroupedSP);
            takeFinals(lastGroupedSB);

            if (!finals.length) { showToast("No FINAL suggestions to copy."); return; }

            const txt = finals.map(x => `${x.product}\t${x.bucket}\t${x.term}`).join("\n");

            if (navigator.clipboard && window.isSecureContext) {
              await navigator.clipboard.writeText(txt);
            } else {
              const ta = document.createElement("textarea");
              ta.value = txt;
              ta.style.position = "fixed";
              ta.style.left = "-9999px";
              document.body.appendChild(ta);
              ta.focus(); ta.select();
              document.execCommand("copy");
              ta.remove();
            }
            showToast(`Copied ${finals.length} rows (FINAL).`);
          }

          /* --- Popover Logic --- */
          (function initHelpPopovers() { const pop = document.getElementById("helpPopover"); const popContent = document.getElementById("helpPopoverContent"); const arrow = pop.querySelector(".arrow"); let activeIcon = null; let hideTimer = null; function clamp(n, min, max) { return Math.max(min, Math.min(max, n)); } function show(icon) { const wrap = icon.closest(".help-wrap"); if (!wrap) return; const localTooltip = wrap.querySelector(".help-tooltip"); if (!localTooltip) return; popContent.innerHTML = localTooltip.innerHTML; pop.style.display = "block"; pop.setAttribute("aria-hidden", "false"); const r = icon.getBoundingClientRect(); const margin = 10; const popR = pop.getBoundingClientRect(); const spaceBelow = window.innerHeight - r.bottom; const spaceAbove = r.top; let top; let place = "bottom"; if (spaceBelow >= popR.height + 14) { top = r.bottom + 10; place = "bottom"; } else if (spaceAbove >= popR.height + 14) { top = r.top - popR.height - 10; place = "top"; } else { if (spaceBelow >= spaceAbove) { top = r.bottom + 10; place = "bottom"; } else { top = r.top - popR.height - 10; place = "top"; } } let left = r.left - 6; left = clamp(left, margin, window.innerWidth - popR.width - margin); top = clamp(top, margin, window.innerHeight - popR.height - margin); pop.style.left = `${left}px`; pop.style.top = `${top}px`; const iconCenter = r.left + (r.width / 2); const arrowLeft = clamp(iconCenter - left - 5, 12, popR.width - 22); arrow.style.left = `${arrowLeft}px`; if (place === "top") { arrow.style.top = ""; arrow.style.bottom = "-5px"; } else { arrow.style.bottom = ""; arrow.style.top = "-5px"; } activeIcon = icon; } function hide() { pop.style.display = "none"; pop.setAttribute("aria-hidden", "true"); activeIcon = null; } document.addEventListener("mouseenter", (e) => { const icon = e.target.closest(".help-icon"); if (!icon) return; clearTimeout(hideTimer); show(icon); }, true); document.addEventListener("mouseleave", (e) => { const icon = e.target.closest(".help-icon"); if (!icon) return; hideTimer = setTimeout(hide, 120); }, true); pop.addEventListener("mouseenter", () => clearTimeout(hideTimer)); pop.addEventListener("mouseleave", () => hide()); document.addEventListener("click", (e) => { const icon = e.target.closest(".help-icon"); if (icon) { if (activeIcon === icon) hide(); else show(icon); e.preventDefault(); return; } if (!e.target.closest("#helpPopover")) hide(); }); window.addEventListener("scroll", () => { if (activeIcon) show(activeIcon); }, true); window.addEventListener("resize", () => { if (activeIcon) show(activeIcon); }); })();

          // --- Step Progress Management ---
          let currentStep = 1;

          function updateStepProgress(step) {
            currentStep = step;
            const stepItems = document.querySelectorAll('.step-item');

            stepItems.forEach((item, index) => {
              const stepNum = index + 1;
              item.classList.remove('active', 'completed');

              if (stepNum < step) {
                item.classList.add('completed');
                // Hide number, show checkmark
                const numberEl = item.querySelector('.step-number');
                numberEl.textContent = '';
              } else if (stepNum === step) {
                item.classList.add('active');
                // Show number
                const numberEl = item.querySelector('.step-number');
                numberEl.textContent = stepNum;
              } else {
                // Show number for future steps
                const numberEl = item.querySelector('.step-number');
                numberEl.textContent = stepNum;
              }
            });
          }

          // Track file uploads to advance to step 2
          let filesUploaded = { sp: false, sb: false, ref: false };

          function checkStepProgress() {
            // Step 1: Upload files
            if (!filesUploaded.ref) {
              updateStepProgress(1);
              return;
            }

            // Step 2: Configure rules (at least one file uploaded)
            if (!filesUploaded.sp && !filesUploaded.sb) {
              updateStepProgress(1);
              return;
            }

            updateStepProgress(2);

            // Step 3: Review results (after processing)
            if (lastGroupedSP || lastGroupedSB) {
              updateStepProgress(3);
            }

            // Step 4: Export (bulk panel visible)
            if (!bulkExportControls.classList.contains('hidden')) {
              updateStepProgress(4);
            }
          }

          // --- Session Persistence ---
          const SESSION_KEY = 'termHarvesterSession';

          function saveSession() {
            const session = {
              productRulesState: productRulesState,
              filesUploaded: filesUploaded,
              currentStep: currentStep,
              activeKpis: Array.from(document.querySelectorAll('.kpi-check:checked')).map(c => c.value),
              bulkConfig: {
                startDate: bulkStartDate?.value || '',
                state: bulkState?.value || 'Enabled',
                bidStrategy: document.getElementById('spBidStrategy')?.value || 'productAvg'
              },
              timestamp: new Date().toISOString()
            };

            try {
              localStorage.setItem(SESSION_KEY, JSON.stringify(session));
            } catch (e) {
              console.warn('Failed to save session:', e);
            }
          }

          function loadSession() {
            try {
              const saved = localStorage.getItem(SESSION_KEY);
              if (!saved) return false;

              const session = JSON.parse(saved);
              const timestamp = new Date(session.timestamp);
              const hoursSince = (new Date() - timestamp) / (1000 * 60 * 60);

              // Only restore if < 24 hours old
              if (hoursSince > 24) {
                localStorage.removeItem(SESSION_KEY);
                return false;
              }

              // Auto-restore without asking (removed confirm dialog)

              // Restore state
              productRulesState = session.productRulesState || {};
              filesUploaded = session.filesUploaded || { sp: false, sb: false, ref: false };

              // Restore KPI checkboxes
              if (session.activeKpis) {
                document.querySelectorAll('.kpi-check').forEach(c => {
                  c.checked = session.activeKpis.includes(c.value);
                });
              }

              // Restore bulk config
              if (session.bulkConfig) {
                if (bulkStartDate && session.bulkConfig.startDate) {
                  bulkStartDate.value = session.bulkConfig.startDate;
                }
                if (bulkState && session.bulkConfig.state) {
                  bulkState.value = session.bulkConfig.state;
                }
                if (session.bulkConfig.bidStrategy) {
                  const stratEl = document.getElementById('spBidStrategy');
                  if (stratEl) stratEl.value = session.bulkConfig.bidStrategy;
                }
              }

              // Build detailed restore summary
              const restoredDetails = [];

              // Count products with saved rules
              const productCount = Object.keys(productRulesState).length;
              if (productCount > 0) {
                restoredDetails.push(`${productCount} product rules`);
              }

              // List active KPIs
              if (session.activeKpis && session.activeKpis.length > 0) {
                const kpiLabels = {
                  orders: 'Orders',
                  acos: 'ACoS',
                  spend: 'Spend',
                  clicks: 'Clicks',
                  cv: 'Conv Rate',
                  ctr: 'CTR'
                };
                const activeKpiNames = session.activeKpis.map(k => kpiLabels[k] || k).join(', ');
                restoredDetails.push(`KPIs: ${activeKpiNames}`);
              }

              // Bulk config settings
              const bulkSettings = [];
              if (session.bulkConfig?.startDate) {
                bulkSettings.push('Start Date');
              }
              if (session.bulkConfig?.state && session.bulkConfig.state !== 'Enabled') {
                bulkSettings.push(`State: ${session.bulkConfig.state}`);
              }
              if (bulkSettings.length > 0) {
                restoredDetails.push(bulkSettings.join(', '));
              }

              // Show detailed toast
              if (restoredDetails.length > 0) {
                const timeAgo = hoursSince < 1 ? `${Math.round(hoursSince * 60)} min ago` : `${Math.round(hoursSince)} hr ago`;
                showToast(`✅ Session Restored (${timeAgo}): ${restoredDetails.join(' • ')}`);
              } else {
                showToast('✅ Previous session restored');
              }

              return true;
            } catch (e) {
              console.warn('Failed to load session:', e);
              return false;
            }
          }

          function clearSession() {
            localStorage.removeItem(SESSION_KEY);
            showToast('Session cleared');
          }

          // Auto-save session on changes
          let saveTimeout;
          function autoSaveSession() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
              saveSession();
            }, 2000); // Debounce 2 seconds
          }

          // Trigger auto-save on important actions
          document.addEventListener('change', (e) => {
            if (e.target.matches('.kpi-check, input[data-product], #spBidStrategy, #bulkStartDate, #bulkState')) {
              autoSaveSession();
            }
          });

          // Initialize step progress
          updateStepProgress(1);

          // Try to restore session on load
          setTimeout(() => {
            const restored = loadSession();

            // Show tour for first-time users (if session not restored)
            if (!restored && !localStorage.getItem('termHarvester_tourCompleted')) {
              showTour();
            }
          }, 500);

          // --- Simple Tour System ---
          const tourSteps = [
            {
              element: '#dropZoneBulkRef',
              title: '👋 Start Here',
              message: 'First, upload your Campaign Export to prevent creating duplicate campaigns.',
              position: 'right'
            },
            {
              element: '#dropZoneSP',
              title: '📊 Upload Reports',
              message: 'Add your Search Term Reports (SP and/or SB) to analyze performance data.',
              position: 'right'
            },
            {
              element: '.kpi-check',
              title: '🎯 Choose KPIs',
              message: 'Select which metrics matter for your harvest. The inputs below will update automatically.',
              position: 'right'
            },
            {
              element: '#processBtn',
              title: '⚡ Run Analysis',
              message: 'Click here when ready. We\'ll analyze your data and show suggestions in seconds.',
              position: 'right'
            },
            {
              element: '#stepProgress',
              title: '🗺️ Track Progress',
              message: 'The progress indicator shows where you are in the workflow. Follow the 4 steps!',
              position: 'bottom'
            }
          ];

          let currentTourStep = 0;
          let tourOverlay = null;

          function showTour() {
            if (!confirm('Would you like a quick tour of Term Harvester Pro? (Takes 30 seconds)')) {
              localStorage.setItem('termHarvester_tourCompleted', 'skipped');
              return;
            }

            currentTourStep = 0;
            showTourStep(0);
          }

          function showTourStep(index) {
            if (index >= tourSteps.length) {
              endTour();
              return;
            }

            const step = tourSteps[index];
            const element = document.querySelector(step.element);

            if (!element) {
              // Skip to next if element not found
              showTourStep(index + 1);
              return;
            }

            // Create overlay
            if (!tourOverlay) {
              tourOverlay = document.createElement('div');
              tourOverlay.id = 'tourOverlay';
              tourOverlay.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.7);
          z-index: 9998;
          display: flex;
          align-items: center;
          justify-content: center;
        `;
              document.body.appendChild(tourOverlay);
            }

            // Highlight element
            const rect = element.getBoundingClientRect();
            element.style.position = 'relative';
            element.style.zIndex = '9999';
            element.style.boxShadow = '0 0 0 4px var(--primary), 0 0 0 9999px rgba(0,0,0,0.7)';

            // Create tooltip
            const tooltip = document.createElement('div');
            tooltip.className = 'tour-tooltip animate-slideUp';
            tooltip.style.cssText = `
        position: fixed;
        background: white;
        padding: var(--space-3);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-xl);
        max-width: 320px;
        z-index: 10000;
      `;

            tooltip.innerHTML = `
        <div style="font-size: var(--text-lg); font-weight: 700; margin-bottom: var(--space-1); color: var(--text-primary);">
          ${step.title}
        </div> <div style="font-size: var(--text-sm); color: var(--text-secondary); margin-bottom: var(--space-3); line-height: 1.5;">
          ${step.message}
        </div> <div style="display: flex; justify-content: space-between; align-items: center;"> <span style="font-size: var(--text-xs); color: var(--text-muted);">
            ${index + 1} of ${tourSteps.length}
          </span> <div style="display: flex; gap: var(--space-1);"> <button class="btn btn-sm btn-tertiary" onclick="endTour()">Skip</button> <button class="btn btn-sm btn-primary" onclick="nextTourStep()">
              ${index === tourSteps.length - 1 ? 'Finish' : 'Next'}
            </button> </div> </div>
      `;

            // Position tooltip
            const tooltipY = rect.bottom + 20;
            const tooltipX = rect.left;
            tooltip.style.top = tooltipY + 'px';
            tooltip.style.left = tooltipX + 'px';

            document.body.appendChild(tooltip);

            // Store reference for cleanup
            element.setAttribute('data-tour-active', 'true');
            tooltip.setAttribute('data-tour-tooltip', 'true');
          }

          function nextTourStep() {
            cleanupTourStep();
            currentTourStep++;
            showTourStep(currentTourStep);
          }

          function cleanupTourStep() {
            // Remove highlight
            const highlighted = document.querySelector('[data-tour-active]');
            if (highlighted) {
              highlighted.style.position = '';
              highlighted.style.zIndex = '';
              highlighted.style.boxShadow = '';
              highlighted.removeAttribute('data-tour-active');
            }

            // Remove tooltip
            const tooltip = document.querySelector('[data-tour-tooltip]');
            if (tooltip) {
              tooltip.remove();
            }
          }

          function endTour() {
            cleanupTourStep();
            if (tourOverlay) {
              tourOverlay.remove();
              tourOverlay = null;
            }
            localStorage.setItem('termHarvester_tourCompleted', new Date().toISOString());
            showToast('✅ Tour completed! You\'re ready to harvest terms.');
          }

          // --- Welcome Screen Functions ---
          function scrollToUpload() {
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
              sidebar.scrollIntoView({ behavior: 'smooth', block: 'start' });
              // Flash the first upload zone
              setTimeout(() => {
                const firstDropZone = document.getElementById('dropZoneBulkRef');
                if (firstDropZone) {
                  firstDropZone.style.animation = 'pulse 1s ease-in-out 2';
                }
              }, 500);
            }
          }

          function loadSampleData() {
            alert('Sample data feature coming soon! This will pre-load example reports so you can explore the tool without uploading files.');
            // TODO: Implement sample data loading
          }

          function showTutorial() {
            alert('Tutorial video coming soon! For now, follow the 3 steps:\n\n1. Upload your reports\n2. Configure rules\n3. Download bulk file');
            // TODO: Implement tutorial modal/video
          }

          // Hide welcome screen once data is processed
          function hideWelcomeScreen() {
            const welcomeScreen = document.getElementById('welcomeScreen');
            if (welcomeScreen) {
              welcomeScreen.style.animation = 'fadeOut 0.3s ease-out';
              setTimeout(() => {
                welcomeScreen.style.display = 'none';
              }, 300);
            }
          }

          // Add fadeOut animation
          const style = document.createElement('style');
          style.textContent = `
      @keyframes fadeOut {
        from { opacity: 1; transform: translateY(0); }
        to { opacity: 0; transform: translateY(-20px); }
      }
    `;
          document.head.appendChild(style);

          // --- Auto-fill Start Date with today's date (prevents past date uploads) ---
          try {
            if (bulkStartDate) {
              const today = formatTodayYYYYMMDD();
              const current = (bulkStartDate.value || "").trim();
              if (!isValidYYYYMMDD(current) || isPastDateYYYYMMDD(current)) bulkStartDate.value = today;
            }
          } catch (e) { }

          // --- Initialize bidding strategy UI state ---
          try {
            toggleModifierInput();
          } catch (e) { }

          // ============= BULK PREVIEW FUNCTIONS =============
          let previewDataSP = [];
          let previewDataSBV = [];

          function showBulkPreview() {
            // Generate the preview data (same logic as downloadBulkWorkbook but returns data)
            const result = generateBulkPreviewData();
            if (!result) {
              showToast("No data to preview. Run analysis first.");
              return;
            }

            previewDataSP = result.spData || [];
            previewDataSBV = result.sbvData || [];

            // Update summary stats
            document.getElementById('previewSpRows').textContent = previewDataSP.length > 0 ? previewDataSP.length - 1 : 0; // Minus header
            document.getElementById('previewSbvRows').textContent = previewDataSBV.length > 0 ? previewDataSBV.length - 1 : 0;

            // Count campaigns and keywords
            let campaigns = 0, keywords = 0;
            previewDataSP.forEach((row, i) => {
              if (i === 0) return; // Skip header
              if (row[1] === 'Campaign') campaigns++;
              if (row[1] === 'Keyword') keywords++;
              if (row[1] === 'Product targeting') keywords++;
            });
            previewDataSBV.forEach((row, i) => {
              if (i === 0) return;
              if (row[1] === 'Campaign') campaigns++;
              if (row[1] === 'Keyword') keywords++;
            });

            document.getElementById('previewTotalCampaigns').textContent = campaigns;
            document.getElementById('previewTotalKeywords').textContent = keywords;

            // Render tables
            renderPreviewTable('sp', previewDataSP);
            renderPreviewTable('sbv', previewDataSBV);

            // Show SP tab by default
            switchPreviewTab('sp');

            // Show modal
            document.getElementById('bulkPreviewModal').style.display = 'flex';
          }

          function closeBulkPreview() {
            document.getElementById('bulkPreviewModal').style.display = 'none';
          }

          function switchPreviewTab(tab) {
            const tabSP = document.getElementById('previewTabSP');
            const tabSBV = document.getElementById('previewTabSBV');
            const tableSP = document.getElementById('previewTableSP');
            const tableSBV = document.getElementById('previewTableSBV');

            if (tab === 'sp') {
              tabSP.classList.add('active');
              tabSBV.classList.remove('active');
              tabSP.style.background = 'var(--primary)';
              tabSP.style.color = 'white';
              tabSBV.style.background = 'var(--slate-100)';
              tabSBV.style.color = 'var(--text-muted)';
              tableSP.style.display = 'block';
              tableSBV.style.display = 'none';
            } else {
              tabSBV.classList.add('active');
              tabSP.classList.remove('active');
              tabSBV.style.background = 'var(--primary)';
              tabSBV.style.color = 'white';
              tabSP.style.background = 'var(--slate-100)';
              tabSP.style.color = 'var(--text-muted)';
              tableSBV.style.display = 'block';
              tableSP.style.display = 'none';
            }
          }

          function renderPreviewTable(type, data) {
            const container = document.getElementById(type === 'sp' ? 'previewTableSP' : 'previewTableSBV');

            if (!data || data.length === 0) {
              container.innerHTML = '<div style="padding:40px; text-align:center; color:var(--text-muted);">No data for this type. Make sure to include ' + (type === 'sp' ? 'SP' : 'SBV') + ' in export settings.</div>';
              return;
            }

            const header = data[0];
            const rows = data.slice(1);

            let html = '<table class="preview-table"><thead><tr>';
            header.forEach((col, idx) => {
              html += `<th title="${escapeHtml(col)}">${escapeHtml(col)}</th>`;
            });
            html += '</tr></thead><tbody>';

            rows.forEach(row => {
              const entity = row[1] || '';
              let rowClass = '';
              if (entity === 'Campaign') rowClass = 'campaign-row';
              else if (entity === 'Ad group') rowClass = 'adgroup-row';
              else if (entity === 'Keyword') rowClass = 'keyword-row';
              else if (entity === 'Product targeting' || entity === 'Product ad') rowClass = 'pt-row';

              html += '<tr>';
              row.forEach((cell, idx) => {
                const val = (cell !== undefined && cell !== null) ? cell.toString() : '';
                const truncated = val.length > 30 ? val.substring(0, 30) + '...' : val;
                html += `<td class="${rowClass}" title="${escapeHtml(val)}">${escapeHtml(truncated)}</td>`;
              });
              html += '</tr>';
            });

            html += '</tbody></table>';
            container.innerHTML = html;
          }

          function confirmAndDownloadBulk() {
            closeBulkPreview();
            // Now trigger the actual download
            try {
              downloadBulkWorkbook();
            } catch (e) {
              console.error(e);
              if (bulkStatus) bulkStatus.textContent = "Export failed. Check console.";
            }
          }

          function generateBulkPreviewData() {
            // Validation
            const includeSP = toggleExportSP?.checked ?? true;
            const includeSBV = toggleExportSBV?.checked ?? true;

            if (!includeSP && !includeSBV) {
              return null;
            }

            if ((!lastGroupedSP || !Object.keys(lastGroupedSP).length) && (!lastGroupedSB || !Object.keys(lastGroupedSB).length)) {
              return null;
            }

            // Get settings
            const startDate = (bulkStartDate?.value || formatTodayYYYYMMDD()).replace(/-/g, '');
            const spState = bulkState?.value || "Enabled";
            const spBiddingStrategy = document.getElementById('spBiddingStrategy')?.value || "Fixed bids";
            const strategy = document.getElementById('spBidStrategy')?.value || "sourceCpc";
            const modifierPct = parseFloat(document.getElementById('spBidModifier')?.value || "0");
            const modifierMult = 1 + (modifierPct / 100);

            // SBV settings
            const brandEntityId = (bulkBrandEntityId?.value || "").trim();
            const sbPortfolioId = (bulkPortfolioId?.value || "").trim();
            const bidOptimization = (bulkBidOpt?.value || "true") === "true";
            const spPortfolioId = (document.getElementById('opt1_spPortfolioId')?.value || "").trim();

            // Per-bucket limits
            const limBroad = numVal(document.getElementById("kwPerCampBroad"), 10);
            const limPhrase = numVal(document.getElementById("kwPerCampPhrase"), 10);
            const limExact = numVal(document.getElementById("kwPerCampExact"), 10);
            const limPT = numVal(document.getElementById("ptPerCamp"), 10);

            const sbvLimBroad = numVal(document.getElementById("sbvPerCampBroad"), 10);
            const sbvLimPhrase = numVal(document.getElementById("sbvPerCampPhrase"), 10);
            const sbvLimExact = numVal(document.getElementById("sbvPerCampExact"), 10);

            let spSheet = [];
            let sbvSheet = [];

            // ============= SP Preview =============
            if (includeSP) {
              const header = [
                "Product", "Entity", "Operation",
                "Campaign Id", "Ad Group Id", "Portfolio Id", "Ad Id", "Keyword Id", "Product Targeting Id",
                "Campaign Name", "Ad Group Name",
                "Start Date", "End Date", "Targeting Type", "State",
                "Daily Budget", "SKU", "ASIN",
                "Ad Group Default Bid", "Bid", "Keyword Text", "Match Type",
                "Bidding Strategy", "Placement", "Percentage",
                "Product Targeting Expression", "Audience ID", "Shopper Cohort Percentage", "Shopper Cohort Type"
              ];

              spSheet.push(header);
              const skuMapOpt1 = getOpt1SkuMap();
              const products = Object.keys(lastGroupedSP || {}).sort();

              for (const product of products) {
                const campTpl = (bulkMode === "opt1")
                  ? strVal(opt1_spCampTpl, "{Product} | SP | {Match} | Harvested")
                  : ((productProfiles[product]?.campTpl) || "{Product} | SP | {Match} | Harvested");

                const kwBroad = (lastGroupedSP?.[product]?.["Broad"]?.final || []).map(r => (r["Suggested Value"] || r["Customer Search Term"] || "").toString().trim()).filter(Boolean);
                const kwPhrase = (lastGroupedSP?.[product]?.["Phrase"]?.final || []).map(r => (r["Suggested Value"] || r["Customer Search Term"] || "").toString().trim()).filter(Boolean);
                const kwExact = (lastGroupedSP?.[product]?.["Exact"]?.final || []).map(r => (r["Suggested Value"] || r["Customer Search Term"] || "").toString().trim()).filter(Boolean);
                const asins = (lastGroupedSP?.[product]?.["ASIN"]?.final || []).map(r => (r["Suggested Value"] || r["Customer Search Term"] || "").toString().trim()).filter(Boolean);

                const baseVars = { Product: product, Base: product };
                let spBudget, spDefaultBid, spAsinBid, sku;

                if (bulkMode === "opt1") {
                  spBudget = numVal(opt1_spBudget, 100);
                  spDefaultBid = numVal(opt1_spDefaultBid, 0.75);
                  spAsinBid = numVal(document.getElementById('opt1_spBidAsin'), 0.75);
                  sku = (skuMapOpt1[product] || "").trim();
                } else {
                  const prof = productProfiles[product] || {};
                  spBudget = prof.spBudget || 100;
                  spDefaultBid = 0.75;
                  spAsinBid = 0.75;
                  sku = (prof.spSku || "").trim();
                }

                // Keywords (Broad, Phrase, Exact)
                [[("Broad"), kwBroad, limBroad], [("Phrase"), kwPhrase, limPhrase], [("Exact"), kwExact, limExact]].forEach(([bucket, list, lim]) => {
                  if (!list.length) return;
                  const vars = { ...baseVars, Match: bucket };
                  let rawBaseName = applyTemplate(campTpl, vars);
                  const chunks = chunkArray(list, lim);

                  chunks.forEach((chunk, idx) => {
                    const suffix = (chunks.length > 1) ? ` | ${idx + 1}` : "";
                    const campaignName = rawBaseName + suffix;
                    const adGroupName = campaignName;

                    let fallbackBid = spDefaultBid;
                    if (bulkMode === "opt1") {
                      fallbackBid = spBidForBucket(bucket);
                    }

                    // Campaign row
                    spSheet.push([
                      "Sponsored Products", "Campaign", "Create",
                      campaignName, "", spPortfolioId, "", "", "",
                      campaignName, "",
                      startDate, "", "Manual", spState,
                      spBudget, "", "",
                      "", "", "", "",
                      spBiddingStrategy, "", "",
                      "", "", "", ""
                    ]);

                    // Ad Group row
                    spSheet.push([
                      "Sponsored Products", "Ad group", "Create",
                      campaignName, adGroupName, "", "", "", "",
                      campaignName, adGroupName,
                      "", "", "", spState,
                      "", "", "",
                      fallbackBid, "", "", "",
                      "", "", "", "",
                      "", "", "", ""
                    ]);

                    // Product Ad row
                    if (sku) {
                      spSheet.push([
                        "Sponsored Products", "Product ad", "Create",
                        campaignName, adGroupName, "", "", "", "",
                        campaignName, adGroupName,
                        "", "", "", spState,
                        "", "" + sku, "",
                        "", "", "", "",
                        "", "", "", "",
                        "", "", "", ""
                      ]);
                    }

                    // Keyword rows
                    chunk.forEach(term => {
                      spSheet.push([
                        "Sponsored Products", "Keyword", "Create",
                        campaignName, adGroupName, "", "", "", "",
                        campaignName, adGroupName,
                        "", "", "", spState,
                        "", "", "",
                        "", fallbackBid, term, bucket,
                        "", "", "",
                        "", "", "", ""
                      ]);
                    });
                  });
                });

                // PT (ASINs)
                if (asins.length) {
                  const vars = { ...baseVars, Match: "PT" };
                  let rawBaseName = applyTemplate(campTpl, vars);
                  const chunks = chunkArray(asins, limPT);

                  chunks.forEach((chunk, idx) => {
                    const suffix = (chunks.length > 1) ? ` | ${idx + 1}` : "";
                    const campaignName = rawBaseName + suffix;
                    const adGroupName = campaignName;

                    // Campaign row
                    spSheet.push([
                      "Sponsored Products", "Campaign", "Create",
                      campaignName, "", spPortfolioId, "", "", "",
                      campaignName, "",
                      startDate, "", "Manual", spState,
                      spBudget, "", "",
                      "", "", "", "",
                      spBiddingStrategy, "", "",
                      "", "", "", ""
                    ]);

                    // Ad Group row
                    spSheet.push([
                      "Sponsored Products", "Ad group", "Create",
                      campaignName, adGroupName, "", "", "", "",
                      campaignName, adGroupName,
                      "", "", "", spState,
                      "", "", "",
                      spAsinBid, "", "", "",
                      "", "", "", "",
                      "", "", "", ""
                    ]);

                    // Product Ad row
                    if (sku) {
                      spSheet.push([
                        "Sponsored Products", "Product ad", "Create",
                        campaignName, adGroupName, "", "", "", "",
                        campaignName, adGroupName,
                        "", "", "", spState,
                        "", "" + sku, "",
                        "", "", "", "",
                        "", "", "", "",
                        "", "", "", ""
                      ]);
                    }

                    // PT rows
                    chunk.forEach(asin => {
                      spSheet.push([
                        "Sponsored Products", "Product targeting", "Create",
                        campaignName, adGroupName, "", "", "", "",
                        campaignName, adGroupName,
                        "", "", "", spState,
                        "", "", "",
                        "", spAsinBid, "", "",
                        "", "", "",
                        `asin="${asin}"`, "", "", ""
                      ]);
                    });
                  });
                }
              }
            }

            // ============= SBV Preview =============
            if (includeSBV) {
              const sbvHeader = [
                'Product', 'Entity', 'Operation', 'Campaign ID', 'Portfolio ID', 'Ad Group ID', 'Ad ID',
                'Keyword ID', 'Product Targeting ID', 'Campaign Name', 'Ad Group Name', 'Ad Name',
                'Start Date', 'End Date', 'State', 'Brand Entity ID', 'Budget Type', 'Budget',
                'Bid Optimization', 'Product Location', 'Bid', 'Placement', 'Percentage', 'Keyword Text',
                'Match Type', 'Native Language Keyword', 'Native Language Locale', 'Product Targeting Expression',
                'Landing Page URL', 'Landing Page ASINs', 'Landing Page Type', 'Brand Name',
                'Consent To Translate', 'Brand Logo Asset ID', 'Brand Logo Crop', 'Custom Images',
                'Creative Headline', 'Creative ASINs', 'Video Asset IDs', 'Sub-pages'
              ];

              sbvSheet.push(sbvHeader);

              const groups = lastGroupedSB || {};
              const sbvModifierPct = parseFloat(document.getElementById('sbvBidModifier')?.value || "0");
              const sbvModifierMult = 1 + (sbvModifierPct / 100);

              Object.keys(groups).sort().forEach(product => {
                const obj = groups[product] || {};

                ["Broad", "Phrase", "Exact"].forEach(bucket => {
                  const finals = obj[bucket]?.final || [];
                  if (!finals.length) return;

                  let limit = 10;
                  if (bucket === "Broad") limit = sbvLimBroad;
                  if (bucket === "Phrase") limit = sbvLimPhrase;
                  if (bucket === "Exact") limit = sbvLimExact;

                  const video = (bulkMode === "opt1")
                    ? strVal(opt1_sbvVideo, "amzn1.assetlibrary...")
                    : (productProfiles[product]?.sbvVideo || "amzn1.assetlibrary...");

                  const creativeAsin = (bulkMode === "opt1")
                    ? (document.getElementById('opt1_sbvAsin')?.value || "").trim()
                    : (productProfiles[product]?.sbvAsin || "");

                  const sbvBudget = (bulkMode === "opt1")
                    ? numVal(opt1_sbvBudget, 50)
                    : (productProfiles[product]?.sbvBudget || 50);

                  const campTpl = (bulkMode === "opt1")
                    ? strVal(opt1_sbvCampTpl, "{Product} | SBV | {Video} | {Match}")
                    : ((productProfiles[product]?.sbvCampTpl) || "{Product} | SBV | {Video} | {Match}");

                  const agTpl = (bulkMode === "opt1")
                    ? strVal(opt1_sbvAgTpl, "{Match}")
                    : ((productProfiles[product]?.sbvAgTpl) || "{Match}");

                  const keywordsList = finals.map(r => (r["Suggested Value"] || r["Customer Search Term"] || "").toString().trim()).filter(Boolean);
                  const chunks = chunkArray(keywordsList, limit);

                  chunks.forEach((chunk, chunkIdx) => {
                    const vars = { Product: product, Match: bucket, Video: "SBV" };
                    const suffix = (chunks.length > 1) ? ` | ${chunkIdx + 1}` : "";
                    const campaignName = applyTemplate(campTpl, vars) + suffix;
                    const adGroupName = applyTemplate(agTpl, vars);

                    let fallbackBid = 0.80;
                    if (bulkMode === "opt1") {
                      fallbackBid = sbvBidForBucket(bucket);
                    }

                    // Campaign row
                    const campaignRow = new Array(sbvHeader.length).fill("");
                    campaignRow[0] = "Sponsored Brands";
                    campaignRow[1] = "Campaign";
                    campaignRow[2] = "Create";
                    campaignRow[4] = sbPortfolioId;
                    campaignRow[9] = campaignName;
                    campaignRow[12] = startDate;
                    campaignRow[14] = spState;
                    campaignRow[15] = brandEntityId;
                    campaignRow[16] = "Daily";
                    campaignRow[17] = sbvBudget;
                    campaignRow[18] = bidOptimization;
                    sbvSheet.push(campaignRow);

                    // Ad Group row
                    const agRow = new Array(sbvHeader.length).fill("");
                    agRow[0] = "Sponsored Brands";
                    agRow[1] = "Ad Group";
                    agRow[2] = "Create";
                    agRow[9] = campaignName;
                    agRow[10] = adGroupName;
                    agRow[14] = spState;
                    sbvSheet.push(agRow);

                    // Video Ad row
                    const adRow = new Array(sbvHeader.length).fill("");
                    adRow[0] = "Sponsored Brands";
                    adRow[1] = "Ad";
                    adRow[2] = "Create";
                    adRow[9] = campaignName;
                    adRow[10] = adGroupName;
                    adRow[11] = adGroupName;
                    adRow[14] = spState;
                    adRow[29] = creativeAsin;
                    adRow[30] = "Product Detail Pages";
                    adRow[37] = creativeAsin;
                    adRow[38] = video;
                    sbvSheet.push(adRow);

                    // Keyword rows
                    chunk.forEach(kw => {
                      const kwRow = new Array(sbvHeader.length).fill("");
                      kwRow[0] = "Sponsored Brands";
                      kwRow[1] = "Keyword";
                      kwRow[2] = "Create";
                      kwRow[9] = campaignName;
                      kwRow[10] = adGroupName;
                      kwRow[14] = spState;
                      kwRow[20] = fallbackBid;
                      kwRow[23] = kw;
                      kwRow[24] = bucket.toLowerCase();
                      sbvSheet.push(kwRow);
                    });
                  });
                });
              });
            }

            return { spData: spSheet, sbvData: sbvSheet };
          }

          // Close preview with Escape key
          document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && document.getElementById('bulkPreviewModal').style.display === 'flex') {
              closeBulkPreview();
            }
          });

          // Close preview when clicking outside
          document.getElementById('bulkPreviewModal')?.addEventListener('click', (e) => {
            if (e.target.id === 'bulkPreviewModal') closeBulkPreview();
          });

          // ============= USER GUIDE FUNCTIONS =============
          function openUserGuide() {
            document.getElementById('userGuideModal').style.display = 'flex';
            document.getElementById('guideSearchInput').value = '';
            filterGuide(''); // Reset filter
            // Scroll to top
            document.getElementById('guideContent').scrollTop = 0;
          }

          function closeUserGuide() {
            document.getElementById('userGuideModal').style.display = 'none';
          }

          function scrollToGuideSection(sectionId) {
            const section = document.getElementById('guide-' + sectionId);
            if (section) {
              section.scrollIntoView({ behavior: 'smooth', block: 'start' });
              // Update active nav
              document.querySelectorAll('.guide-nav-item').forEach(item => {
                item.classList.remove('active');
              });
              event.target.classList.add('active');
            }
          }

          function filterGuide(query) {
            const searchTerm = query.toLowerCase().trim();
            const sections = document.querySelectorAll('.guide-section');
            const items = document.querySelectorAll('.guide-item');

            if (!searchTerm) {
              // Show all
              sections.forEach(s => s.classList.remove('guide-hidden'));
              items.forEach(i => i.classList.remove('guide-hidden'));
              return;
            }

            // Filter items
            items.forEach(item => {
              const title = item.querySelector('.guide-item-title')?.textContent?.toLowerCase() || '';
              const desc = item.querySelector('.guide-item-desc')?.textContent?.toLowerCase() || '';
              const keywords = item.getAttribute('data-keywords')?.toLowerCase() || '';

              const matches = title.includes(searchTerm) || desc.includes(searchTerm) || keywords.includes(searchTerm);
              item.classList.toggle('guide-hidden', !matches);
            });

            // Filter sections (hide if all items hidden)
            sections.forEach(section => {
              const sectionKeywords = section.getAttribute('data-keywords')?.toLowerCase() || '';
              const sectionTitle = section.querySelector('.guide-section-title')?.textContent?.toLowerCase() || '';
              const visibleItems = section.querySelectorAll('.guide-item:not(.guide-hidden)');

              const sectionMatches = sectionKeywords.includes(searchTerm) || sectionTitle.includes(searchTerm);
              section.classList.toggle('guide-hidden', visibleItems.length === 0 && !sectionMatches);
            });
          }

          // Close guide with Escape key
          document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && document.getElementById('userGuideModal').style.display === 'flex') {
              closeUserGuide();
            }
          });

          // Close guide when clicking outside
          document.getElementById('userGuideModal')?.addEventListener('click', (e) => {
            if (e.target.id === 'userGuideModal') closeUserGuide();
          });

          // ============= SAMPLE DATA FEATURE =============
          function loadSampleData() {
            showToast('🔄 Loading sample data...');

            // Sample Products
            const sampleProducts = [
              { name: 'Premium Blue Hat', sku: 'HAT-BLU-001' },
              { name: 'Organic Coffee Beans', sku: 'COF-ORG-250' },
              { name: 'Wireless Earbuds Pro', sku: 'EAR-WIR-PRO' },
              { name: 'Yoga Mat Deluxe', sku: 'YOG-MAT-DLX' }
            ];

            // Sample keywords per product category
            const keywordsByProduct = {
              'Premium Blue Hat': {
                broad: ['winter hat', 'warm beanie', 'knit cap', 'cold weather hat', 'winter accessories'],
                phrase: ['winter hat for men', 'blue knit beanie', 'warm winter cap', 'mens winter hat', 'cozy beanie'],
                exact: ['blue winter hat', 'premium knit beanie', 'mens blue beanie', 'wool winter hat', 'navy knit cap'],
                asins: ['B07ABCD123', 'B08EFGH456', 'B09IJKL789']
              },
              'Organic Coffee Beans': {
                broad: ['coffee beans', 'organic coffee', 'whole bean coffee', 'arabica beans', 'espresso beans'],
                phrase: ['organic coffee beans', 'best coffee beans', 'whole bean organic coffee', 'dark roast beans', 'fresh roasted coffee'],
                exact: ['organic arabica coffee beans', 'best organic coffee', 'premium whole bean coffee', 'fair trade coffee beans', 'single origin organic coffee'],
                asins: ['B07COF0001', 'B08COF0002', 'B09COF0003']
              },
              'Wireless Earbuds Pro': {
                broad: ['wireless earbuds', 'bluetooth headphones', 'earphones wireless', 'sport earbuds', 'noise cancelling'],
                phrase: ['wireless earbuds with mic', 'bluetooth earbuds for running', 'noise cancelling earbuds', 'waterproof wireless earbuds', 'best wireless earphones'],
                exact: ['wireless earbuds pro', 'premium bluetooth earbuds', 'true wireless earbuds noise cancelling', 'wireless sport earbuds waterproof', 'best earbuds 2024'],
                asins: ['B07EAR0001', 'B08EAR0002', 'B09EAR0003', 'B10EAR0004']
              },
              'Yoga Mat Deluxe': {
                broad: ['yoga mat', 'exercise mat', 'fitness mat', 'workout mat', 'pilates mat'],
                phrase: ['yoga mat thick', 'non slip yoga mat', 'exercise mat for home', 'yoga mat with strap', 'extra thick yoga mat'],
                exact: ['deluxe yoga mat non slip', 'premium thick yoga mat', 'eco friendly yoga mat', 'yoga mat 6mm thick', 'professional yoga mat'],
                asins: ['B07YOG0001', 'B08YOG0002']
              }
            };

            // Generate random KPI values
            function randomBetween(min, max) {
              return Math.floor(Math.random() * (max - min + 1)) + min;
            }

            function randomDecimal(min, max, decimals = 2) {
              return (Math.random() * (max - min) + min).toFixed(decimals);
            }

            // Generate realistic KPIs - some good, some bad
            function generateKPIs(isWinner) {
              if (isWinner) {
                return {
                  orders: randomBetween(1, 25),
                  acos: randomDecimal(8, 35),
                  clicks: randomBetween(20, 300),
                  spend: randomDecimal(10, 150),
                  impressions: randomBetween(1000, 50000),
                  cpc: randomDecimal(0.25, 1.50),
                  ctr: randomDecimal(0.3, 2.5),
                  convRate: randomDecimal(3, 20)
                };
              } else {
                return {
                  orders: randomBetween(0, 1),
                  acos: randomDecimal(40, 150),
                  clicks: randomBetween(5, 50),
                  spend: randomDecimal(5, 80),
                  impressions: randomBetween(500, 10000),
                  cpc: randomDecimal(0.50, 2.50),
                  ctr: randomDecimal(0.1, 0.5),
                  convRate: randomDecimal(0, 5)
                };
              }
            }

            // Build sample SP rows
            const sampleSPRows = [];
            const sampleSPHeaders = [
              'Campaign Name', 'Ad Group Name', 'Targeting', 'Match Type',
              'Customer Search Term', '7 Day Total Orders (#)',
              'Total Advertising Cost of Sales (ACOS) ', 'Clicks', 'Spend',
              'Impressions', 'Cost Per Click (CPC)', 'Click-Thru Rate (CTR)',
              'Conversion Rate'
            ];

            sampleProducts.forEach(product => {
              const keywords = keywordsByProduct[product.name];
              const campaignBase = `${product.name} | SP`;

              // Broad keywords
              keywords.broad.forEach((kw, idx) => {
                const isWinner = idx < 3; // First 3 are winners
                const kpis = generateKPIs(isWinner);
                sampleSPRows.push({
                  'Campaign Name': `${campaignBase} | Auto`,
                  'Ad Group Name': `${product.name} - Auto`,
                  'Targeting': kw,
                  'Match Type': 'Broad',
                  'Customer Search Term': kw,
                  '7 Day Total Orders (#)': kpis.orders,
                  'Total Advertising Cost of Sales (ACOS) ': kpis.acos + '%',
                  'Clicks': kpis.clicks,
                  'Spend': '$' + kpis.spend,
                  'Impressions': kpis.impressions,
                  'Cost Per Click (CPC)': '$' + kpis.cpc,
                  'Click-Thru Rate (CTR)': kpis.ctr + '%',
                  'Conversion Rate': kpis.convRate + '%'
                });
              });

              // Phrase keywords
              keywords.phrase.forEach((kw, idx) => {
                const isWinner = idx < 3;
                const kpis = generateKPIs(isWinner);
                sampleSPRows.push({
                  'Campaign Name': `${campaignBase} | Phrase`,
                  'Ad Group Name': `${product.name} - Phrase`,
                  'Targeting': kw,
                  'Match Type': 'Phrase',
                  'Customer Search Term': kw,
                  '7 Day Total Orders (#)': kpis.orders,
                  'Total Advertising Cost of Sales (ACOS) ': kpis.acos + '%',
                  'Clicks': kpis.clicks,
                  'Spend': '$' + kpis.spend,
                  'Impressions': kpis.impressions,
                  'Cost Per Click (CPC)': '$' + kpis.cpc,
                  'Click-Thru Rate (CTR)': kpis.ctr + '%',
                  'Conversion Rate': kpis.convRate + '%'
                });
              });

              // ASIN targets
              keywords.asins.forEach((asin, idx) => {
                const isWinner = idx < 2;
                const kpis = generateKPIs(isWinner);
                sampleSPRows.push({
                  'Campaign Name': `${campaignBase} | PT`,
                  'Ad Group Name': `${product.name} - Product Targeting`,
                  'Targeting': `asin="${asin}"`,
                  'Match Type': 'Targeting Expression',
                  'Customer Search Term': asin,
                  '7 Day Total Orders (#)': kpis.orders,
                  'Total Advertising Cost of Sales (ACOS) ': kpis.acos + '%',
                  'Clicks': kpis.clicks,
                  'Spend': '$' + kpis.spend,
                  'Impressions': kpis.impressions,
                  'Cost Per Click (CPC)': '$' + kpis.cpc,
                  'Click-Thru Rate (CTR)': kpis.ctr + '%',
                  'Conversion Rate': kpis.convRate + '%'
                });
              });
            });

            // Build sample SB rows (fewer)
            const sampleSBRows = [];
            sampleProducts.slice(0, 2).forEach(product => {
              const keywords = keywordsByProduct[product.name];
              const campaignBase = `${product.name} | SB`;

              keywords.exact.slice(0, 3).forEach((kw, idx) => {
                const isWinner = idx < 2;
                const kpis = generateKPIs(isWinner);
                sampleSBRows.push({
                  'Campaign Name': `${campaignBase} | Video`,
                  'Ad Group Name': `${product.name} - SBV`,
                  'Targeting': kw,
                  'Match Type': 'Exact',
                  'Customer Search Term': kw,
                  '7 Day Total Orders (#)': kpis.orders,
                  'Total Advertising Cost of Sales (ACOS) ': kpis.acos + '%',
                  'Clicks': kpis.clicks,
                  'Spend': '$' + kpis.spend,
                  'Impressions': kpis.impressions,
                  'Cost Per Click (CPC)': '$' + kpis.cpc,
                  'Click-Thru Rate (CTR)': kpis.ctr + '%',
                  'Conversion Rate': kpis.convRate + '%'
                });
              });
            });

            // Build sample Bulk Ops data (existing campaigns)
            const sampleBulkOps = [];
            sampleProducts.forEach(product => {
              // Add a few existing campaigns to test deduplication
              sampleBulkOps.push({
                'Campaign Name': `${product.name} | SP | Auto | OLD`,
                'Campaign State': 'Enabled',
                'Daily Budget': '50'
              });
            });

            // Set the global data
            spRowsRaw = sampleSPRows;
            spRowsFmt = sampleSPRows;
            spHeaders = sampleSPHeaders;
            spCampaignColName = 'Campaign Name';

            sbRowsRaw = sampleSBRows;
            sbRowsFmt = sampleSBRows;
            sbHeaders = sampleSPHeaders;
            sbCampaignColName = 'Campaign Name';

            refRows = sampleBulkOps;

            // Update UI to show files loaded
            const spInfo = document.getElementById('spFileInfo');
            const sbInfo = document.getElementById('sbFileInfo');
            const refInfo = document.getElementById('refFileInfo');

            if (spInfo) {
              spInfo.innerHTML = '<span style="color:var(--success);">✓ Sample SP Data (' + sampleSPRows.length + ' rows)</span>';
            }
            if (sbInfo) {
              sbInfo.innerHTML = '<span style="color:var(--success);">✓ Sample SB Data (' + sampleSBRows.length + ' rows)</span>';
            }
            if (refInfo) {
              refInfo.innerHTML = '<span style="color:var(--success);">✓ Sample Bulk Ops (' + sampleBulkOps.length + ' campaigns)</span>';
            }

            // Detect products
            detectedProducts = sampleProducts.map(p => p.name);

            // Update sidebar
            renderQuickJump();

            // Render product rules
            renderProductRules(detectedProducts);

            // Apply smart defaults automatically
            detectedProducts.forEach(product => {
              if (!productRulesState[product]) productRulesState[product] = {};
              productRulesState[product].orders = 1;
              productRulesState[product].acos = 30;
            });
            renderProductRules(detectedProducts);

            // Enable KPIs
            document.querySelectorAll('.kpi-check').forEach(c => {
              if (c.value === 'orders' || c.value === 'acos') {
                c.checked = true;
              }
            });

            // Enable Run Analysis button
            if (btnRunAnalysis) btnRunAnalysis.disabled = false;

            // Hide welcome, show results
            const welcomeEl = document.getElementById('welcomeScreen');
            if (welcomeEl) welcomeEl.style.display = 'none';

            // Update file upload states
            filesUploaded = { sp: true, sb: true, ref: true };
            checkStepProgress();

            // Auto-run analysis after a short delay
            setTimeout(() => {
              showToast('⚡ Running analysis on sample data...');

              // Run the analysis
              if (typeof btnRunAnalysis !== 'undefined' && btnRunAnalysis) {
                btnRunAnalysis.click();
              }

              // Show bulk export section
              setTimeout(() => {
                const bulkCta = document.getElementById('bulkCtaWrap');
                const bulkPanel = document.getElementById('bulkStepPanel');
                if (bulkCta) bulkCta.classList.remove('hidden');
                if (bulkPanel) bulkPanel.classList.remove('hidden');

                // Populate SKU map
                buildOpt1SkuMapUI();

                showToast('✅ Sample data loaded! Explore all features.');
              }, 500);
            }, 300);
          }

        </script>
        <script>
          (function () {
            'use strict';

            // BALANCED PROTECTION - Protects code but keeps app functional!

            // 1. Block Ctrl+U (view source) - but allow other Ctrl commands
            document.addEventListener('keydown', function (e) {
              // Block Ctrl+U (view source)
              if (e.ctrlKey && e.keyCode === 85 && !e.shiftKey) {
                e.preventDefault();
                console.log('View source disabled for protection');
                return false;
              }

              // Block F12 (but only show warning, don't break functionality)
              if (e.keyCode === 123) {
                e.preventDefault();
                console.log('Developer tools access restricted');
                return false;
              }

              // Block Ctrl+Shift+I and Ctrl+Shift+J (dev tools shortcuts)
              if (e.ctrlKey && e.shiftKey && (e.keyCode === 73 || e.keyCode === 74)) {
                e.preventDefault();
                console.log('Developer tools access restricted');
                return false;
              }
            }, false);

            // 2. Selective right-click blocking (allow in input fields and file uploads)
            document.addEventListener('contextmenu', function (e) {
              var target = e.target;

              // ALLOW right-click on input elements, textareas, file inputs
              if (target.tagName === 'INPUT' ||
                target.tagName === 'TEXTAREA' ||
                target.tagName === 'SELECT' ||
                target.type === 'file') {
                return true; // Allow right-click
              }

              // ALLOW right-click if inside a form element
              if (target.closest('input, textarea, select, [contenteditable="true"]')) {
                return true; // Allow right-click
              }

              // Block right-click everywhere else
              e.preventDefault();
              return false;
            }, false);

            // 3. Selective text selection (ALLOW in input fields, BLOCK elsewhere)
            document.addEventListener('selectstart', function (e) {
              var target = e.target;

              // ALLOW selection in input elements, textareas
              if (target.tagName === 'INPUT' ||
                target.tagName === 'TEXTAREA' ||
                target.tagName === 'SELECT' ||
                target.isContentEditable ||
                target.closest('input, textarea, [contenteditable="true"]')) {
                return true; // Allow selection
              }

              // Block selection elsewhere
              e.preventDefault();
              return false;
            }, false);

            // 4. Selective copy blocking (ALLOW in input fields)
            document.addEventListener('copy', function (e) {
              var target = document.activeElement;

              // ALLOW copy from input elements, textareas
              if (target.tagName === 'INPUT' ||
                target.tagName === 'TEXTAREA' ||
                target.isContentEditable) {
                return true; // Allow copy
              }

              // Block copy elsewhere
              e.preventDefault();
              return false;
            }, false);

            // 5. DO NOT BLOCK DRAG AND DROP (needed for file uploads!)
            // No dragstart blocking - your file uploads need this!

            // 6. Light DevTools detection (warns but doesn't break the app)
            var devtoolsWarningShown = false;
            setInterval(function () {
              var widthThreshold = window.outerWidth - window.innerWidth > 160;
              var heightThreshold = window.outerHeight - window.innerHeight > 160;

              if ((widthThreshold || heightThreshold) && !devtoolsWarningShown) {
                console.warn('âš ï¸ This code is protected. Unauthorized copying is prohibited.');
                devtoolsWarningShown = true;
                // Note: We DON'T block the page, just warn
              }
            }, 2000);

            // 7. Add copyright notice to console
            console.log('%câš ï¸ COPYRIGHT NOTICE', 'font-size: 20px; font-weight: bold; color: #f44336;');
            console.log('%cThis code is protected and proprietary.', 'font-size: 14px; color: #666;');
            console.log('%cUnauthorized copying, modification, or distribution is prohibited.', 'font-size: 14px; color: #666;');
            console.log('%cÂ© 2026 All Rights Reserved', 'font-size: 14px; color: #666;');

          })();
        </script>

        <!-- Sticky Export Bar -->
        <div id="stickyExportBar" class="sticky-export-bar">
          <div class="info">
            Ready to export <strong id="stickyKeywordCount">0</strong> keywords across <strong
              id="stickyCampaignCount">0</strong> campaigns
          </div>
          <button class="btn btn-primary" onclick="document.getElementById('btnExportBulk').click()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            Download Bulk File
          </button>
        </div>

        <!-- Confetti Container -->
        <div id="confettiContainer" class="confetti-container"></div>

        <script>
          /* ========================================
             UX/UI IMPROVEMENTS - JavaScript Functions
             ======================================== */

          // --- Confetti Animation ---
          function launchConfetti() {
            const container = document.getElementById('confettiContainer');
            if (!container) return;

            const colors = ['#4F46E5', '#059669', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899'];
            const confettiCount = 100;

            for (let i = 0; i < confettiCount; i++) {
              const confetti = document.createElement('div');
              confetti.className = 'confetti';
              confetti.style.left = Math.random() * 100 + '%';
              confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
              confetti.style.animationDelay = Math.random() * 2 + 's';
              confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
              confetti.style.width = (Math.random() * 8 + 6) + 'px';
              confetti.style.height = (Math.random() * 8 + 6) + 'px';
              confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '2px';
              container.appendChild(confetti);
            }

            // Clean up after animation
            setTimeout(() => {
              container.innerHTML = '';
            }, 4000);
          }

          // --- Update Results Dashboard ---
          function updateResultsDashboard() {
            const dashboard = document.getElementById('resultsDashboard');
            if (!dashboard) return;

            let products = 0, keywords = 0, asins = 0, excluded = 0;

            // Count from SP
            if (lastGroupedSP) {
              Object.keys(lastGroupedSP).forEach(p => {
                products++;
                ['Broad', 'Phrase', 'Exact'].forEach(b => {
                  keywords += (lastGroupedSP[p]?.[b]?.final || []).length;
                  excluded += (lastGroupedSP[p]?.[b]?.excluded || []).length;
                });
                asins += (lastGroupedSP[p]?.ASIN?.final || []).length;
                excluded += (lastGroupedSP[p]?.ASIN?.excluded || []).length;
              });
            }

            // Count from SB (avoid double-counting products)
            const spProducts = lastGroupedSP ? Object.keys(lastGroupedSP) : [];
            if (lastGroupedSB) {
              Object.keys(lastGroupedSB).forEach(p => {
                if (!spProducts.includes(p)) products++;
                ['Broad', 'Phrase', 'Exact'].forEach(b => {
                  keywords += (lastGroupedSB[p]?.[b]?.final || []).length;
                  excluded += (lastGroupedSB[p]?.[b]?.excluded || []).length;
                });
              });
            }

            // Update display
            document.getElementById('dashProducts').textContent = products;
            document.getElementById('dashKeywords').textContent = keywords;
            document.getElementById('dashAsins').textContent = asins;
            document.getElementById('dashExcluded').textContent = excluded;

            // Calculate time saved (rough estimate: 2 mins per keyword manually)
            const totalItems = keywords + asins;
            const minutesSaved = totalItems * 2;
            const hoursSaved = (minutesSaved / 60).toFixed(1);
            document.getElementById('dashTimeSaved').textContent =
              minutesSaved < 60 ? `~${minutesSaved} mins` : `~${hoursSaved} hours`;

            // Show dashboard
            dashboard.classList.remove('hidden');

            // Update sticky bar
            document.getElementById('stickyKeywordCount').textContent = keywords + asins;
            document.getElementById('stickyCampaignCount').textContent =
              Math.ceil((keywords + asins) / 10); // Rough campaign estimate
          }

          // --- Show/Hide Loading Skeleton ---
          function showLoadingSkeleton() {
            const skeleton = document.getElementById('loadingSkeleton');
            const results = document.getElementById('results');
            if (skeleton) skeleton.classList.remove('hidden');
            if (results) results.style.opacity = '0.3';
          }

          function hideLoadingSkeleton() {
            const skeleton = document.getElementById('loadingSkeleton');
            const results = document.getElementById('results');
            if (skeleton) skeleton.classList.add('hidden');
            if (results) results.style.opacity = '1';
          }

          // --- Sticky Export Bar Visibility ---
          function updateStickyBarVisibility() {
            const stickyBar = document.getElementById('stickyExportBar');
            const bulkPanel = document.getElementById('bulkStepPanel');
            const bulkControls = document.getElementById('bulkExportControls');

            if (!stickyBar || !bulkPanel || !bulkControls) return;

            // Only show if bulk controls are visible and user has scrolled past them
            if (!bulkPanel.classList.contains('hidden') && !bulkControls.classList.contains('hidden')) {
              const rect = bulkPanel.getBoundingClientRect();
              if (rect.bottom < 0) {
                stickyBar.classList.add('visible');
              } else {
                stickyBar.classList.remove('visible');
              }
            } else {
              stickyBar.classList.remove('visible');
            }
          }

          // Add scroll listener for sticky bar
          window.addEventListener('scroll', updateStickyBarVisibility);

          // --- Preset Profiles ---
          const presetProfilesData = {
            aggressive: {
              name: 'Aggressive Launch',
              icon: '🚀',
              desc: 'High ACoS, max keywords',
              orders: 1,
              acos: 50
            },
            profit: {
              name: 'Profit Protection',
              icon: '💰',
              desc: 'Low ACoS, proven terms',
              orders: 2,
              acos: 20
            },
            discovery: {
              name: 'Discovery Mode',
              icon: '🧪',
              desc: 'Find new opportunities',
              orders: 1,
              acos: 40,
              clicks: 5
            }
          };

          function applyPresetProfile(profileKey) {
            const profile = presetProfilesData[profileKey];
            if (!profile) return;

            // Update preset card UI
            document.querySelectorAll('.preset-card').forEach(card => {
              card.classList.remove('active');
            });
            const activeCard = document.querySelector(`[data-preset="${profileKey}"]`);
            if (activeCard) activeCard.classList.add('active');

            // Apply to all products
            detectedProducts.forEach(product => {
              productRulesState[product] = { ...profile };
              delete productRulesState[product].name;
              delete productRulesState[product].icon;
              delete productRulesState[product].desc;
            });

            // Re-render product rules
            if (typeof renderProductRules === 'function') {
              renderProductRules(detectedProducts);
            }

            showToast(`Applied "${profile.name}" profile to all products`);
          }

          // --- Enhanced Success Modal with Time Calculation ---
          function enhanceSuccessModal(campaignCount, keywordCount, asinCount) {
            // Calculate time saved more accurately
            const minutesPerKeyword = 2;
            const minutesPerCampaign = 5;
            const totalMinutes = (keywordCount * minutesPerKeyword) + (campaignCount * minutesPerCampaign);
            const hours = Math.floor(totalMinutes / 60);
            const mins = totalMinutes % 60;

            let timeSavedText = '';
            if (hours > 0) {
              timeSavedText = `~${hours} hour${hours > 1 ? 's' : ''} ${mins > 0 ? mins + ' mins' : ''}`;
            } else {
              timeSavedText = `~${mins} minutes`;
            }

            const hoursSavedEl = document.getElementById('summHoursSaved');
            if (hoursSavedEl) {
              hoursSavedEl.textContent = timeSavedText;
            }

            // Launch confetti!
            launchConfetti();
          }

          // --- Collapsible Panel Toggle ---
          function toggleCollapsiblePanel(panelId) {
            const panel = document.getElementById(panelId);
            if (!panel) return;
            panel.classList.toggle('collapsed-section');
          }

          // --- Initialize Preset Profiles (called when sidebar loads) ---
          function initPresetProfiles() {
            const container = document.querySelector('.preset-profiles-container');
            if (!container) return;

            let html = '<div class="preset-profiles">';
            Object.keys(presetProfilesData).forEach(key => {
              const p = presetProfilesData[key];
              html += `
          <div class="preset-card" data-preset="${key}" onclick="applyPresetProfile('${key}')">
            <div class="preset-card-icon">${p.icon}</div>
            <div class="preset-card-name">${p.name}</div>
            <div class="preset-card-desc">${p.desc}</div>
          </div>
        `;
            });
            html += '</div>';
            container.innerHTML = html;
          }

          /* ========================================
             COMPLETE INTEGRATION HOOKS
             ======================================== */

          // 1. Hook skeleton loading to process button
          document.addEventListener('DOMContentLoaded', function () {
            const processBtn = document.getElementById('processBtn');
            if (processBtn) {
              // Store original click handler
              const originalClick = processBtn.onclick;

              processBtn.addEventListener('click', function (e) {
                // Show skeleton loading
                showLoadingSkeleton();

                // Hide welcome screen if visible
                const welcomeScreen = document.getElementById('welcomeScreen');
                if (welcomeScreen) welcomeScreen.style.display = 'none';
              });
            }

            // Initialize collapsible panels
            initCollapsiblePanels();

            // Initialize preset profiles
            initPresetProfiles();
          });

          // 2. Hook confetti to success modal - observe for modal display
          const successModalObserver = new MutationObserver(function (mutations) {
            mutations.forEach(function (mutation) {
              if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                const modal = document.getElementById('successModal');
                if (modal && modal.style.display === 'flex') {
                  // Success modal is now visible - launch confetti!
                  setTimeout(() => {
                    launchConfetti();

                    // Also update time saved calculation
                    const campaigns = parseInt(document.getElementById('summCampaigns')?.textContent || '0');
                    const keywords = parseInt(document.getElementById('summKeywords')?.textContent || '0');
                    enhanceSuccessModal(campaigns, keywords, 0);
                  }, 100);
                }
              }
            });
          });

          // Start observing success modal
          document.addEventListener('DOMContentLoaded', function () {
            const modal = document.getElementById('successModal');
            if (modal) {
              successModalObserver.observe(modal, { attributes: true, attributeFilter: ['style'] });
            }
          });

          // 3. Make sidebar panels collapsible with progressive disclosure
          function initCollapsiblePanels() {
            // Find all panels that should be collapsible
            const collapsiblePanels = [
              { id: 'productExtractionPanel', title: 'Product Name Extraction', collapsed: true },
              // Per-Product Rules stays open since it has the presets
            ];

            // Find Product Name Extraction panel by its title text
            const allPanels = document.querySelectorAll('.sidebar .panel');
            allPanels.forEach((panel, index) => {
              const titleEl = panel.querySelector('.panel-title');
              if (!titleEl) return;

              const titleText = titleEl.textContent.trim();

              // Make Product Name Extraction collapsible and collapsed by default
              if (titleText.includes('Product Name Extraction')) {
                makeCollapsible(panel, true); // true = start collapsed
              }
            });
          }

          function makeCollapsible(panel, startCollapsed) {
            if (!panel || panel.dataset.collapsible === 'true') return;
            panel.dataset.collapsible = 'true';

            // Get the title element
            const titleEl = panel.querySelector('.panel-title');
            if (!titleEl) return;

            // Find all content after the title
            const contentElements = [];
            let sibling = titleEl.nextElementSibling;
            while (sibling) {
              contentElements.push(sibling);
              sibling = sibling.nextElementSibling;
            }

            // Wrap content in a collapsible container
            const wrapper = document.createElement('div');
            wrapper.className = 'panel-collapse-content';
            contentElements.forEach(el => wrapper.appendChild(el));
            panel.appendChild(wrapper);

            // Add chevron to title
            const chevron = document.createElement('span');
            chevron.className = 'panel-chevron';
            chevron.innerHTML = '▼';
            titleEl.style.cursor = 'pointer';
            titleEl.style.display = 'flex';
            titleEl.style.justifyContent = 'space-between';
            titleEl.style.alignItems = 'center';
            titleEl.appendChild(chevron);

            // Add click handler
            titleEl.addEventListener('click', function () {
              panel.classList.toggle('collapsed-section');
            });

            // Apply collapsed class
            panel.classList.add('collapsible-section');
            if (startCollapsed) {
              panel.classList.add('collapsed-section');
            }
          }

          // 4. Add validation checkmarks to key inputs
          function addValidationCheckmarks() {
            // Date input validation
            const dateInput = document.getElementById('bulkStartDate');
            if (dateInput) {
              dateInput.addEventListener('change', function () {
                const wrapper = this.parentElement;
                let icon = wrapper.querySelector('.validation-icon');

                if (!icon) {
                  icon = document.createElement('span');
                  icon.className = 'validation-icon';
                  icon.style.position = 'absolute';
                  icon.style.right = '12px';
                  icon.style.top = '50%';
                  icon.style.transform = 'translateY(-50%)';
                  wrapper.style.position = 'relative';
                  wrapper.appendChild(icon);
                }

                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const selectedDate = new Date(this.value);

                if (this.value && selectedDate >= today) {
                  icon.className = 'validation-icon valid';
                  icon.innerHTML = '✓';
                  icon.style.background = 'var(--success)';
                  icon.style.color = 'white';
                  icon.style.borderRadius = '50%';
                  icon.style.width = '18px';
                  icon.style.height = '18px';
                  icon.style.display = 'flex';
                  icon.style.alignItems = 'center';
                  icon.style.justifyContent = 'center';
                  icon.style.fontSize = '12px';
                } else if (this.value) {
                  icon.className = 'validation-icon invalid';
                  icon.innerHTML = '✗';
                  icon.style.background = 'var(--error)';
                  icon.style.color = 'white';
                  icon.style.borderRadius = '50%';
                  icon.style.width = '18px';
                  icon.style.height = '18px';
                  icon.style.display = 'flex';
                  icon.style.alignItems = 'center';
                  icon.style.justifyContent = 'center';
                  icon.style.fontSize = '12px';
                } else {
                  icon.style.display = 'none';
                }
              });
            }

            // Add validation to other required inputs
            const bidInputs = document.querySelectorAll('input[type="number"][id*="Bid"]');
            bidInputs.forEach(input => {
              input.addEventListener('change', function () {
                const val = parseFloat(this.value);
                if (!isNaN(val) && val > 0) {
                  this.style.borderColor = 'var(--success)';
                  this.style.boxShadow = '0 0 0 2px var(--success-light)';
                } else if (this.value) {
                  this.style.borderColor = 'var(--error)';
                  this.style.boxShadow = '0 0 0 2px var(--error-light)';
                } else {
                  this.style.borderColor = '';
                  this.style.boxShadow = '';
                }
              });
            });
          }

          // Initialize validation checkmarks
          document.addEventListener('DOMContentLoaded', addValidationCheckmarks);

          // 5. Enhanced keyboard shortcuts
          document.addEventListener('keydown', function (e) {
            // Only if not typing in an input
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
              return;
            }

            // Cmd/Ctrl + Enter to run analysis
            if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
              e.preventDefault();
              const processBtn = document.getElementById('processBtn');
              if (processBtn && !processBtn.disabled) {
                processBtn.click();
              }
            }

            // E to expand all
            if (e.key === 'e' || e.key === 'E') {
              const expandBtn = document.getElementById('btnExpandAll');
              if (expandBtn) {
                e.preventDefault();
                expandBtn.click();
              }
            }

            // C to collapse all
            if (e.key === 'c' || e.key === 'C') {
              const collapseBtn = document.getElementById('btnCollapseAll');
              if (collapseBtn) {
                e.preventDefault();
                collapseBtn.click();
              }
            }

            // 1-4 to jump to steps (future enhancement)
          });

          /* ========================================
             PHASE 3: PREMIUM FEATURES
             ======================================== */

          // 6. Dark Mode Toggle
          function toggleDarkMode() {
            const body = document.body;
            const isDark = body.classList.toggle('dark-mode');

            // Update toggle button UI
            const icon = document.getElementById('darkModeIcon');
            const text = document.getElementById('darkModeText');

            if (isDark) {
              if (icon) icon.textContent = '☀️';
              if (text) text.textContent = 'Light';
            } else {
              if (icon) icon.textContent = '🌙';
              if (text) text.textContent = 'Dark';
            }

            // Save preference
            try {
              localStorage.setItem('termHarvester_darkMode', isDark ? 'true' : 'false');
            } catch (e) { }

            showToast(isDark ? 'Dark mode enabled' : 'Light mode enabled');
          }

          // Initialize dark mode from saved preference
          function initDarkMode() {
            try {
              const saved = localStorage.getItem('termHarvester_darkMode');
              if (saved === 'true') {
                document.body.classList.add('dark-mode');
                const icon = document.getElementById('darkModeIcon');
                const text = document.getElementById('darkModeText');
                if (icon) icon.textContent = '☀️';
                if (text) text.textContent = 'Light';
              }
            } catch (e) { }
          }

          // 7. Full Session Persistence
          const ENHANCED_SESSION_KEY = 'termHarvester_enhancedSession';

          function saveSessionState() {
            try {
              const session = {
                // Product rules
                productRules: productRulesState || {},

                // KPI selections
                kpiSelections: {},

                // Bulk export settings
                bulkSettings: {
                  startDate: document.getElementById('bulkStartDate')?.value || '',
                  state: document.getElementById('bulkState')?.value || 'Enabled',
                  includeSP: document.getElementById('toggleExportSP')?.checked ?? true,
                  includeSBV: document.getElementById('toggleExportSBV')?.checked ?? true,
                },

                // SP settings
                spSettings: {
                  bidModifier: document.getElementById('spBidModifier')?.value || '0',
                  broadBid: document.getElementById('spBroadBid')?.value || '',
                  phraseBid: document.getElementById('spPhraseBid')?.value || '',
                  exactBid: document.getElementById('spExactBid')?.value || '',
                  ptBid: document.getElementById('spPtBid')?.value || '',
                },

                // Detected products (names only)
                detectedProductNames: detectedProducts || [],

                // Timestamp
                savedAt: new Date().toISOString()
              };

              // Get KPI checkboxes
              document.querySelectorAll('.kpi-check').forEach(cb => {
                session.kpiSelections[cb.value] = cb.checked;
              });

              localStorage.setItem(ENHANCED_SESSION_KEY, JSON.stringify(session));

            } catch (e) {
              console.warn('Failed to save session:', e);
            }
          }

          function loadSessionState() {
            try {
              const saved = localStorage.getItem(ENHANCED_SESSION_KEY);
              if (!saved) return false;

              const session = JSON.parse(saved);

              // Check if session is too old (24 hours)
              const savedAt = new Date(session.savedAt);
              const hoursSince = (Date.now() - savedAt.getTime()) / (1000 * 60 * 60);
              if (hoursSince > 24) {
                localStorage.removeItem(ENHANCED_SESSION_KEY);
                return false;
              }

              // Restore product rules
              if (session.productRules && Object.keys(session.productRules).length > 0) {
                Object.assign(productRulesState, session.productRules);
              }

              // Restore KPI selections
              if (session.kpiSelections) {
                Object.entries(session.kpiSelections).forEach(([key, checked]) => {
                  const cb = document.querySelector(`.kpi-check[value="${key}"]`);
                  if (cb) cb.checked = checked;
                });
              }

              // Restore bulk settings
              if (session.bulkSettings) {
                const bs = session.bulkSettings;
                if (bs.startDate) {
                  const dateInput = document.getElementById('bulkStartDate');
                  if (dateInput) dateInput.value = bs.startDate;
                }
                const stateInput = document.getElementById('bulkState');
                if (stateInput && bs.state) stateInput.value = bs.state;

                const spToggle = document.getElementById('toggleExportSP');
                if (spToggle) spToggle.checked = bs.includeSP !== false;

                const sbvToggle = document.getElementById('toggleExportSBV');
                if (sbvToggle) sbvToggle.checked = bs.includeSBV !== false;
              }

              // Restore SP settings
              if (session.spSettings) {
                const sp = session.spSettings;
                const fields = [
                  ['spBidModifier', sp.bidModifier],
                  ['spBroadBid', sp.broadBid],
                  ['spPhraseBid', sp.phraseBid],
                  ['spExactBid', sp.exactBid],
                  ['spPtBid', sp.ptBid]
                ];
                fields.forEach(([id, val]) => {
                  const el = document.getElementById(id);
                  if (el && val) el.value = val;
                });
              }

              return true;
            } catch (e) {
              console.warn('Failed to load session:', e);
              return false;
            }
          }

          function clearSession() {
            try {
              localStorage.removeItem(ENHANCED_SESSION_KEY);
              showToast('Session cleared');
            } catch (e) { }
          }

          // Auto-save session periodically
          setInterval(saveSessionState, 30000); // Every 30 seconds

          // Save session before page unload
          window.addEventListener('beforeunload', saveSessionState);

          // 8. Simplified Option 1/2 Workflow - Default to Option 1
          function simplifyWorkflow() {
            // Default to Option 1 (Templates + Rules) which is simpler
            const opt1Btn = document.getElementById('modeOpt1Btn');
            const opt2Btn = document.getElementById('modeOpt2Btn');

            if (opt1Btn && opt2Btn) {
              // Make Option 1 the default active state
              opt1Btn.classList.add('active');
              opt1Btn.style.background = 'var(--primary)';
              opt1Btn.style.color = 'white';
              opt1Btn.style.borderColor = 'var(--primary)';

              // Rename buttons for clarity
              opt1Btn.innerHTML = '⚡ Quick Setup (Recommended)';
              opt2Btn.innerHTML = '🔧 Advanced: Per-Product';

              // Add helpful tooltip
              opt1Btn.title = 'Use template-based settings for all products - fastest setup';
              opt2Btn.title = 'Customize settings individually for each product - more control';
            }
          }

          // 9. Session Recovery Notification
          function checkForRecoverableSession() {
            try {
              const saved = localStorage.getItem(SESSION_KEY);
              if (!saved) return;

              const session = JSON.parse(saved);
              const savedAt = new Date(session.savedAt);
              const hoursSince = (Date.now() - savedAt.getTime()) / (1000 * 60 * 60);

              // Only show if session is recent (< 24 hours) and has product rules
              if (hoursSince < 24 && session.productRules && Object.keys(session.productRules).length > 0) {
                const productCount = Object.keys(session.productRules).length;

                // Create recovery banner
                const banner = document.createElement('div');
                banner.id = 'sessionRecoveryBanner';
                banner.style.cssText = `
                  position: fixed;
                  bottom: 80px;
                  left: 50%;
                  transform: translateX(-50%);
                  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
                  color: white;
                  padding: 12px 20px;
                  border-radius: 12px;
                  box-shadow: var(--shadow-xl);
                  z-index: 9999;
                  display: flex;
                  align-items: center;
                  gap: 12px;
                  font-size: 13px;
                  font-weight: 600;
                  animation: slideUp 0.3s ease-out;
                `;

                banner.innerHTML = `
                  <span>🔄 Previous session found (${productCount} products)</span>
                  <button onclick="restoreSession()" style="background:white; color:var(--primary); border:none; padding:6px 12px; border-radius:6px; font-weight:700; cursor:pointer;">Restore</button>
                  <button onclick="dismissRecoveryBanner()" style="background:transparent; color:white; border:1px solid rgba(255,255,255,0.5); padding:6px 12px; border-radius:6px; font-weight:600; cursor:pointer;">Dismiss</button>
                `;

                document.body.appendChild(banner);
              }
            } catch (e) { }
          }

          function restoreSession() {
            if (loadSessionState()) {
              showToast('Session restored successfully!');
              dismissRecoveryBanner();

              // Refresh product rules display if function exists
              if (typeof renderProductRules === 'function' && detectedProducts.length > 0) {
                renderProductRules(detectedProducts);
              }
            }
          }

          function dismissRecoveryBanner() {
            const banner = document.getElementById('sessionRecoveryBanner');
            if (banner) banner.remove();
          }

          // Initialize Phase 3 features on page load
          document.addEventListener('DOMContentLoaded', function () {
            // Initialize dark mode
            initDarkMode();

            // Simplify workflow
            simplifyWorkflow();

            // Check for recoverable session after a short delay
            setTimeout(checkForRecoverableSession, 1000);
          });

          // Add keyboard shortcut for dark mode toggle (D key)
          document.addEventListener('keydown', function (e) {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
              return;
            }

            if (e.key === 'd' || e.key === 'D') {
              e.preventDefault();
              toggleDarkMode();
            }
          });

        </script>
</body>

</html>
